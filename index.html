<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Spartiti Messa</title>
    
    <link rel="stylesheet" href="style.css">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="logo192.png">
    <meta name="theme-color" content="#673ab7">
    
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <script async defer src="https://apis.google.com/js/api.js"></script>
    <script async defer src="https://accounts.google.com/gsi/client"></script>
</head>
<body>

    <nav class="bottom-nav no-print">
        <button onclick="switchTab('library')" class="nav-btn active" id="btn-library">
            <span class="material-icons-round">library_music</span><span>Canti</span>
        </button>
        <button onclick="switchTab('scaletta')" class="nav-btn" id="btn-scaletta">
            <span class="material-icons-round">playlist_play</span><span>Messa</span>
        </button>
        <button onclick="switchTab('settings')" class="nav-btn" id="btn-settings">
            <span class="material-icons-round">settings</span><span>Opzioni</span>
        </button>
    </nav>

    <div class="container">
        
        <section id="library" class="view active">
            <header class="sticky-header no-print">
                <div id="installContainer" class="hidden" style="margin-bottom:10px;">
                    <button id="btnInstall" class="btn-block-primary install-btn">
                        <span class="material-icons-round">download</span> INSTALLA APP
                    </button>
                </div>
                <div id="iosInstallMessage" class="ios-prompt hidden">
                    <div class="ios-content">
                        <button onclick="closeIosPrompt()" style="float:right;border:none;background:none;"><span class="material-icons-round">close</span></button>
                        <p><strong>Installa su iPhone:</strong> Premi Condividi <span class="material-icons-round" style="font-size:16px">ios_share</span> > Aggiungi alla Home <span class="material-icons-round" style="font-size:16px">add_box</span></p>
                    </div>
                </div>

                <div class="search-bar-container">
                    <span class="material-icons-round search-icon">search</span>
                    <input type="text" id="searchInput" placeholder="Cerca titolo o testo..." onkeyup="applyFilters()">
                </div>
                
                <div class="filters-row">
                    <select id="filterSeason" onchange="applyFilters()" class="filter-dropdown">
                        <option value="Tutti">Tutti i Tempi</option>
                        <option value="Ordinario">Ordinario</option>
                        <option value="Avvento">Avvento</option>
                        <option value="Natale">Natale</option>
                        <option value="Quaresima">Quaresima</option>
                        <option value="Pasqua">Pasqua</option>
                    </select>
                </div>
                <div class="filter-chips-scroll" id="categoryChips"></div>
            </header>

            <div id="songList" class="song-list-container"></div>
            <button class="fab no-print" onclick="openAddMenu()"><span class="material-icons-round">add</span></button>
        </section>

        <div id="viewSongModal" class="modal hidden no-print">
            <div class="modal-card full-screen">
                <div class="modal-header">
                    <h3 id="viewSongTitle" style="margin:0; font-size:1.1rem; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">Titolo</h3>
                    <div style="display:flex; gap:10px;">
                        <button onclick="editCurrentSong()" class="btn-icon"><span class="material-icons-round">edit</span></button>
                        <button onclick="closeViewModal()" class="btn-icon"><span class="material-icons-round">close</span></button>
                    </div>
                </div>
                <div class="modal-body" id="viewSongBody"></div>
                <div id="transposerControls" class="modal-footer hidden transposer-bar">
                    <button onclick="transpose(-1)" class="btn-outline compact">b -1</button>
                    <span id="transposeValue" style="font-weight:bold; min-width:60px; text-align:center;">Originale</span>
                    <button onclick="transpose(1)" class="btn-outline compact"># +1</button>
                    <a id="viewYoutubeLink" href="#" target="_blank" class="btn-icon hidden" style="margin-left:auto; color:red; display:flex; align-items:center;">
                        <span class="material-icons-round" style="font-size:28px;">play_circle</span>
                    </a>
                </div>
            </div>
        </div>

        <div id="addMenu" class="modal hidden no-print">
            <div class="modal-card">
                <div class="modal-header">
                    <h3 id="modalTitle" style="margin:0;">Gestione Canto</h3>
                    <button onclick="closeAddMenu()" class="btn-icon"><span class="material-icons-round">close</span></button>
                </div>
                <div class="modal-body">
                    <input type="text" id="manualTitle" class="input-lg" placeholder="Titolo del Canto">
                    <div class="row-inputs">
                        <select id="newSongCategory" class="input-std"></select>
                        <select id="newSongSeason" class="input-std">
                            <option value="Ordinario">Ordinario</option>
                            <option value="Avvento">Avvento</option>
                            <option value="Natale">Natale</option>
                            <option value="Quaresima">Quaresima</option>
                            <option value="Pasqua">Pasqua</option>
                        </select>
                    </div>
                    <div class="input-icon-wrapper">
                        <span class="material-icons-round">link</span>
                        <input type="text" id="youtubeLink" class="input-std" placeholder="Link YouTube/Audio (Opzionale)">
                    </div>
                    <div class="tabs">
                        <button class="tab-btn active" onclick="switchInputTab('file')">File / Foto</button>
                        <button class="tab-btn" onclick="switchInputTab('text')">Testo e Accordi</button>
                    </div>
                    <div id="tab-file" class="tab-content">
                        <div class="file-upload-area">
                            <div id="previewContainer" class="preview-box hidden">
                                <img id="previewImg" src="">
                                <button class="remove-preview" onclick="clearFileSelection()">×</button>
                            </div>
                            <div id="driveStatus" class="status-msg hidden"></div>
                            <div class="upload-buttons">
                                <button onclick="initGoogleDriveImport()" class="btn-outline">
                                    <span class="material-icons-round">add_to_drive</span> Drive
                                </button>
                                <label class="btn-outline">
                                    <span class="material-icons-round">image</span> Galleria
                                    <input type="file" id="fileInput" accept="image/*,application/pdf" hidden onchange="handleLocalFile(this)">
                                </label>
                            </div>
                        </div>
                    </div>
                    <div id="tab-text" class="tab-content hidden">
                        <textarea id="textContent" class="lyrics-input" placeholder="Incolla qui testo e accordi..."></textarea>
                    </div>
                    <input type="hidden" id="editId">
                </div>
                <div class="modal-footer">
                    <button onclick="saveSongData()" class="btn-block-primary">SALVA</button>
                </div>
            </div>
        </div>

        <section id="scaletta" class="view hidden">
            <header class="sticky-header no-print">
                <div class="header-row">
                    <h1>Messa</h1>
                    <button onclick="toggleHistory()" class="btn-text-icon">
                        <span class="material-icons-round">history</span> Storico
                    </button>
                </div>
                <div class="print-options">
                    <label class="switch">
                        <input type="checkbox" id="printScoresCheck" onchange="toggleScoresMode()">
                        <span class="slider round"></span>
                    </label>
                    <span class="switch-label">Stampa Spartiti</span>
                </div>
            </header>
            <div id="printSheet" class="paper-sheet">
                <h2 contenteditable="true" id="messaTitle" class="messa-title">Santa Messa</h2>
                <p contenteditable="true" id="messaDate" class="messa-date">Data: ________________</p>
                <div class="scaletta-grid"></div>
                <div class="notes-area">
                    <span class="notes-label">Note:</span>
                    <div contenteditable="true" class="note-line"></div>
                </div>
            </div>
            <div id="scoresContainer" class="scores-print-area hidden"></div>
            <div class="fab-actions no-print">
                <button onclick="saveSetlist()" class="btn-action secondary"><span class="material-icons-round">save</span></button>
                <button onclick="prepareAndPrint()" class="btn-action primary"><span class="material-icons-round">print</span></button>
                <button onclick="resetScaletta()" class="btn-action danger"><span class="material-icons-round">restart_alt</span></button>
            </div>
            <div id="historyPanel" class="side-panel hidden no-print">
                <div class="panel-header"><h3>Storico</h3><button onclick="toggleHistory()" class="btn-icon"><span class="material-icons-round">close</span></button></div>
                <div id="historyList" class="history-list"></div>
            </div>
        </section>

        <section id="settings" class="view hidden">
            <header class="sticky-header"><h1>Opzioni</h1></header>
            <div class="settings-container">
                
                <div class="setting-card row-between">
                    <span><span class="material-icons-round v-mid">dark_mode</span> Tema Scuro</span>
                    <label class="switch">
                        <input type="checkbox" id="darkModeCheck" onchange="toggleDarkMode()">
                        <span class="slider round"></span>
                    </label>
                </div>

                <div class="setting-card" style="border: 2px solid var(--primary-light);">
                    <h3 style="color:var(--primary);"><span class="material-icons-round">cloud</span> Sincronizzazione</h3>
                    <p style="font-size:0.85rem; color:var(--text-sec); margin-top:5px;">Salva il tuo repertorio su Google Drive per usarlo su altri dispositivi.</p>
                    
                    <div id="syncStatus" class="status-msg hidden"></div>

                    <div class="row-inputs" style="margin-top:10px;">
                        <button onclick="syncToCloud()" class="btn-primary compact" style="flex:1;">
                            <span class="material-icons-round v-mid">cloud_upload</span> Carica su Cloud
                        </button>
                        <button onclick="syncFromCloud()" class="btn-outline compact" style="flex:1;">
                            <span class="material-icons-round v-mid">cloud_download</span> Scarica da Cloud
                        </button>
                    </div>
                    <p style="font-size:0.75rem; color:red; margin-top:5px;">* "Scarica" sovrascrive i dati locali.</p>
                </div>

                <div class="setting-card">
                    <h3><span class="material-icons-round">category</span> Categorie Extra</h3>
                    <div class="input-group-row">
                        <input type="text" id="newCatInput" class="input-std" placeholder="Es. Adorazione">
                        <button onclick="addCustomCategory()" class="btn-primary compact" style="width:auto; padding:0 15px;">Agg.</button>
                    </div>
                    <div id="customCatList" class="tags-container"></div>
                </div>

                <div class="setting-card">
                    <h3><span class="material-icons-round">key</span> Chiavi Google</h3>
                    <p style="font-size:0.85rem; color:#666; margin-top:0;">Necessarie per Drive e Sync.</p>
                    <input type="text" id="gApiKey" class="input-std" placeholder="API Key">
                    <input type="text" id="gClientId" class="input-std" placeholder="Client ID">
                    <button onclick="saveGoogleKeys()" class="btn-outline">Salva Configurazione</button>
                </div>

                <div class="setting-card">
                    <h3><span class="material-icons-round">save</span> Backup Locale</h3>
                    <div class="row-inputs">
                        <button onclick="exportData()" class="btn-outline">Scarica File</button>
                        <button onclick="document.getElementById('importJson').click()" class="btn-outline">Carica File</button>
                    </div>
                    <input type="file" id="importJson" hidden onchange="importData(this)">
                </div>
            </div>
        </section>
    </div>

    <script>
        // --- 1. CONFIGURAZIONE GLOBALE ---
        let db; let tempDriveFile = null; let activeInputMode = 'file'; let currentCategoryFilter = 'Tutti'; let currentViewingId = null;
        let customCategories = JSON.parse(localStorage.getItem('customCategories')) || [];
        const DEFAULT_PARTS = ['Ingresso', 'Gloria', 'Salmo', 'Alleluia', 'Offertorio', 'Santo', 'Comunione', 'Finale'];
        let ALL_CATEGORIES = [...new Set([...DEFAULT_PARTS, ...customCategories, 'Altro'])];
        
        // Nome del file di backup su Drive
        const SYNC_FILENAME = "spartiti_messa_db_sync.json";

        const request = indexedDB.open("SpartitiMessaPro", 5);
        request.onupgradeneeded = (e) => {
            db = e.target.result;
            if(!db.objectStoreNames.contains("songs")) { const s = db.createObjectStore("songs", { keyPath: "id", autoIncrement: true }); s.createIndex("category", "category", { unique: false }); }
            if(!db.objectStoreNames.contains("setlists")) db.createObjectStore("setlists", { keyPath: "id", autoIncrement: true });
        };
        request.onsuccess = (e) => { db = e.target.result; initApp(); };

        function initApp(){ loadDarkMode(); renderCategoryChips(); loadLibrary(); buildScalettaUI(); renderCustomCategoriesSettings(); updateCategoryDropdowns(); }

        // --- 2. GOOGLE AUTH & SYNC (IL CUORE DEL CAMBIAMENTO) ---
        let tokenClient;
        let gapiInited = false;
        let gisInited = false;

        // Inizializza le API di Google (richiamato dai pulsanti se serve)
        async function ensureGoogleReady() {
            const k = localStorage.getItem('g_api') || document.getElementById('gApiKey').value;
            const c = localStorage.getItem('g_client') || document.getElementById('gClientId').value;

            if(!k || !c) { alert("Mancano le chiavi API nelle Opzioni."); return false; }

            if(!gapiInited) {
                await new Promise((resolve) => {
                    gapi.load('client:picker', async () => {
                        await gapi.client.init({
                            apiKey: k,
                            discoveryDocs: ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"],
                        });
                        gapiInited = true;
                        resolve();
                    });
                });
            }

            if(!gisInited) {
                await new Promise((resolve) => {
                    // NOTA: SCOPE AGGIORNATO per permettere la scrittura (drive.file)
                    tokenClient = google.accounts.oauth2.initTokenClient({
                        client_id: c,
                        scope: 'https://www.googleapis.com/auth/drive.file',
                        callback: '', // Callback gestita dinamicamente
                    });
                    gisInited = true;
                    resolve();
                });
            }
            return true;
        }

        // --- FUNZIONE CARICA SU CLOUD (UPLOAD) ---
        async function syncToCloud() {
            const ready = await ensureGoogleReady();
            if(!ready) return;

            // Richiedi token per scrivere
            tokenClient.callback = async (resp) => {
                if (resp.error) return alert("Errore Auth: " + resp.error);
                await performUpload();
            };
            tokenClient.requestAccessToken({prompt: ''});
        }

        async function performUpload() {
            updateSyncStatus("Preparazione dati...", false);
            
            // 1. Estrai tutti i dati dal DB
            const dataToSync = { songs: [], setlists: [], customCategories: customCategories, timestamp: new Date().toISOString() };
            const tx = db.transaction(["songs", "setlists"], "readonly");
            
            // Usa Promise per aspettare i dati
            const songs = await new Promise(r => tx.objectStore("songs").getAll().onsuccess = e => r(e.target.result));
            const sets = await new Promise(r => tx.objectStore("setlists").getAll().onsuccess = e => r(e.target.result));
            
            dataToSync.songs = songs;
            dataToSync.setlists = sets;

            const fileContent = JSON.stringify(dataToSync);
            const fileMetadata = {
                'name': SYNC_FILENAME,
                'mimeType': 'application/json'
            };

            try {
                updateSyncStatus("Ricerca file esistente...", false);
                // 2. Cerca se il file esiste già su Drive
                const q = `name = '${SYNC_FILENAME}' and trashed = false`;
                const searchRes = await gapi.client.drive.files.list({ q: q, fields: 'files(id, name)' });
                
                const files = searchRes.result.files;
                
                if (files && files.length > 0) {
                    // AGGIORNA file esistente
                    const fileId = files[0].id;
                    updateSyncStatus("Aggiornamento Cloud...", false);
                    
                    // Per aggiornare il contenuto serve una chiamata specifica multipart (un po' complessa in JS puro)
                    // Usiamo un metodo semplificato: cancelliamo e ricreiamo (più sicuro per evitare conflict di versione semplice)
                    // O meglio: usiamo l'endpoint di upload.
                    
                    // Metodo semplice per app HTML: Aggiornamento tramite patch
                    const url = 'https://www.googleapis.com/upload/drive/v3/files/' + fileId + '?uploadType=media';
                    await fetch(url, {
                        method: 'PATCH',
                        headers: {
                            Authorization: 'Bearer ' + gapi.client.getToken().access_token,
                            'Content-Type': 'application/json'
                        },
                        body: fileContent
                    });
                    
                } else {
                    // CREA nuovo file
                    updateSyncStatus("Creazione file Cloud...", false);
                    const form = new FormData();
                    form.append('metadata', new Blob([JSON.stringify(fileMetadata)], { type: 'application/json' }));
                    form.append('file', new Blob([fileContent], { type: 'application/json' }));

                    await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                        method: 'POST',
                        headers: { Authorization: 'Bearer ' + gapi.client.getToken().access_token },
                        body: form
                    });
                }
                updateSyncStatus("Sincronizzazione completata! ✅", true);
            } catch (err) {
                console.error(err);
                updateSyncStatus("Errore Sync: " + err.message, true);
            }
        }

        // --- FUNZIONE SCARICA DA CLOUD (DOWNLOAD) ---
        async function syncFromCloud() {
            if(!confirm("ATTENZIONE: Questa operazione cancellerà i dati su QUESTO dispositivo e li sostituirà con quelli del Cloud. Continuare?")) return;

            const ready = await ensureGoogleReady();
            if(!ready) return;

            tokenClient.callback = async (resp) => {
                if (resp.error) return alert("Errore Auth");
                await performDownload();
            };
            tokenClient.requestAccessToken({prompt: ''});
        }

        async function performDownload() {
            try {
                updateSyncStatus("Ricerca backup...", false);
                const q = `name = '${SYNC_FILENAME}' and trashed = false`;
                const searchRes = await gapi.client.drive.files.list({ q: q, fields: 'files(id, name)' });
                const files = searchRes.result.files;

                if (!files || files.length === 0) {
                    return updateSyncStatus("Nessun backup trovato su Drive.", true);
                }

                const fileId = files[0].id;
                updateSyncStatus("Scaricamento dati...", false);

                const response = await gapi.client.drive.files.get({ fileId: fileId, alt: 'media' });
                const data = response.result; // GAPI parsa già il JSON se l'header è corretto, altrimenti JSON.parse(response.body)

                // Ripristino nel DB
                updateSyncStatus("Salvataggio locale...", false);
                const tx = db.transaction(["songs", "setlists"], "readwrite");
                
                // Pulisci tabelle attuali
                await new Promise(r => tx.objectStore("songs").clear().onsuccess = r);
                await new Promise(r => tx.objectStore("setlists").clear().onsuccess = r);

                // Inserisci nuovi dati
                if(data.songs) data.songs.forEach(s => tx.objectStore("songs").put(s));
                if(data.setlists) data.setlists.forEach(s => tx.objectStore("setlists").put(s));
                
                // Categorie custom
                if(data.customCategories) {
                    localStorage.setItem('customCategories', JSON.stringify(data.customCategories));
                    customCategories = data.customCategories;
                    ALL_CATEGORIES = [...new Set([...DEFAULT_PARTS, ...customCategories, 'Altro'])];
                    renderCategoryChips(); updateCategoryDropdowns(); renderCustomCategoriesSettings();
                }

                tx.oncomplete = () => {
                    updateSyncStatus("Ripristino completato! ✅", true);
                    loadLibrary();
                };

            } catch (err) {
                console.error(err);
                updateSyncStatus("Errore Download: " + err.message, true);
            }
        }

        function updateSyncStatus(msg, isFinal) {
            const el = document.getElementById('syncStatus');
            el.classList.remove('hidden');
            el.innerText = msg;
            if(isFinal) setTimeout(() => el.classList.add('hidden'), 5000);
        }

        // --- 3. SELETTORE FILE DRIVE (Funzione originale per importare spartiti) ---
        function initGoogleDriveImport() {
            // Usa la funzione generica per inizializzare
            ensureGoogleReady().then(ready => {
                if(ready) {
                    tokenClient.callback = (resp) => {
                        if (resp.error) return alert("Errore");
                        createPicker(resp.access_token);
                    };
                    tokenClient.requestAccessToken({prompt: ''});
                }
            });
        }

        function createPicker(token) {
            const k = localStorage.getItem('g_api') || document.getElementById('gApiKey').value;
            const view = new google.picker.DocsView(google.picker.ViewId.DOCS).setMode(google.picker.DocsViewMode.GRID).setMimeTypes("image/png,image/jpeg,application/pdf");
            const picker = new google.picker.PickerBuilder().setDeveloperKey(k).setOAuthToken(token).addView(view).setCallback(pickerCallback).build();
            picker.setVisible(true);
        }

        async function pickerCallback(data) {
            if (data.action === google.picker.Action.PICKED) {
                const doc = data.docs[0];
                let n = doc.name;
                if(n.includes('.')) n = n.substring(0, n.lastIndexOf('.'));
                document.getElementById('manualTitle').value = n;
                const st = document.getElementById('driveStatus');
                st.classList.remove('hidden'); st.innerText = "Caricamento...";
                
                if(doc.mimeType.startsWith('image')) {
                    try {
                        const r = await gapi.client.drive.files.get({fileId: doc.id, alt: 'media'});
                        const b = new Blob([r.body], {type: doc.mimeType});
                        showPreview(URL.createObjectURL(b));
                        const fr = new FileReader();
                        fr.onload = (e) => { tempDriveFile = {data: e.target.result, type: doc.mimeType}; st.innerText = "Immagine Pronta"; };
                        fr.readAsDataURL(b);
                    } catch(e) { tempDriveFile = {data: null, type: 'text'}; st.innerText = "Solo Link"; hidePreview(); }
                } else { tempDriveFile = {data: null, type: doc.mimeType}; st.innerText = "PDF Collegato"; hidePreview(); }
            }
        }

        // --- 4. FUNZIONI STANDARD (UI, Logic) ---
        function switchTab(id){ document.querySelectorAll('.view').forEach(v=>v.classList.add('hidden')); document.getElementById(id).classList.remove('hidden'); document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active')); document.getElementById('btn-'+id).classList.add('active'); if(id==='library') loadLibrary(); }
        function switchInputTab(mode){ activeInputMode = mode; document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active')); event.target.classList.add('active'); document.getElementById('tab-file').className = mode==='file'?'tab-content':'tab-content hidden'; document.getElementById('tab-text').className = mode==='text'?'tab-content':'tab-content hidden'; }
        function handleLocalFile(i){if(i.files[0]){const f=i.files[0];showPreview(URL.createObjectURL(f));const n=f.name;document.getElementById('manualTitle').value=n.substring(0,n.lastIndexOf('.'))||n;tempDriveFile=null;document.getElementById('driveStatus').classList.add('hidden');}}
        function showPreview(u){document.getElementById('previewImg').src=u;document.getElementById('previewContainer').classList.remove('hidden');}
        function clearFileSelection(){document.getElementById('previewContainer').classList.add('hidden');document.getElementById('fileInput').value="";tempDriveFile=null;document.getElementById('driveStatus').classList.add('hidden');}
        function saveGoogleKeys(){ localStorage.setItem('g_api', document.getElementById('gApiKey').value); localStorage.setItem('g_client', document.getElementById('gClientId').value); alert("Chiavi Salvate!"); }

        function openAddMenu(editId = null) { 
            document.getElementById('addMenu').classList.remove('hidden'); 
            document.getElementById('editId').value = editId || ""; 
            document.getElementById('modalTitle').innerText = editId ? "Modifica Canto" : "Nuovo Canto";
            if(editId){
                db.transaction(["songs"]).objectStore("songs").get(editId).onsuccess = (e) => { 
                    const s = e.target.result;
                    document.getElementById('manualTitle').value = s.title; 
                    document.getElementById('newSongCategory').value = s.category; 
                    document.getElementById('newSongSeason').value = s.season || "Ordinario";
                    document.getElementById('youtubeLink').value = s.youtubeUrl || "";
                    if(s.lyrics){ switchInputTab('text'); document.getElementById('textContent').value = s.lyrics; } 
                    else { switchInputTab('file'); if(s.fileData && s.type.startsWith('image')) showPreview(s.fileData); }
                };
            } else { document.getElementById('manualTitle').value = ""; document.getElementById('textContent').value = ""; document.getElementById('youtubeLink').value = ""; clearFileSelection(); switchInputTab('file'); }
        }
        function closeAddMenu(){ document.getElementById('addMenu').classList.add('hidden'); }

        function saveSongData() {
            const id = document.getElementById('editId').value; const title = document.getElementById('manualTitle').value; const cat = document.getElementById('newSongCategory').value; const season = document.getElementById('newSongSeason').value; const yt = document.getElementById('youtubeLink').value; const lyrics = document.getElementById('textContent').value; const inp = document.getElementById('fileInput');
            if(!title) return alert("Inserisci titolo!");
            const persist = (d, tp) => {
                const s = { title, category: cat, season, youtubeUrl: yt, date: new Date(), lyrics: (activeInputMode === 'text') ? lyrics : null, fileData: (activeInputMode === 'file') ? d : null, type: (activeInputMode === 'file') ? tp : 'text/plain' };
                if(id) s.id = Number(id);
                db.transaction(["songs"],"readwrite").objectStore("songs").put(s).oncomplete = () => { closeAddMenu(); loadLibrary(); };
            };
            if(activeInputMode === 'file') {
                if(tempDriveFile) persist(tempDriveFile.data, tempDriveFile.type);
                else if(inp.files.length > 0) { const r = new FileReader(); r.onload = (e) => persist(e.target.result, inp.files[0].type); r.readAsDataURL(inp.files[0]); }
                else if(id) { db.transaction(["songs"]).objectStore("songs").get(Number(id)).onsuccess = (e) => { const old = e.target.result; if(old.fileData) persist(old.fileData, old.type); else persist(null, 'text/plain'); }}
                else persist(null, 'text/plain');
            } else persist(null, 'text/plain');
        }

        function filterCategory(c) { currentCategoryFilter = c; document.querySelectorAll('.chip').forEach(el => el.classList.remove('active')); const chip = document.querySelector(`.chip[data-cat="${c}"]`); if(chip) chip.classList.add('active'); applyFilters(); }
        function applyFilters() {
            const seas = document.getElementById('filterSeason').value; const search = document.getElementById('searchInput').value.toLowerCase(); const list = document.getElementById('songList'); list.innerHTML = "";
            db.transaction(["songs"],"readonly").objectStore("songs").openCursor().onsuccess = (e) => {
                const c = e.target.result;
                if(c) { const s = c.value;
                    if((currentCategoryFilter === 'Tutti' || s.category === currentCategoryFilter) && (seas === 'Tutti' || s.season === seas) && s.title.toLowerCase().includes(search)) {
                        const d = document.createElement('div'); d.className = 'song-card';
                        const ico = s.lyrics ? 'text_fields' : (s.fileData ? 'image' : 'link');
                        d.innerHTML = `<div class="card-left" onclick="openViewModal(${s.id})"><div class="card-icon"><span class="material-icons-round">${ico}</span></div><div><div class="card-title">${s.title}</div><div class="card-meta">${s.category} • ${s.season || 'Ord.'}</div></div></div><button onclick="deleteSong(${s.id})" class="btn-icon-del"><span class="material-icons-round">delete</span></button>`;
                        list.appendChild(d);
                    } c.continue();
                }
            };
        }
        function loadLibrary() { applyFilters(); populateAllSelectors(); }
        function deleteSong(id) { if(confirm("Eliminare?")) { db.transaction(["songs"],"readwrite").objectStore("songs").delete(id); loadLibrary(); } }

        function openViewModal(id) {
            currentViewingId = id; document.getElementById('transposeValue').innerText = "Originale";
            db.transaction(["songs"]).objectStore("songs").get(id).onsuccess = (e) => {
                const s = e.target.result; if(!s) return;
                document.getElementById('viewSongTitle').innerText = s.title; const body = document.getElementById('viewSongBody'); const controls = document.getElementById('transposerControls'); const ytBtn = document.getElementById('viewYoutubeLink');
                if(s.youtubeUrl) { ytBtn.href = s.youtubeUrl; ytBtn.classList.remove('hidden'); } else ytBtn.classList.add('hidden');
                if(s.lyrics) { currentSongText = s.lyrics; body.innerHTML = `<div class="lyrics-box"><pre>${s.lyrics}</pre></div>`; controls.classList.remove('hidden'); }
                else if (s.fileData) { body.innerHTML = `<img src="${s.fileData}" style="max-width:100%; height:auto;">`; controls.classList.add('hidden'); }
                else { body.innerHTML = "<p>Nessun contenuto.</p>"; controls.classList.add('hidden'); }
                document.getElementById('viewSongModal').classList.remove('hidden');
            };
        }
        function closeViewModal(){ document.getElementById('viewSongModal').classList.add('hidden'); }
        function editCurrentSong(){ closeViewModal(); openAddMenu(currentViewingId); }

        let currentSongText = ""; let currentTransposeLevel = 0;
        const CHORDS = ["Do", "Do#", "Re", "Re#", "Mi", "Fa", "Fa#", "Sol", "Sol#", "La", "La#", "Si"];
        const CHORDS_FLAT = ["Do", "Reb", "Re", "Mib", "Mi", "Fa", "Solb", "Sol", "Lab", "La", "Sib", "Si"];
        function transpose(semitones) {
            currentTransposeLevel += semitones; document.getElementById('transposeValue').innerText = (currentTransposeLevel > 0 ? "+" : "") + currentTransposeLevel;
            document.getElementById('viewSongBody').innerHTML = `<div class="lyrics-box"><pre>${processTextTranspose(currentSongText, currentTransposeLevel)}</pre></div>`;
        }
        function processTextTranspose(text, shift) {
            if(shift === 0) return text;
            return text.replace(/\b(Do|Re|Mi|Fa|Sol|La|Si)(#|b)?(m|7|dim|aug|sus|2|4|5|6|9|maj7)?\b/g, (match, note, acc, suffix) => {
                let idx = CHORDS.indexOf(note + (acc || "")); if(idx === -1) idx = CHORDS_FLAT.indexOf(note + (acc || "")); if(idx === -1) return match;
                let newIdx = (idx + shift) % 12; if(newIdx < 0) newIdx += 12;
                return CHORDS[newIdx] + (suffix || "");
            });
        }

        function buildScalettaUI() { const g = document.querySelector('.scaletta-grid'); if(g.children.length === 0) DEFAULT_PARTS.forEach(p => { const d = document.createElement('div'); d.className = 'slot-container'; d.dataset.part = p; d.innerHTML = `<div class="slot-header"><span>${p}</span><button class="btn-add-slot no-print" onclick="addSelector('${p}')">+</button></div><div class="selectors-list" id="list-${p}"></div>`; g.appendChild(d); addSelector(p); }); }
        function addSelector(p, id=null){ const c = document.getElementById(`list-${p}`); const r = document.createElement('div'); r.className = 'selector-row'; r.innerHTML = `<select class="song-selector no-print" onchange="updatePrintText(this)"><option value="">Seleziona...</option></select><span class="print-text"></span><button class="btn-del-slot no-print" onclick="removeSelector(this)">×</button>`; c.appendChild(r); populateSingleSelect(r.querySelector('select'), id); }
        function removeSelector(b){ const r = b.parentElement; if(r.parentElement.children.length > 1) r.remove(); else { const s = r.querySelector('select'); s.value = ""; updatePrintText(s); } if(document.getElementById('printScoresCheck').checked) renderScores(); }
        function populateSingleSelect(s, id){ const cur = id || s.value; s.innerHTML = '<option value="">Seleziona...</option>'; db.transaction(["songs"],"readonly").objectStore("songs").openCursor().onsuccess = (e) => { const c = e.target.result; if(c) { const o = document.createElement('option'); o.value = c.key; o.text = c.value.title; if(c.key == cur) { o.selected = true; updatePrintText(s); } s.appendChild(o); c.continue(); } } }
        function populateAllSelectors(){ document.querySelectorAll('.song-selector').forEach(s => populateSingleSelect(s)); }
        function updatePrintText(s){ s.nextElementSibling.innerText = s.value ? s.options[s.selectedIndex].text : ""; if(document.getElementById('printScoresCheck').checked) renderScores(); }
        function toggleScoresMode(){ const c = document.getElementById('scoresContainer'); if(document.getElementById('printScoresCheck').checked) { c.classList.remove('hidden'); renderScores(); } else { c.classList.add('hidden'); } }
        function renderScores(){ const c = document.getElementById('scoresContainer'); c.innerHTML = ""; document.querySelectorAll('.song-selector').forEach(sel => { if(!sel.value) return; const part = sel.closest('.slot-container').dataset.part; db.transaction(["songs"],"readonly").objectStore("songs").get(Number(sel.value)).onsuccess = (e) => { const s = e.target.result; if(!s) return; const p = document.createElement('div'); p.className = 'score-page'; let cnt = ""; if(s.lyrics) cnt = `<div class="lyrics-box"><pre>${s.lyrics}</pre></div>`; else if(s.fileData) cnt = `<img src="${s.fileData}">`; else cnt = `<p class="no-print">Nessun contenuto.</p>`; p.innerHTML = `<h3>${part}: ${s.title}</h3>${cnt}`; c.appendChild(p); } }); }
        function prepareAndPrint(){ if(document.getElementById('printScoresCheck').checked) { renderScores(); setTimeout(()=>window.print(), 500); } else window.print(); }
        function saveSetlist(){ const t = document.getElementById('messaTitle').innerText; const d = document.getElementById('messaDate').innerText; const sel = {}; document.querySelectorAll('.slot-container').forEach(sl => { const p = sl.dataset.part; const ids = []; sl.querySelectorAll('select').forEach(s => { if(s.value) ids.push(s.value) }); sel[p] = ids; }); db.transaction(["setlists"],"readwrite").objectStore("setlists").add({title:t, dateStr:d, selections:sel}).oncomplete = () => alert("Salvata!"); }
        function toggleHistory(){ const p = document.getElementById('historyPanel'); const l = document.getElementById('historyList'); if(p.classList.contains('hidden')){ p.classList.remove('hidden'); l.innerHTML = ""; const tx = db.transaction(["setlists"],"readonly").objectStore("setlists"); tx.openCursor(null,'prev').onsuccess = (e) => { const c = e.target.result; if(c) { const x = c.value; const d = document.createElement('div'); d.className = 'history-item'; d.innerHTML = `<div><strong>${x.title}</strong><br><small>${x.dateStr}</small></div><div><button onclick="loadSetlist(${x.id})">Carica</button> <button onclick="deleteSetlist(${x.id})" style="color:red">×</button></div>`; l.appendChild(d); c.continue(); } }; } else p.classList.add('hidden'); }
        function loadSetlist(id){ db.transaction(["setlists"]).objectStore("setlists").get(id).onsuccess = (e) => { const r = e.target.result; document.getElementById('messaTitle').innerText = r.title; document.getElementById('messaDate').innerText = r.dateStr; document.querySelectorAll('.selectors-list').forEach(l => l.innerHTML = ""); for(const[p,ids] of Object.entries(r.selections)){ if(!ids.length) addSelector(p); else ids.forEach(i => addSelector(p,i)); } toggleHistory(); } }
        function deleteSetlist(id){ if(confirm("Eliminare?")) { db.transaction(["setlists"],"readwrite").objectStore("setlists").delete(id); toggleHistory(); setTimeout(toggleHistory,50); } }
        function resetScaletta(){ document.querySelectorAll('.selectors-list').forEach(l => { l.innerHTML = ""; addSelector(l.parentElement.dataset.part) }); document.getElementById('messaTitle').innerText = "Santa Messa"; }
        
        function toggleDarkMode(){ const isDark = document.getElementById('darkModeCheck').checked; document.body.classList.toggle('dark-mode', isDark); localStorage.setItem('darkMode', isDark); }
        function loadDarkMode(){ const isDark = localStorage.getItem('darkMode') === 'true'; document.body.classList.toggle('dark-mode', isDark); if(document.getElementById('darkModeCheck')) document.getElementById('darkModeCheck').checked = isDark; }
        
        function exportData(){ const exp = {songs:[], setlists:[]}; const tx = db.transaction(["songs","setlists"],"readonly"); tx.objectStore("songs").getAll().onsuccess = e => { exp.songs = e.target.result; tx.objectStore("setlists").getAll().onsuccess = e2 => { exp.setlists = e2.target.result; const a = document.createElement("a"); a.href = URL.createObjectURL(new Blob([JSON.stringify(exp)],{type:'application/json'})); a.download = "backup_spartiti.json"; a.click(); } }; }
        function importData(i){ const f = i.files[0]; if(!f) return; const r = new FileReader(); r.onload = e => { const d = JSON.parse(e.target.result); const tx = db.transaction(["songs","setlists"],"readwrite"); if(d.songs) d.songs.forEach(s => tx.objectStore("songs").put(s)); if(d.setlists) d.setlists.forEach(s => tx.objectStore("setlists").put(s)); tx.oncomplete = () => { alert("Ripristinato!"); loadLibrary(); }; }; r.readAsText(f); }

        function renderCategoryChips(){ const c = document.getElementById('categoryChips'); c.innerHTML = `<button onclick="filterCategory('Tutti')" class="chip active" data-cat="Tutti">Tutti</button>`; ALL_CATEGORIES.forEach(cat => { c.innerHTML += `<button onclick="filterCategory('${cat}')" class="chip" data-cat="${cat}">${cat}</button>`; }); }
        function updateCategoryDropdowns(){ const html = ALL_CATEGORIES.map(c => `<option value="${c}">${c}</option>`).join(''); const sel = document.getElementById('newSongCategory'); if(sel) sel.innerHTML = html; }
        function addCustomCategory(){ const val = document.getElementById('newCatInput').value.trim(); if(val && !ALL_CATEGORIES.includes(val)){ customCategories.push(val); localStorage.setItem('customCategories', JSON.stringify(customCategories)); ALL_CATEGORIES = [...new Set([...DEFAULT_PARTS, ...customCategories, 'Altro'])]; renderCategoryChips(); updateCategoryDropdowns(); renderCustomCategoriesSettings(); document.getElementById('newCatInput').value = ""; } }
        function renderCustomCategoriesSettings(){ const div = document.getElementById('customCatList'); div.innerHTML = customCategories.map(c => `<span class="tag">${c} <span onclick="removeCustomCategory('${c}')" style="cursor:pointer;margin-left:5px;">&times;</span></span>`).join(''); }
        function removeCustomCategory(c){ customCategories = customCategories.filter(x => x !== c); localStorage.setItem('customCategories', JSON.stringify(customCategories)); ALL_CATEGORIES = [...new Set([...DEFAULT_PARTS, ...customCategories, 'Altro'])]; renderCategoryChips(); updateCategoryDropdowns(); renderCustomCategoriesSettings(); }

        // --- 13. INSTALL SW ---
        if('serviceWorker' in navigator) navigator.serviceWorker.register('./sw.js');
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => { e.preventDefault(); deferredPrompt = e; document.getElementById('installContainer').classList.remove('hidden'); });
        document.getElementById('btnInstall')?.addEventListener('click', async () => { if(deferredPrompt){ deferredPrompt.prompt(); const {outcome} = await deferredPrompt.userChoice; if(outcome === 'accepted') document.getElementById('installContainer').classList.add('hidden'); deferredPrompt = null; } });
        const isIos = () => /iphone|ipad|ipod/.test(window.navigator.userAgent.toLowerCase());
        const isInStandaloneMode = () => ('standalone' in window.navigator) || (window.matchMedia('(display-mode: standalone)').matches);
        window.addEventListener('load', () => { if(!isInStandaloneMode() && isIos()) document.getElementById('iosInstallMessage').classList.remove('hidden'); });
        function closeIosPrompt(){ document.getElementById('iosInstallMessage').classList.add('hidden'); }
    </script>
</body>
</html>
