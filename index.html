<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Spartiti Messa Pro</title>
    
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="logo192.png">
    <meta name="theme-color" content="#673ab7">
    
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <!-- CRITICAL FIX: Caricamento sincrono delle API Google per evitare problemi di popup -->
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client"></script>
    
    <style>
        /* --- CORE CSS --- */
        :root { --primary: #673ab7; --bg: #f5f5f5; --white: #ffffff; --text: #333; --border: #ddd; }
        * { box-sizing: border-box; }
        body { font-family: 'Roboto', sans-serif; background: var(--bg); color: var(--text); margin: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        .app-body { flex: 1; overflow-y: auto; position: relative; padding-bottom: 70px; }
        .view-section { display: none; padding: 15px; max-width: 1200px; margin: 0 auto; }
        .view-section.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* HEADER */
        .top-bar { background: var(--white); padding: 10px 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; z-index: 100; height: 60px; }
        
        /* SIDEBAR (Mobile) */
        .hamburger-icon { display: none; font-size: 28px; cursor: pointer; color: var(--primary); margin-right: 15px; }
        .sidebar-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 2000; display: none; opacity: 0; transition: 0.3s; }
        .sidebar-overlay.active { display: block; opacity: 1; }
        .sidebar { position: fixed; top: 0; left: 0; width: 280px; height: 100%; background: white; z-index: 2001; transform: translateX(-100%); transition: 0.3s; display: flex; flex-direction: column; box-shadow: 2px 0 10px rgba(0,0,0,0.2); }
        .sidebar.active { transform: translateX(0); }
        .sidebar-header { background: var(--primary); color: white; padding: 20px; height: 120px; display: flex; align-items: flex-end; font-weight: bold; font-size: 1.2rem; }
        .sidebar-menu { flex: 1; padding: 10px 0; overflow-y: auto; }
        .menu-item { padding: 15px 20px; border-bottom: 1px solid #eee; display: flex; align-items: center; gap: 15px; cursor: pointer; color: #444; }
        .menu-item:active { background: #f0f0f0; }

        /* CARDS & UI */
        .card { background: var(--white); border-radius: 10px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 15px; border: 1px solid var(--border); overflow: hidden; }
        .card-header { background: #f9fafb; padding: 10px 15px; border-bottom: 1px solid var(--border); font-weight: bold; display: flex; justify-content: space-between; align-items: center; }
        .card-body { padding: 15px; }

        .song-item, .history-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 15px; border-bottom: 1px solid #eee; cursor: pointer; transition: background 0.2s; background: white; }
        .song-item:active { background: #f0f0f0; }

        .status-badge { font-size: 0.75rem; padding: 2px 6px; border-radius: 4px; display: inline-flex; align-items: center; gap: 4px; margin-right: 5px; }
        .status-offline { background: #e8f5e9; color: #2e7d32; border: 1px solid #c8e6c9; }
        .status-online { background: #e3f2fd; color: #1976d2; border: 1px solid #bbdefb; }

        .chips-container { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 15px; }
        .chip-select { padding: 6px 12px; border-radius: 20px; border: 1px solid #ccc; background: white; color: #555; font-size: 0.85rem; cursor: pointer; user-select: none; }
        .chip-select.selected { background: var(--primary); color: white; border-color: var(--primary); font-weight: bold; box-shadow: 0 2px 5px rgba(103, 58, 183, 0.3); }

        .form-control { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; font-size: 1rem; margin-bottom: 10px; font-family: inherit; }
        textarea.form-control { resize: vertical; min-height: 100px; }

        /* NAV BAR (Desktop) */
        .nav-bar { position: fixed; bottom: 0; left: 0; width: 100%; height: 65px; background: var(--white); border-top: 1px solid var(--border); display: flex; justify-content: space-around; align-items: center; z-index: 500; }
        .nav-btn { background: none; border: none; color: #999; font-size: 0.7rem; font-weight: 500; display: flex; flex-direction: column; align-items: center; width: 100%; cursor: pointer; }
        .nav-btn.active { color: var(--primary); }
        .nav-btn span { font-size: 26px; margin-bottom: 2px; }

        .btn { padding: 8px 16px; border-radius: 6px; border: none; cursor: pointer; font-weight: 600; display: inline-flex; align-items: center; gap: 5px; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-outline { background: transparent; border: 1px solid #ccc; color: #555; }
        .btn-icon { background: none; border: none; font-size: 1.4rem; padding: 5px; cursor: pointer; color: #555; }

        .workspace { display: grid; gap: 20px; grid-template-columns: 1fr; }
        @media(min-width: 900px) { .workspace { grid-template-columns: 1fr 1fr; } }

        /* MEDIA QUERIES (Mobile Transform) */
        @media (max-width: 899px) {
            .nav-bar { display: none !important; }
            .hamburger-icon { display: block !important; }
            .app-body { padding-bottom: 20px; }
            .modal-box { width: 100% !important; height: 100% !important; max-width: 100% !important; border-radius: 0 !important; }
        }
        @media (min-width: 900px) {
            .hamburger-icon { display: none !important; }
            .sidebar { display: none !important; }
        }

        /* MODALI */
        .modal-wrap { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 3000; display: none; align-items: center; justify-content: center; }
        .modal-wrap.show { display: flex; }
        .modal-box { background: var(--white); width: 95%; max-width: 800px; max-height: 90vh; border-radius: 12px; display: flex; flex-direction: column; box-shadow: 0 20px 25px rgba(0,0,0,0.2); }
        .modal-header { padding: 15px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; font-weight: bold; }
        .modal-scroll { flex: 1; overflow-y: auto; padding: 20px; }
        .modal-footer { padding: 15px; border-top: 1px solid var(--border); background: #fff; }

        /* READING MODE */
        #readingContainer { position: fixed; inset: 0; background: var(--white); z-index: 4000; display: none; flex-direction: column; }
        #readingContainer.active { display: flex; }
        .reading-nav { height: 60px; padding: 0 15px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid var(--border); background: #fff; }
        .reading-content { flex: 1; overflow-y: auto; padding: 20px; background: #f9f9f9; }
        .score-seq-item { margin-bottom: 40px; background: white; padding: 10px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); page-break-inside: avoid; }
        .pdf-frame { width: 100%; height: 80vh; border: none; background: #eee; }

        /* TOAST & UTILS */
        #toast { position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%); background: #333; color: white; padding: 12px 24px; border-radius: 50px; z-index: 6000; opacity: 0; pointer-events: none; transition: 0.3s; }
        #toast.show { opacity: 1; bottom: 90px; }
        #toast.error { background: #ef4444; }
        .d-none { display: none !important; }
        .no-print { display: block; }
        
        /* PRINT STYLES */
        @media print {
            body { overflow: visible !important; }
            .no-print { display: none !important; }
            .reading-content { padding: 0; background: white; }
            .score-seq-item { page-break-inside: avoid; margin-bottom: 20px; box-shadow: none; }
            #readingContainer { position: static; display: block !important; }
        }
        @media print { .print-music-only #readMusicArea { display: none !important; } }
        @media print { .print-text-only #readWordArea { display: none !important; } }
    </style>
</head>
<body>
    <div class="sidebar-overlay" onclick="toggleSidebar()"></div>
    <div class="sidebar">
        <div class="sidebar-header">üéµ Menu</div>
        <div class="sidebar-menu">
            <div class="menu-item" onclick="go('library', this); toggleSidebar();"><span class="material-icons-round">library_music</span>Canti</div>
            <div class="menu-item" onclick="go('scaletta', this); toggleSidebar();"><span class="material-icons-round">playlist_play</span>Messa</div>
            <div class="menu-item" onclick="go('history', this); toggleSidebar();"><span class="material-icons-round">history</span>Messe</div>
            <div class="menu-item" onclick="go('settings', this); toggleSidebar();"><span class="material-icons-round">settings</span>Opzioni</div>
        </div>
    </div>

    <div class="top-bar no-print">
        <span class="hamburger-icon material-icons-round" onclick="toggleSidebar()">menu</span>
        <h1 style="margin:0; font-size:1.2rem; color:var(--primary);">üéµ Spartiti Messa</h1>
        <div style="width:30px;"></div>
    </div>

    <div class="app-body">
        <div id="view-library" class="view-section active">
            <div style="display:flex; gap:10px; margin-bottom:15px; flex-wrap:wrap;">
                ${['Tutti', ...Array.from(new Set(['Ingresso', 'Gloria', 'Salmo', 'Alleluia', 'Offertorio', 'Santo', 'Comunione', 'Finale', 'Altro']))].map(c => 
                    `<button class="btn-outline" onclick="filterLib('${c}')" style="${c==='Tutti'?'background:var(--primary);color:white;':''}">${c}</button>`
                ).join('')}
            </div>
            <input type="text" id="searchInput" class="form-control" placeholder="üîç Cerca..." oninput="renderLibrary()">
            <div id="songList" class="card" style="border:none; background:transparent; box-shadow:none;"></div>
            <button onclick="openEditModal()" class="btn-primary" style="width:100%; margin-top:10px;">+ NUOVO CANTO</button>
        </div>

        <div id="view-scaletta" class="view-section">
            <div class="card">
                <div class="card-header">Info Messa</div>
                <div class="card-body">
                    <input type="text" id="messaTitle" class="form-control" placeholder="Titolo (es. Domenica delle Palme)">
                    <input type="date" id="messaDate" class="form-control" onchange="updateSuggestions()">
                </div>
            </div>
            <div class="workspace">
                <div class="card">
                    <div class="card-header">Canti</div>
                    <div class="card-body" id="scalettaContainer"></div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <span>Letture</span>
                        <button onclick="autoFetchReadings()" class="btn-outline" style="font-size:0.75rem;">üìñ Scarica</button>
                    </div>
                    <div class="card-body">
                        <textarea id="reading1" class="form-control" placeholder="Prima Lettura"></textarea>
                        <textarea id="psalm" class="form-control" placeholder="Salmo"></textarea>
                        <textarea id="reading2" class="form-control" placeholder="Seconda Lettura"></textarea>
                        <textarea id="gospel" class="form-control" placeholder="Vangelo"></textarea>
                    </div>
                </div>
            </div>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:15px;">
                <button onclick="saveSetlist()" class="btn-primary">üíæ SALVA</button>
                <button onclick="document.getElementById('shareModal').classList.add('show')" class="btn-outline">üì§ CONDIVIDI</button>
            </div>
        </div>

        <div id="view-history" class="view-section">
            <h2 style="color:var(--primary); margin-top:0;">Le mie Messe</h2>
            <div id="fullHistoryList" class="card" style="border:none; background:transparent; box-shadow:none;"></div>
        </div>

        <div id="view-settings" class="view-section">
            <div class="card">
                <div class="card-header">Google Drive API</div>
                <div class="card-body">
                    <input type="text" id="apiKey" class="form-control" placeholder="API Key">
                    <input type="text" id="clientId" class="form-control" placeholder="Client ID">
                    <button onclick="saveKeys()" class="btn-primary">Salva Chiavi</button>
                </div>
            </div>
            <div class="card">
                <div class="card-header">Sincronizzazione Cloud</div>
                <div class="card-body" style="text-align:center;">
                    <div style="display:flex; gap:10px; justify-content:center;">
                        <button onclick="driveAction('upload')" class="btn-primary">‚òÅÔ∏è Carica (Backup)</button>
                        <button onclick="driveAction('download')" class="btn-outline">‚¨áÔ∏è Ripristina</button>
                    </div>
                </div>
            </div>
            <div class="card">
                <div class="card-header">Backup Locale</div>
                <div class="card-body" style="display:flex; gap:10px;">
                    <button onclick="exportData()" class="btn-outline" style="flex:1;">Scarica</button>
                    <button onclick="document.getElementById('impFile').click()" class="btn-outline" style="flex:1;">Carica</button>
                    <input type="file" id="impFile" hidden onchange="importData(this)">
                </div>
            </div>
        </div>
    </div>

    <div class="nav-bar no-print">
        <button class="nav-btn active" onclick="go('library', this)"><span class="material-icons-round">library_music</span>Canti</button>
        <button class="nav-btn" onclick="go('scaletta', this)"><span class="material-icons-round">playlist_play</span>Messa</button>
        <button class="nav-btn" onclick="go('history', this)"><span class="material-icons-round">history</span>Messe</button>
        <button class="nav-btn" onclick="go('settings', this)"><span class="material-icons-round">settings</span>Opzioni</button>
    </div>

    <div id="viewModal" class="modal-wrap">
        <div class="modal-box" style="height:95vh;">
            <div class="card-header">
                <span id="viewTitle">Titolo</span>
                <div>
                    <button onclick="deleteCurrentSong()" class="btn-icon" style="color:red;"><span class="material-icons-round">delete</span></button>
                    <button onclick="editFromView()" class="btn-icon"><span class="material-icons-round">edit</span></button>
                    <button onclick="document.getElementById('viewModal').classList.remove('show')" class="btn-icon"><span class="material-icons-round">close</span></button>
                </div>
            </div>
            <div class="modal-scroll" id="viewBody" style="background:#eee; padding:0;"></div>
            <div class="modal-footer" id="viewFooter" style="display:none; justify-content:center;"></div>
        </div>
    </div>

    <div id="editModal" class="modal-wrap">
        <div class="modal-box">
            <div class="card-header">
                <span id="editModalTitle">Nuovo Canto</span>
                <button onclick="document.getElementById('editModal').classList.remove('show')" class="btn-icon">√ó</button>
            </div>
            <div class="modal-scroll">
                <input type="hidden" id="songId">
                <label>Titolo</label><input type="text" id="songTitle" class="form-control">
                <label>Parti</label><div class="chips-container" id="catChips"></div>
                <label>Tempo</label><div class="chips-container" id="seasonChips"></div>
                <div style="background:#f0f2f5; padding:15px; border-radius:8px; text-align:center; margin-bottom:15px;">
                    <p id="fileStatus" style="font-weight:bold; color:var(--primary); margin-top:0;">Nessun file</p>
                    <div style="display:flex; gap:10px; justify-content:center; flex-wrap:wrap;">
                        <button onclick="driveAction('picker')" class="btn-outline" style="background:white;">Google Drive</button>
                        <button onclick="document.getElementById('localFile').click()" class="btn-outline" style="background:white;">Locale</button>
                    </div>
                    <div id="driveOptions" class="d-none" style="margin-top:10px;">
                        <label><input type="radio" name="storeMode" value="link" checked> Link</label>
                        <label><input type="radio" name="storeMode" value="full"> Scarica</label>
                    </div>
                    <input type="file" id="localFile" hidden multiple onchange="handleFile(this)">
                </div>
                <label>Testo</label><textarea id="songLyrics" class="form-control"></textarea>
            </div>
            <div class="modal-footer">
                <button onclick="saveSong()" class="btn-primary" style="width:100%;">SALVA</button>
            </div>
        </div>
    </div>

    <div id="shareModal" class="modal-wrap">
        <div class="modal-box" style="height:auto; max-width:450px;">
            <div class="card-header"><span>Condividi / PDF</span><span class="material-icons-round" onclick="document.getElementById('shareModal').classList.remove('show')" style="cursor:pointer;">close</span></div>
            <div class="modal-scroll">
                <p style="font-weight:bold; color:#555;">PDF:</p>
                <div style="background:#f5f5f5; padding:15px; border-radius:8px; margin-bottom:20px;">
                    <label style="display:block; margin-bottom:5px;"><input type="checkbox" id="chkSongs" checked> Canti</label>
                    <label style="display:block; margin-bottom:5px;"><input type="checkbox" id="chkReads" checked> Letture</label>
                    <label style="display:block;"><input type="checkbox" id="chkHeader" checked> Intestazione</label>
                </div>
                <button class="btn-primary" onclick="generatePDF('download')" style="width:100%; margin-bottom:10px;">‚¨áÔ∏è SCARICA PDF</button>
                <button class="btn-outline" onclick="generatePDF('print')" style="width:100%; margin-bottom:15px;">üñ®Ô∏è STAMPA</button>
                <hr style="border:0; border-top:1px solid #eee; margin:15px 0;">
                <p style="font-weight:bold; color:#555;">WhatsApp:</p>
                <div style="display:flex; gap:10px; justify-content:center;">
                    <button class="btn-outline" onclick="shareText('list')">Scaletta</button>
                    <button class="btn-outline" onclick="shareText('read')">Letture</button>
                    <button class="btn-outline" onclick="shareText('all')">Tutto</button>
                </div>
            </div>
        </div>
    </div>

    <div id="syncModal" class="modal-wrap">
        <div class="modal-box" style="height:auto; max-width:400px;">
            <div class="modal-header"><span>Cloud</span><span class="material-icons-round" onclick="document.getElementById('syncModal').classList.remove('show')">close</span></div>
            <div class="modal-scroll" style="text-align:center;">
                <p id="syncStatus">In attesa...</p>
                <div id="syncLoader" style="display:none; margin:10px auto; border:4px solid #f3f3f3; border-top:4px solid var(--primary); border-radius:50%; width:30px; height:30px; animation:spin 1s linear infinite;"></div>
            </div>
        </div>
    </div>
    <style>@keyframes spin{0%{transform:rotate(0deg);}100%{transform:rotate(360deg);}}</style>

    <div id="readingContainer">
        <div class="reading-nav no-print">
            <button class="btn-icon" onclick="stopReadingMode()" style="color:red;"><span class="material-icons-round">arrow_back</span></button>
            <div style="display:flex; gap:10px;">
                <button onclick="setReadTab('music')" class="btn-outline" id="rtab-music">Canti</button>
                <button onclick="setReadTab('word')" class="btn-outline" id="rtab-word">Letture</button>
            </div>
            <div style="width:40px;"></div>
        </div>
        <div class="reading-content">
            <div id="printHeader" style="text-align:center; margin-bottom:30px; display:none;">
                <h1 id="phTitle"></h1><p id="phDate"></p><hr>
            </div>
            <div id="readMusicArea"></div>
            <div id="readWordArea" class="d-none" style="max-width:800px; margin:0 auto; font-size:1.2rem; line-height:1.6;"></div>
        </div>
    </div>

    <div id="toast"></div>

    <script>
        let db; let tempFilesList=[]; let currentSongId=null; let driveTempMeta=null;
        const CATS = ["Ingresso", "Gloria", "Salmo", "Alleluia", "Offertorio", "Santo", "Comunione", "Finale", "Altro"];
        const SEASONS = ["Ordinario", "Avvento", "Natale", "Quaresima", "Pasqua"];
        const SYNC_FILE_NAME = "spartiti_db_master.json";
        let filterCatVar = 'Tutti';
        let tokenClient; let gapiInited=false; let gisInited=false;

        // CRITICAL FIX: Inizializzazione sincrona di Google API
        window.onload = () => {
            document.getElementById('messaDate').valueAsDate = new Date();
            document.getElementById('apiKey').value = localStorage.getItem('g_api')||"";
            document.getElementById('clientId').value = localStorage.getItem('g_client')||"";
            
            // Inizializza DB
            const r = indexedDB.open("SpartitiDB_V5", 1);
            r.onupgradeneeded = (e) => {
                db = e.target.result;
                if(!db.objectStoreNames.contains("songs")) db.createObjectStore("songs", {keyPath:"id", autoIncrement:true});
                if(!db.objectStoreNames.contains("setlists")) db.createObjectStore("setlists", {keyPath:"id", autoIncrement:true});
            };
            r.onsuccess = (e) => { db=e.target.result; renderLibrary(); renderScalettaUI(); renderFullHistory(); };
            renderModalChips();
            
            // CRITICAL FIX: Inizializza Google API in modo sincrono
            const k = localStorage.getItem('g_api');
            const c = localStorage.getItem('g_client');
            if(k && c) {
                // Carica GAPI
                gapi.load('client:picker', async () => {
                    await gapi.client.init({
                        apiKey: k,
                        discoveryDocs: ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"]
                    });
                    gapiInited = true;
                    console.log('GAPI ready');
                });
                
                // Inizializza GIS
                setTimeout(() => {
                    tokenClient = google.accounts.oauth2.initTokenClient({
                        client_id: c,
                        scope: 'https://www.googleapis.com/auth/drive.file https://www.googleapis.com/auth/drive.readonly',
                        callback: ''
                    });
                    gisInited = true;
                    console.log('GIS ready');
                }, 500);
            }
        };

        function toggleSidebar() {
            document.querySelector('.sidebar').classList.toggle('active');
            document.querySelector('.sidebar-overlay').classList.toggle('active');
        }

        function renderModalChips() {
            document.getElementById('catChips').innerHTML = CATS.map(c => `<div class="chip-select" onclick="toggleChip(this)" data-val="${c}">${c}</div>`).join('');
            document.getElementById('seasonChips').innerHTML = SEASONS.map(s => `<div class="chip-select" onclick="toggleChip(this)" data-val="${s}">${s}</div>`).join('');
        }
        function toggleChip(el) { el.classList.toggle('selected'); }

        function go(id, btn) {
            document.querySelectorAll('.view-section').forEach(x=>x.classList.remove('active'));
            document.getElementById('view-'+id).classList.add('active');
            document.querySelectorAll('.nav-btn').forEach(x=>x.classList.remove('active'));
            if(btn) btn.classList.add('active');
            if(id==='library') renderLibrary();
            if(id==='history') renderFullHistory();
        }

        function filterLib(cat) { 
            filterCatVar=cat; 
            renderLibrary(); 
            document.querySelectorAll('#view-library .btn-outline').forEach(b => {
                if(b.innerText === cat) {
                    b.style.background = 'var(--primary)';
                    b.style.color = 'white';
                } else {
                    b.style.background = 'transparent';
                    b.style.color = '#555';
                }
            });
        }
        
        function renderLibrary() {
            const list = document.getElementById('songList'); list.innerHTML="";
            const txt = document.getElementById('searchInput').value.toLowerCase();
            const tx = db.transaction("songs","readonly");
            tx.objectStore("songs").openCursor().onsuccess = (e) => {
                const c = e.target.result;
                if(c) {
                    const s = c.value;
                    const cats = Array.isArray(s.categories) ? s.categories : [s.category||'Altro'];
                    let ok = true;
                    if(filterCatVar!=='Tutti' && !cats.includes(filterCatVar)) ok=false;
                    if(txt && !s.title.toLowerCase().includes(txt)) ok=false;
                    if(ok) {
                        const badgeClass = s.fileData ? 'status-offline' : 'status-online';
                        const badgeText = s.fileData ? 'Offline' : 'Online';
                        const icon = s.type && s.type.includes('pdf') ? 'picture_as_pdf' : 'description';
                        list.innerHTML += `<div class="song-item" onclick="openViewModal(${s.id})"><div><div style="font-weight:bold;">${s.title}</div><div style="margin-top:2px;"><span class="status-badge ${badgeClass}">${badgeText}</span> <small style="color:#666;">${cats.join(', ')}</small></div></div><span class="material-icons-round" style="color:#ccc;">${icon}</span></div>`;
                    }
                    c.continue();
                }
            }
        }

        function renderScalettaUI() {
            const c = document.getElementById('scalettaContainer'); c.innerHTML = "";
            CATS.forEach(cat => { 
                if(cat === 'Altro') return; 
                c.innerHTML += `<div style="margin-bottom:10px;" data-part="${cat}"><label style="font-size:0.8rem; font-weight:bold; color:#666;">${cat}</label><div style="display:flex; gap:5px;"><select class="form-control song-select" style="margin:0;"><option value="">Seleziona...</option></select><button onclick="this.previousElementSibling.value=''" class="btn-outline">X</button></div></div>`;
            });
            setTimeout(updateSuggestions, 500);
        }
        
        function updateSuggestions() {
            const d = new Date(document.getElementById('messaDate').value); 
            const m = d.getMonth()+1; 
            const day = d.getDate();
            let season = "Ordinario"; 
            if (m===11&&day>=27||m===12&&day<=24) season="Avvento"; 
            else if (m===12&&day>=25||m===1) season="Natale"; 
            else if (m>=2&&m<=4) season="Quaresima"; 
            else if (m===4||m===5) season="Pasqua";
            
            db.transaction("songs").objectStore("songs").getAll().onsuccess=(e)=>{
                const songs = e.target.result.sort((a,b)=>a.title.localeCompare(b.title));
                document.querySelectorAll('.song-select').forEach(sel=>{
                    const part=sel.parentElement.parentElement.dataset.part; 
                    const old=sel.value; 
                    let sug="", oth="";
                    songs.forEach(s=>{
                        const cats = Array.isArray(s.categories)?s.categories:[s.category];
                        const seas = Array.isArray(s.seasons)?s.seasons:[s.season];
                        if(cats.includes(part)&&(seas.includes(season)||seas.includes("Tutti"))) 
                            sug+=`<option value="${s.id}">‚òÖ ${s.title}</option>`; 
                        else 
                            oth+=`<option value="${s.id}">${s.title}</option>`;
                    });
                    sel.innerHTML=`<option value="">Seleziona...</option><optgroup label="Suggeriti (${season})">${sug}</optgroup><optgroup label="Altri">${oth}</optgroup>`; 
                    sel.value=old;
                });
            }
        }

        // GOOGLE DRIVE - CRITICAL FIX
        function saveKeys(){
            localStorage.setItem('g_api',document.getElementById('apiKey').value);
            localStorage.setItem('g_client',document.getElementById('clientId').value);
            showToast("Riavvio...");
            setTimeout(()=>location.reload(), 1000);
        }
        
        async function driveAction(action, id=null) {
            const k = document.getElementById('apiKey').value;
            const c = document.getElementById('clientId').value;
            if(!k || !c) {
                showToast("Configurare API Key e Client ID prima", "error");
                go('settings');
                return;
            }
            
            document.querySelectorAll('.modal-wrap').forEach(m => m.classList.remove('show'));
            if(action === 'sync') {
                document.getElementById('syncModal').classList.add('show');
                return;
            }
            
            // CRITICAL FIX: Inizializza se necessario in modo sincrono
            if(!gapiInited) {
                await new Promise(resolve => {
                    gapi.load('client:picker', async () => {
                        await gapi.client.init({
                            apiKey: k,
                            discoveryDocs: ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"]
                        });
                        gapiInited = true;
                        resolve();
                    });
                });
            }
            
            if(!gisInited) {
                tokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: c,
                    scope: 'https://www.googleapis.com/auth/drive.file https://www.googleapis.com/auth/drive.readonly',
                    callback: ''
                });
                gisInited = true;
            }
            
            // CRITICAL FIX: Controllo token e richiesta diretta (non async)
            const token = gapi.client.getToken();
            if(token && Date.now() < token.expires_at) {
                executeDriveAction(action, id);
            } else {
                // QUESTO √à IL FIX CRITICO: callback sincrono e requestAccessToken sincrono
                tokenClient.callback = (resp) => {
                    if(resp.error) {
                        showToast("Errore Auth: " + resp.error, "error");
                        return;
                    }
                    gapi.client.setToken(resp);
                    executeDriveAction(action, id);
                };
                // CRITICAL: Chiamata DIRETTA senza await
                tokenClient.requestAccessToken({prompt: ''});
            }
        }
        
        async function executeDriveAction(action, id) {
            document.getElementById('syncModal').classList.add('show');
            document.getElementById('syncStatus').innerText = "Operazione in corso...";
            document.getElementById('syncLoader').style.display = 'inline-block';
            
            if(!gapi.client.drive) await gapi.client.load('drive', 'v3');
            
            if(action === 'picker') createPicker(gapi.client.getToken().access_token);
            else if(action === 'upload') await performUpload();
            else if(action === 'download') await performDownload();
            else if(action === 'downloadOne') await downloadSingleSong(id);
            
            document.getElementById('syncLoader').style.display = 'none';
        }
        
        function createPicker(t) {
            const k = document.getElementById('apiKey').value;
            const v = new google.picker.DocsView(google.picker.ViewId.DOCS)
                .setIncludeFolders(true)
                .setMimeTypes("application/pdf,image/png,image/jpeg");
            new google.picker.PickerBuilder()
                .setDeveloperKey(k)
                .setOAuthToken(t)
                .addView(v)
                .enableFeature(google.picker.Feature.MULTISELECT_ENABLED)
                .setCallback(pickerCallback)
                .build()
                .setVisible(true);
        }
        
        async function pickerCallback(d) {
            if(d.action === google.picker.Action.PICKED) {
                tempFilesList = [];
                document.getElementById('editModal').classList.add('show');
                const t = gapi.client.getToken().access_token;
                for(let doc of d.docs) {
                    try {
                        const r = await fetch(`https://www.googleapis.com/drive/v3/files/${doc.id}?alt=media`, {
                            headers: {'Authorization': `Bearer ${t}`}
                        });
                        const b = await r.blob();
                        const base64 = await new Promise(res => {
                            const fr = new FileReader();
                            fr.onload = e => res(e.target.result);
                            fr.readAsDataURL(b);
                        });
                        tempFilesList.push({
                            name: doc.name.replace(/\.[^/.]+$/, ""),
                            id: doc.id,
                            type: doc.mimeType,
                            data: base64,
                            source: 'drive'
                        });
                    } catch(e) {
                        console.error('Errore download file:', e);
                    }
                }
                document.getElementById('fileStatus').innerText = `${tempFilesList.length} File Drive`;
                document.getElementById('driveOptions').classList.remove('d-none');
                if(tempFilesList.length === 1) {
                    document.getElementById('songTitle').value = tempFilesList[0].name;
                    driveTempMeta = tempFilesList[0];
                }
            } else {
                document.getElementById('editModal').classList.add('show');
            }
        }
        
        async function performUpload() {
            document.getElementById('syncStatus').innerText = "Caricamento in corso...";
            const tx = db.transaction(["songs", "setlists"], "readonly");
            const s = await new Promise(r => tx.objectStore("songs").getAll().onsuccess = e => r(e.target.result));
            const l = await new Promise(r => tx.objectStore("setlists").getAll().onsuccess = e => r(e.target.result));
            const fileContent = JSON.stringify({songs: s, setlists: l});
            
            try {
                const q = `name = '${SYNC_FILE_NAME}' and trashed = false`;
                const list = await gapi.client.drive.files.list({q: q, fields: 'files(id)'});
                
                if(list.result.files.length > 0) {
                    // Aggiorna file esistente
                    await fetch(`https://www.googleapis.com/upload/drive/v3/files/${list.result.files[0].id}?uploadType=media`, {
                        method: 'PATCH',
                        headers: {
                            'Authorization': `Bearer ${gapi.client.getToken().access_token}`,
                            'Content-Type': 'application/json'
                        },
                        body: fileContent
                    });
                } else {
                    // Crea nuovo file
                    const meta = {name: SYNC_FILE_NAME, mimeType: 'application/json'};
                    const form = new FormData();
                    form.append('metadata', new Blob([JSON.stringify(meta)], {type: 'application/json'}));
                    form.append('file', new Blob([fileContent], {type: 'application/json'}));
                    await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                        method: 'POST',
                        headers: {'Authorization': `Bearer ${gapi.client.getToken().access_token}`},
                        body: form
                    });
                }
                document.getElementById('syncStatus').innerText = "Backup Completato ‚úÖ";
                showToast("Backup completato!");
            } catch(e) {
                document.getElementById('syncStatus').innerText = "Errore Upload: " + e.message;
                showToast("Errore upload", "error");
            }
        }
        
        async function performDownload() {
            document.getElementById('syncStatus').innerText = "Scaricamento...";
            try {
                const q = `name = '${SYNC_FILE_NAME}' and trashed = false`;
                const list = await gapi.client.drive.files.list({q: q, fields: 'files(id)'});
                
                if(list.result.files.length === 0) {
                    document.getElementById('syncStatus').innerText = "Nessun backup trovato";
                    return;
                }
                
                const res = await gapi.client.drive.files.get({
                    fileId: list.result.files[0].id,
                    alt: 'media'
                });
                
                const data = res.result;
                const tx = db.transaction(["songs", "setlists"], "readwrite");
                tx.objectStore("songs").clear();
                tx.objectStore("setlists").clear();
                data.songs.forEach(s => tx.objectStore("songs").put(s));
                data.setlists.forEach(s => tx.objectStore("setlists").put(s));
                
                tx.oncomplete = () => {
                    document.getElementById('syncStatus').innerText = "Ripristino Completato ‚úÖ";
                    showToast("Ripristinato!");
                    setTimeout(() => location.reload(), 1500);
                };
            } catch(e) {
                document.getElementById('syncStatus').innerText = "Errore: " + e.message;
                showToast("Errore download", "error");
            }
        }
        
        async function downloadSingleSong(id) {
            const tx = db.transaction("songs", "readwrite");
            tx.objectStore("songs").get(id).onsuccess = async (e) => {
                const s = e.target.result;
                try {
                    const t = gapi.client.getToken().access_token;
                    const r = await fetch(`https://www.googleapis.com/drive/v3/files/${s.driveId}?alt=media`, {
                        headers: {'Authorization': `Bearer ${t}`}
                    });
                    const b = await r.blob();
                    const fr = new FileReader();
                    fr.onload = (ev) => {
                        s.fileData = ev.target.result;
                        const tx2 = db.transaction("songs", "readwrite");
                        tx2.objectStore("songs").put(s).onsuccess = () => {
                            showToast("Scaricato!");
                            openViewModal(id);
                            renderLibrary();
                        };
                    };
                    fr.readAsDataURL(b);
                } catch(err) {
                    showToast("Errore: " + err, "error");
                }
            };
        }

        function handleFile(input) {
            const files = input.files;
            if(!files.length) return;
            tempFilesList = [];
            document.getElementById('fileStatus').innerText = "Lettura...";
            const readFile = (f) => new Promise(r => {
                const rd = new FileReader();
                rd.onload = e => r({
                    name: f.name.replace(/\.[^/.]+$/, ""),
                    type: f.type,
                    data: e.target.result
                });
                rd.readAsDataURL(f);
            });
            Promise.all(Array.from(files).map(f => readFile(f))).then(res => {
                tempFilesList = res;
                if(tempFilesList.length === 1) {
                    document.getElementById('songTitle').value = tempFilesList[0].name;
                    document.getElementById('fileStatus').innerText = "1 File Locale ‚úÖ";
                } else {
                    document.getElementById('songTitle').value = "[Multiplo]";
                    document.getElementById('fileStatus').innerText = `${tempFilesList.length} File Locali ‚úÖ`;
                }
            });
        }

        function saveSong() {
            if(tempFilesList.length === 0 && !driveTempMeta && !document.getElementById('songLyrics').value && !document.getElementById('songId').value) {
                showToast("Nessun dato da salvare", "error");
                return;
            }
            
            const cats = Array.from(document.querySelectorAll('#catChips .selected')).map(c => c.dataset.val);
            const seas = Array.from(document.querySelectorAll('#seasonChips .selected')).map(c => c.dataset.val);
            if(cats.length === 0) cats.push("Altro");
            if(seas.length === 0) seas.push("Ordinario");
            
            const lyrics = document.getElementById('songLyrics').value;
            const editId = document.getElementById('songId').value;
            const tx = db.transaction("songs", "readwrite");
            const store = tx.objectStore("songs");

            if(driveTempMeta) {
                const mode = document.querySelector('input[name="storeMode"]:checked').value;
                const s = {
                    title: document.getElementById('songTitle').value,
                    categories: cats,
                    seasons: seas,
                    lyrics: lyrics,
                    driveId: driveTempMeta.id,
                    type: driveTempMeta.type,
                    fileData: mode === 'full' ? driveTempMeta.data : null
                };
                if(editId) s.id = Number(editId);
                store.put(s);
            } else if(tempFilesList.length > 0) {
                if(tempFilesList.length === 1 && editId) {
                    store.put({
                        id: Number(editId),
                        title: document.getElementById('songTitle').value,
                        categories: cats,
                        seasons: seas,
                        lyrics: lyrics,
                        fileData: tempFilesList[0].data,
                        type: tempFilesList[0].type
                    });
                } else {
                    tempFilesList.forEach(f => {
                        const data = f.source === 'drive' ? (document.querySelector('input[name="storeMode"]:checked').value === 'full' ? f.data : null) : f.data;
                        const drvId = f.source === 'drive' ? f.id : null;
                        store.add({
                            title: f.name,
                            categories: cats,
                            seasons: seas,
                            lyrics: "",
                            fileData: data,
                            type: f.type,
                            driveId: drvId
                        });
                    });
                }
            } else if(editId) {
                store.get(Number(editId)).onsuccess = (e) => {
                    const old = e.target.result;
                    const s = {
                        id: Number(editId),
                        title: document.getElementById('songTitle').value,
                        categories: cats,
                        seasons: seas,
                        lyrics: lyrics,
                        fileData: old.fileData,
                        type: old.type,
                        driveId: old.driveId
                    };
                    store.put(s);
                };
            } else {
                store.add({
                    title: document.getElementById('songTitle').value,
                    categories: cats,
                    seasons: seas,
                    lyrics: lyrics,
                    fileData: null,
                    type: null
                });
            }
            
            tx.oncomplete = () => {
                document.getElementById('editModal').classList.remove('show');
                renderLibrary();
                updateSuggestions();
                showToast("Salvato!");
            };
        }

        function openViewModal(id) {
            currentSongId = id;
            db.transaction("songs").objectStore("songs").get(id).onsuccess = (e) => {
                const s = e.target.result;
                document.getElementById('viewTitle').innerText = s.title;
                const body = document.getElementById('viewBody');
                const footer = document.getElementById('viewFooter');
                body.innerHTML = "";
                footer.style.display = "none";
                
                if(s.fileData) {
                    if(s.type && s.type.includes('pdf')) {
                        body.innerHTML = `<iframe src="${s.fileData}" class="pdf-frame"></iframe>`;
                    } else {
                        body.innerHTML = `<img src="${s.fileData}" style="width:100%; display:block;">`;
                    }
                } else if(s.driveId) {
                    body.innerHTML = `<div style="padding:40px; text-align:center;"><p style="color:#666;">File su Google Drive</p><button onclick="driveAction('downloadOne', ${id})" class="btn-primary">‚¨áÔ∏è Scarica File</button></div>`;
                } else if(s.lyrics) {
                    body.innerHTML = `<div style="padding:20px; white-space:pre-wrap; font-size:1.1rem;">${s.lyrics}</div>`;
                } else {
                    body.innerHTML = `<div style="padding:40px; text-align:center; color:#999;">Nessun contenuto</div>`;
                }
                
                document.getElementById('viewModal').classList.add('show');
            };
        }

        function deleteCurrentSong() {
            if(confirm("Eliminare definitivamente questo canto?")) {
                db.transaction("songs", "readwrite").objectStore("songs").delete(currentSongId).onsuccess = () => {
                    document.getElementById('viewModal').classList.remove('show');
                    renderLibrary();
                    updateSuggestions();
                    showToast("Eliminato!");
                };
            }
        }

        function editFromView() {
            document.getElementById('viewModal').classList.remove('show');
            openEditModal(currentSongId);
        }

        function openEditModal(id=null) {
            document.getElementById('editModal').classList.add('show');
            document.getElementById('songId').value = "";
            document.getElementById('songTitle').value = "";
            document.getElementById('songLyrics').value = "";
            document.getElementById('fileStatus').innerText = "Nessun file";
            tempFilesList = [];
            driveTempMeta = null;
            document.getElementById('driveOptions').classList.add('d-none');
            document.querySelectorAll('.chip-select').forEach(c => c.classList.remove('selected'));
            document.getElementById('editModalTitle').innerText = id ? "Modifica Canto" : "Nuovo Canto";
            
            if(id) {
                document.getElementById('songId').value = id;
                db.transaction("songs").objectStore("songs").get(id).onsuccess = (e) => {
                    const s = e.target.result;
                    document.getElementById('songTitle').value = s.title;
                    document.getElementById('songLyrics').value = s.lyrics || "";
                    
                    if(s.fileData) {
                        tempFilesList = [{data: s.fileData, type: s.type, name: s.title}];
                        document.getElementById('fileStatus').innerText = "File Presente ‚úÖ";
                    } else if(s.driveId) {
                        document.getElementById('fileStatus').innerText = "File Drive ‚òÅÔ∏è";
                    }
                    
                    const cats = Array.isArray(s.categories) ? s.categories : [s.category];
                    const seas = Array.isArray(s.seasons) ? s.seasons : [s.season];
                    document.querySelectorAll('#catChips .chip-select').forEach(c => {
                        if(cats.includes(c.dataset.val)) c.classList.add('selected');
                    });
                    document.querySelectorAll('#seasonChips .chip-select').forEach(c => {
                        if(seas.includes(c.dataset.val)) c.classList.add('selected');
                    });
                };
            }
        }

        function saveSetlist() {
            const data = {
                date: document.getElementById('messaDate').value,
                title: document.getElementById('messaTitle').value,
                songs: {},
                readings: {
                    first: document.getElementById('reading1').value,
                    psalm: document.getElementById('psalm').value,
                    second: document.getElementById('reading2').value,
                    gospel: document.getElementById('gospel').value
                }
            };
            
            document.querySelectorAll('.song-select').forEach(sel => {
                if(sel.value) {
                    const part = sel.parentElement.parentElement.dataset.part;
                    data.songs[part] = Number(sel.value);
                }
            });
            
            const tx = db.transaction("setlists", "readwrite");
            tx.objectStore("setlists").add(data);
            tx.oncomplete = () => {
                showToast("Messa salvata!");
                renderFullHistory();
            };
        }

        function renderFullHistory() {
            const list = document.getElementById('fullHistoryList');
            list.innerHTML = "";
            const tx = db.transaction("setlists", "readonly");
            tx.objectStore("setlists").openCursor(null, 'prev').onsuccess = (e) => {
                const c = e.target.result;
                if(c) {
                    const s = c.value;
                    const songCount = Object.keys(s.songs || {}).length;
                    list.innerHTML += `<div class="history-item" onclick="loadSetlist(${s.id})"><div><div style="font-weight:bold;">${s.title || 'Messa'}</div><div style="font-size:0.85rem; color:#666; margin-top:2px;">${s.date} ‚Ä¢ ${songCount} canti</div></div><span class="material-icons-round" style="color:#ccc;">event</span></div>`;
                    c.continue();
                }
            };
        }

        function loadSetlist(id) {
            db.transaction("setlists").objectStore("setlists").get(id).onsuccess = (e) => {
                const s = e.target.result;
                document.getElementById('messaDate').value = s.date;
                document.getElementById('messaTitle').value = s.title || "";
                document.getElementById('reading1').value = s.readings.first || "";
                document.getElementById('psalm').value = s.readings.psalm || "";
                document.getElementById('reading2').value = s.readings.second || "";
                document.getElementById('gospel').value = s.readings.gospel || "";
                
                updateSuggestions();
                setTimeout(() => {
                    document.querySelectorAll('.song-select').forEach(sel => {
                        const part = sel.parentElement.parentElement.dataset.part;
                        if(s.songs[part]) sel.value = s.songs[part];
                    });
                }, 600);
                
                go('scaletta');
                showToast("Messa caricata!");
            };
        }

        async function autoFetchReadings() {
            const date = document.getElementById('messaDate').value;
            if(!date) {
                showToast("Seleziona una data", "error");
                return;
            }
            
            showToast("Scaricamento letture...");
            const [y, m, d] = date.split('-');
            const url = `https://api.allorigins.win/get?url=${encodeURIComponent('https://www.lachiesa.it/mobile_liturgia.php?data=' + date)}`;
            
            try {
                const res = await fetch(url);
                const data = await res.json();
                const parser = new DOMParser();
                const doc = parser.parseFromString(data.contents, 'text/html');
                const text = doc.body.innerText;
                
                const sections = {
                    first: /Prima Lettura[\s\S]*?(?=Salmo|$)/i,
                    psalm: /Salmo Responsoriale[\s\S]*?(?=Seconda|Vangelo|$)/i,
                    second: /Seconda Lettura[\s\S]*?(?=Vangelo|$)/i,
                    gospel: /Vangelo[\s\S]*?$/i
                };
                
                for(let [key, regex] of Object.entries(sections)) {
                    const match = text.match(regex);
                    if(match) {
                        const field = key === 'first' ? 'reading1' : 
                                    key === 'psalm' ? 'psalm' :
                                    key === 'second' ? 'reading2' : 'gospel';
                        document.getElementById(field).value = match[0].trim();
                    }
                }
                
                showToast("Letture scaricate!");
            } catch(e) {
                showToast("Errore download letture", "error");
            }
        }

        function shareText(mode) {
            let text = `üéµ ${document.getElementById('messaTitle').value || 'Messa'}\nüìÖ ${document.getElementById('messaDate').value}\n\n`;
            
            if(mode === 'list' || mode === 'all') {
                text += "üìã SCALETTA CANTI\n";
                document.querySelectorAll('.song-select').forEach(sel => {
                    if(sel.value) {
                        const part = sel.parentElement.parentElement.dataset.part;
                        const songId = Number(sel.value);
                        db.transaction("songs").objectStore("songs").get(songId).onsuccess = (e) => {
                            text += `${part}: ${e.target.result.title}\n`;
                        };
                    }
                });
                text += "\n";
            }
            
            if(mode === 'read' || mode === 'all') {
                text += "üìñ LETTURE\n\n";
                const r1 = document.getElementById('reading1').value;
                const ps = document.getElementById('psalm').value;
                const r2 = document.getElementById('reading2').value;
                const gos = document.getElementById('gospel').value;
                if(r1) text += "PRIMA LETTURA\n" + r1 + "\n\n";
                if(ps) text += "SALMO\n" + ps + "\n\n";
                if(r2) text += "SECONDA LETTURA\n" + r2 + "\n\n";
                if(gos) text += "VANGELO\n" + gos + "\n\n";
            }
            
            setTimeout(() => {
                if(navigator.share) {
                    navigator.share({text: text}).catch(() => {});
                } else {
                    navigator.clipboard.writeText(text);
                    showToast("Copiato!");
                }
            }, 500);
        }

        async function startReadingMode() {
            document.getElementById('readingContainer').classList.add('active');
            const musicArea = document.getElementById('readMusicArea');
            const wordArea = document.getElementById('readWordArea');
            musicArea.innerHTML = "";
            wordArea.innerHTML = "";
            
            // Carica canti
            const promises = [];
            document.querySelectorAll('.song-select').forEach(sel => {
                if(sel.value) {
                    const part = sel.parentElement.parentElement.dataset.part;
                    const songId = Number(sel.value);
                    const p = new Promise(resolve => {
                        db.transaction("songs").objectStore("songs").get(songId).onsuccess = (e) => {
                            const s = e.target.result;
                            let html = `<div class="score-seq-item"><h3>${part}: ${s.title}</h3>`;
                            if(s.fileData) {
                                if(s.type && s.type.includes('pdf')) {
                                    html += `<iframe src="${s.fileData}" class="pdf-frame"></iframe>`;
                                } else {
                                    html += `<img src="${s.fileData}" style="width:100%;" onload="this.dispatchEvent(new Event('imageloaded'))">`;
                                }
                            } else if(s.lyrics) {
                                html += `<pre style="white-space:pre-wrap; font-size:1rem;">${s.lyrics}</pre>`;
                            }
                            html += `</div>`;
                            musicArea.innerHTML += html;
                            resolve();
                        };
                    });
                    promises.push(p);
                }
            });
            
            // Carica letture
            const r1 = document.getElementById('reading1').value;
            const ps = document.getElementById('psalm').value;
            const r2 = document.getElementById('reading2').value;
            const gos = document.getElementById('gospel').value;
            
            if(r1) wordArea.innerHTML += `<h3>Prima Lettura</h3><p>${r1.replace(/\n/g, '<br>')}</p><br>`;
            if(ps) wordArea.innerHTML += `<h3>Salmo Responsoriale</h3><p>${ps.replace(/\n/g, '<br>')}</p><br>`;
            if(r2) wordArea.innerHTML += `<h3>Seconda Lettura</h3><p>${r2.replace(/\n/g, '<br>')}</p><br>`;
            if(gos) wordArea.innerHTML += `<h3>Vangelo</h3><p>${gos.replace(/\n/g, '<br>')}</p><br>`;
            
            // Attendi caricamento immagini
            await Promise.all(promises);
            await new Promise(resolve => {
                const images = musicArea.querySelectorAll('img');
                if(images.length === 0) {
                    resolve();
                    return;
                }
                let loaded = 0;
                images.forEach(img => {
                    if(img.complete) {
                        loaded++;
                        if(loaded === images.length) resolve();
                    } else {
                        img.addEventListener('imageloaded', () => {
                            loaded++;
                            if(loaded === images.length) resolve();
                        });
                    }
                });
            });
            
            setReadTab('music');
        }

        function stopReadingMode() {
            document.getElementById('readingContainer').classList.remove('active');
            document.body.className = "";
        }

        function setReadTab(mode) {
            if(mode === 'music') {
                document.getElementById('readMusicArea').classList.remove('d-none');
                document.getElementById('readWordArea').classList.add('d-none');
                document.getElementById('rtab-music').style.background = 'var(--primary)';
                document.getElementById('rtab-music').style.color = 'white';
                document.getElementById('rtab-word').style.background = 'transparent';
                document.getElementById('rtab-word').style.color = '#555';
            } else {
                document.getElementById('readMusicArea').classList.add('d-none');
                document.getElementById('readWordArea').classList.remove('d-none');
                document.getElementById('rtab-word').style.background = 'var(--primary)';
                document.getElementById('rtab-word').style.color = 'white';
                document.getElementById('rtab-music').style.background = 'transparent';
                document.getElementById('rtab-music').style.color = '#555';
            }
        }

        async function generatePDF(mode) {
            document.body.className = "";
            if(!document.getElementById('chkSongs').checked) document.body.classList.add('print-text-only');
            if(!document.getElementById('chkReads').checked) document.body.classList.add('print-music-only');
            
            const ph = document.getElementById('printHeader');
            if(document.getElementById('chkHeader').checked) {
                ph.style.display = 'block';
                document.getElementById('phTitle').innerText = document.getElementById('messaTitle').value;
                document.getElementById('phDate').innerText = document.getElementById('messaDate').value;
            } else {
                ph.style.display = 'none';
            }

            await startReadingMode();
            
            if(mode === 'print') {
                setTimeout(() => {
                    window.print();
                }, 1500);
            } else {
                const element = document.getElementById('readingContainer');
                const opt = {
                    margin: 10,
                    filename: `Messa_${document.getElementById('messaDate').value}.pdf`,
                    image: {type: 'jpeg', quality: 0.98},
                    html2canvas: {scale: 2},
                    jsPDF: {unit: 'mm', format: 'a4', orientation: 'portrait'}
                };
                
                setTimeout(() => {
                    html2pdf().from(element).set(opt).save().then(() => {
                        stopReadingMode();
                        document.getElementById('shareModal').classList.remove('show');
                    });
                }, 2000);
            }
        }

        function exportData() {
            const tx = db.transaction(["songs", "setlists"], "readonly");
            Promise.all([
                new Promise(r => tx.objectStore("songs").getAll().onsuccess = e => r(e.target.result)),
                new Promise(r => tx.objectStore("setlists").getAll().onsuccess = e => r(e.target.result))
            ]).then(([songs, setlists]) => {
                const data = JSON.stringify({songs, setlists});
                const blob = new Blob([data], {type: 'application/json'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `spartiti_backup_${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                showToast("Backup scaricato!");
            });
        }

        function importData(input) {
            const file = input.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    const tx = db.transaction(["songs", "setlists"], "readwrite");
                    tx.objectStore("songs").clear();
                    tx.objectStore("setlists").clear();
                    data.songs.forEach(s => tx.objectStore("songs").put(s));
                    data.setlists.forEach(s => tx.objectStore("setlists").put(s));
                    tx.oncomplete = () => {
                        showToast("Dati importati!");
                        setTimeout(() => location.reload(), 1000);
                    };
                } catch(err) {
                    showToast("Errore import", "error");
                }
            };
            reader.readAsText(file);
        }

        function showToast(msg, type="") {
            const toast = document.getElementById('toast');
            toast.innerText = msg;
            toast.className = type === "error" ? "show error" : "show";
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        // Service Worker
        if('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./sw.js').catch(() => {});
        }
    </script>
</body>
</html>
