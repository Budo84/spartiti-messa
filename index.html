<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Spartiti Messa Pro</title>
    
    <link rel="stylesheet" href="style.css">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="logo192.png">
    <meta name="theme-color" content="#673ab7">
    
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client"></script>
    
    <style>
        /* --- STILI BASE --- */
        :root { --primary: #673ab7; --bg: #f4f4f9; --surface: #ffffff; --text: #333; }
        body { font-family: 'Segoe UI', Roboto, sans-serif; background: var(--bg); margin: 0; padding-bottom: 80px; color: var(--text); }
        
        /* CONTAINER */
        .container { max-width: 1400px; margin: 0 auto; min-height: 100vh; position: relative; }
        @media (min-width: 800px) { .container { padding: 20px; } .view { background: var(--surface); border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); padding: 20px; } }

        /* HEADER PULITO */
        .sticky-header { background: var(--surface); padding: 10px 15px; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 10px rgba(0,0,0,0.05); display: flex; align-items: center; justify-content: space-between; gap: 10px; }
        .header-left { flex: 1; display: flex; flex-direction: column; gap: 5px; }
        
        .header-input { border: none; background: transparent; font-size: 1.1rem; color: var(--primary); font-weight: bold; width: 100%; padding: 0; margin: 0; }
        .header-input::placeholder { color: #aaa; }
        .header-date { font-size: 0.9rem; color: #666; background: #f0f0f0; border: none; border-radius: 4px; padding: 2px 5px; width: fit-content; }

        /* MENU A SCOMPARSA (DROPDOWN) */
        .menu-btn { background: none; border: none; cursor: pointer; color: #444; padding: 8px; border-radius: 50%; transition: 0.2s; }
        .menu-btn:hover { background: #eee; }
        
        .dropdown-menu {
            position: absolute; top: 60px; right: 10px; width: 220px;
            background: white; border-radius: 12px; box-shadow: 0 5px 20px rgba(0,0,0,0.15);
            display: none; flex-direction: column; z-index: 2000; overflow: hidden; border: 1px solid #eee;
        }
        .dropdown-menu.show { display: flex; animation: slideDown 0.2s ease; }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        
        .menu-group { border-bottom: 1px solid #f0f0f0; padding: 5px 0; }
        .menu-group:last-child { border-bottom: none; }
        .menu-label { font-size: 0.75rem; text-transform: uppercase; color: #999; padding: 5px 15px; font-weight: bold; letter-spacing: 0.5px; }
        
        .menu-item {
            background: none; border: none; width: 100%; text-align: left;
            padding: 10px 15px; font-size: 0.95rem; color: #333; cursor: pointer;
            display: flex; align-items: center; gap: 10px; transition: 0.2s;
        }
        .menu-item:hover { background: #f5f5f5; color: var(--primary); }
        .menu-item span { font-size: 1.2rem; color: #666; }
        
        /* SPLIT VIEW */
        .workspace-grid { display: grid; gap: 20px; margin-top: 20px; }
        .workspace-grid.single-view { grid-template-columns: 1fr; }
        .workspace-grid.single-view .col-readings { display: none; }
        .workspace-grid.split-view { grid-template-columns: 1fr 1fr; }
        @media (max-width: 900px) { .workspace-grid.split-view { grid-template-columns: 1fr; } } /* Stack su mobile */

        /* COLONNE */
        .col-box { background: #fff; border: 1px solid #e0e0e0; border-radius: 12px; padding: 15px; }
        .col-title { font-size: 1rem; font-weight: bold; color: var(--primary); margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #f0f0f0; padding-bottom: 8px; }

        /* LISTE */
        .slot-container { margin-bottom: 10px; }
        .selector-row { display: flex; gap: 5px; margin-bottom: 5px; }
        .song-selector { flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 6px; background: #fff; }
        .btn-del-slot { background: #ffebee; color: #d32f2f; border: none; border-radius: 4px; width: 30px; cursor: pointer; }

        /* LETTURE */
        .reading-field textarea { width: 100%; height: 100px; padding: 10px; border: 1px solid #eee; border-radius: 8px; background: #fafafa; font-family: inherit; resize: vertical; margin-bottom: 10px; }
        .reading-field textarea:focus { background: white; border-color: var(--primary); outline: none; }

        /* MODALITA LETTURA IMMERSIVA */
        #readingContainer { display: none; }
        
        body.reading-active .sticky-header, body.reading-active .bottom-nav, body.reading-active .fab-actions { display: none !important; }
        body.reading-active .container { max-width: 100%; padding: 0; }
        
        .reading-nav { 
            position: fixed; top: 0; left: 0; width: 100%; height: 50px; background: #fff; 
            border-bottom: 1px solid #ddd; z-index: 1000; display: flex; align-items: center; 
            padding: 0 10px; box-sizing: border-box; justify-content: space-between;
        }
        .reading-body { margin-top: 50px; height: calc(100vh - 50px); overflow-y: auto; padding: 10px; }
        .reading-body.split { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }

        /* COMPONENTI GENERICI */
        .btn-primary { background: var(--primary); color: white; border: none; padding: 8px 16px; border-radius: 20px; font-weight: bold; cursor: pointer; }
        .btn-outline { background: transparent; border: 1px solid #ddd; color: #555; padding: 6px 12px; border-radius: 20px; cursor: pointer; }
        #toast { visibility: hidden; min-width: 250px; background: #333; color: white; text-align: center; border-radius: 50px; padding: 14px; position: fixed; z-index: 3000; left: 50%; transform: translateX(-50%); bottom: 30px; opacity: 0; transition: 0.3s; }
        #toast.show { visibility: visible; opacity: 1; bottom: 40px; }

        /* STAMPA */
        @media print {
            .no-print, .bottom-nav, .sticky-header, .fab-actions, .menu-btn { display: none !important; }
            .container { padding: 0; margin: 0; max-width: 100%; }
            .col-box { border: none; padding: 0; }
            body.print-messa .col-readings { display: none; }
            body.print-letture .col-messa { display: none; }
            body.print-letture .col-readings { display: block !important; }
        }
    </style>
</head>
<body>

    <div id="toast"><span id="toastMsg"></span></div>

    <div id="fsModal" class="hidden no-print" style="position:fixed;top:0;left:0;width:100%;height:100%;background:black;z-index:4000;display:flex;flex-direction:column;">
        <div style="height:40px;background:#222;display:flex;justify-content:flex-end;align-items:center;padding:0 10px;">
            <button onclick="closeFullscreen()" style="background:none;border:none;color:white;font-weight:bold;cursor:pointer;">CHIUDI ‚úï</button>
        </div>
        <iframe id="fsFrame" style="flex:1;border:none;background:white;"></iframe>
    </div>

    <nav class="bottom-nav no-print">
        <button onclick="switchTab('library')" class="nav-btn active" id="btn-library"><span class="material-icons-round">library_music</span><span>Repertorio</span></button>
        <button onclick="switchTab('scaletta')" class="nav-btn" id="btn-scaletta"><span class="material-icons-round">playlist_play</span><span>Messa</span></button>
        <button onclick="switchTab('settings')" class="nav-btn" id="btn-settings"><span class="material-icons-round">settings</span><span>Opzioni</span></button>
    </nav>

    <div class="container">
        
        <section id="library" class="view active">
            <header class="sticky-header no-print" style="display:block;">
                <div class="search-bar-container" style="display:flex;align-items:center;background:#f0f2f5;padding:8px;border-radius:20px;margin-bottom:10px;">
                    <span class="material-icons-round" style="color:#666;margin-right:5px;">search</span>
                    <input type="text" id="searchInput" placeholder="Cerca canto..." onkeyup="applyFilters()" style="border:none;background:transparent;outline:none;width:100%;font-size:1rem;">
                </div>
                <div class="filters-row" style="display:flex;gap:5px;overflow-x:auto;">
                    <select id="filterSeason" onchange="applyFilters()" style="padding:5px;border-radius:15px;border:1px solid #ddd;">
                        <option value="Tutti">Tutti</option><option value="Ordinario">Ordinario</option><option value="Avvento">Avvento</option><option value="Natale">Natale</option><option value="Quaresima">Quaresima</option><option value="Pasqua">Pasqua</option>
                    </select>
                    <div id="categoryChips" style="display:flex;gap:5px;"></div>
                </div>
            </header>
            <div id="songList" class="song-list-container" style="padding-top:10px;"></div>
            <button class="fab no-print" onclick="openAddMenu()" style="position:fixed;bottom:90px;right:20px;background:var(--primary);color:white;border:none;border-radius:50%;width:56px;height:56px;box-shadow:0 4px 10px rgba(0,0,0,0.3);cursor:pointer;display:flex;align-items:center;justify-content:center;"><span class="material-icons-round">add</span></button>
        </section>

        <section id="scaletta" class="view hidden">
            
            <header class="sticky-header no-print">
                <div class="header-left">
                    <input type="text" id="messaTitle" class="header-input" value="Santa Messa">
                    <div style="display:flex;gap:5px;align-items:center;">
                        <input type="date" id="messaDate" onchange="calcLiturgy()" class="header-date">
                        <span id="messaTypeDisplay" style="font-size:0.8rem;color:#777;"></span>
                    </div>
                </div>
                
                <div style="display:flex; gap:10px; align-items:center;">
                    <button onclick="saveSetlist()" class="btn-primary" style="font-size:0.8rem;">SALVA</button>
                    <div style="position:relative;">
                        <button onclick="toggleMenu()" class="menu-btn"><span class="material-icons-round">more_vert</span></button>
                        <div id="actionMenu" class="dropdown-menu">
                            
                            <div class="menu-group">
                                <div class="menu-label">Visualizza</div>
                                <button class="menu-item" onclick="toggleLayoutMode()"><span class="material-icons-round">view_sidebar</span> <span id="lblLayout">Affianca</span></button>
                                <button class="menu-item" onclick="switchToReadingMode()"><span class="material-icons-round">auto_stories</span> Modalit√† Lettura</button>
                            </div>

                            <div class="menu-group">
                                <div class="menu-label">Stampa</div>
                                <button class="menu-item" onclick="printMode('messa')"><span class="material-icons-round">queue_music</span> Solo Canti</button>
                                <button class="menu-item" onclick="printMode('letture')"><span class="material-icons-round">menu_book</span> Solo Letture</button>
                                <button class="menu-item" onclick="printMode('all')"><span class="material-icons-round">print</span> Tutto</button>
                            </div>

                            <div class="menu-group">
                                <div class="menu-label">Condividi</div>
                                <button class="menu-item" onclick="shareMode('messa')"><span class="material-icons-round">share</span> Scaletta Canti</button>
                                <button class="menu-item" onclick="shareMode('letture')"><span class="material-icons-round">share</span> Testo Letture</button>
                                <button class="menu-item" onclick="shareMode('all')"><span class="material-icons-round">share</span> Tutto</button>
                            </div>

                            <div class="menu-group">
                                <div class="menu-label">Gestione</div>
                                <button class="menu-item" onclick="toggleHistory()"><span class="material-icons-round">history</span> Storico</button>
                                <button class="menu-item" onclick="resetScaletta()" style="color:#d32f2f;"><span class="material-icons-round">delete_sweep</span> Pulisci Tutto</button>
                            </div>
                        </div>
                    </div>
                </div>
            </header>

            <div id="editContainer" class="workspace-grid single-view">
                
                <div class="col-box col-messa">
                    <div class="col-title">
                        <span>üéµ Canti</span>
                    </div>
                    <div class="scaletta-grid"></div>
                    <div style="margin-top:10px;"><span style="font-size:0.8rem;font-weight:bold;">Note:</span><div contenteditable="true" style="border-bottom:1px solid #ccc;padding:5px;"></div></div>
                </div>

                <div class="col-box col-readings">
                    <div class="col-title">
                        <span>üìñ Liturgia</span>
                        <div style="display:flex;gap:5px;">
                            <button onclick="autoFillReadings()" class="btn-outline" style="font-size:0.7rem;padding:4px 8px;">‚ú® Auto-Fetch</button>
                            <button onclick="openSmartReadings()" class="btn-outline" style="font-size:0.7rem;padding:4px 8px;">üåê Web</button>
                        </div>
                    </div>
                    
                    <div class="reading-field"><label>I LETTURA</label><textarea id="read1"></textarea></div>
                    <div class="reading-field"><label>SALMO</label><textarea id="readPsalm"></textarea></div>
                    <div class="reading-field"><label>II LETTURA</label><textarea id="read2"></textarea></div>
                    <div class="reading-field"><label>VANGELO</label><textarea id="readGospel"></textarea></div>
                </div>
            </div>

            <div id="readingContainer">
                <div class="reading-nav">
                    <button onclick="exitReadingMode()" style="border:none;background:none;font-weight:bold;color:#d32f2f;cursor:pointer;">‚Üê ESCI</button>
                    <div style="display:flex;gap:10px;">
                        <button onclick="switchReadingView('music')" id="btnReadMusic" style="font-weight:bold;color:var(--primary);border:none;background:none;">CANTI</button>
                        <button onclick="switchReadingView('word')" id="btnReadWord" style="color:#aaa;border:none;background:none;">LETTURE</button>
                    </div>
                    <div style="width:40px;"></div>
                </div>
                <div class="reading-body">
                    <div id="musicView" style="display:block;"></div>
                    <div id="readingsView" style="display:none; max-width:800px; margin:0 auto; font-size:1.2rem; line-height:1.6;"></div>
                </div>
            </div>

            <div id="historyPanel" class="side-panel hidden no-print" style="position:fixed;right:0;top:0;height:100%;width:250px;background:white;z-index:2500;box-shadow:-2px 0 10px rgba(0,0,0,0.1);padding:15px;overflow-y:auto;">
                <div style="display:flex;justify-content:space-between;margin-bottom:20px;"><h3>Storico</h3><button onclick="toggleHistory()" style="border:none;background:none;font-size:1.2rem;">√ó</button></div>
                <div id="historyList"></div>
            </div>
        </section>

        <div id="addMenu" class="modal hidden no-print"><div class="modal-card"><div class="modal-header"><h3>Gestione</h3><button onclick="closeAddMenu()" class="btn-icon">√ó</button></div><div class="modal-body"><input type="text" id="manualTitle" class="input-lg" placeholder="Titolo"><div class="row-inputs"><select id="newSongCategory" class="input-std"></select><select id="newSongSeason" class="input-std"><option value="Ordinario">Ordinario</option><option value="Avvento">Avvento</option><option value="Natale">Natale</option><option value="Quaresima">Quaresima</option><option value="Pasqua">Pasqua</option></select></div><div class="input-icon-wrapper"><span class="material-icons-round">link</span><input type="text" id="youtubeLink" class="input-std" placeholder="YouTube"></div><div class="tabs"><button class="tab-btn active" onclick="switchInputTab('file')">File</button><button class="tab-btn" onclick="switchInputTab('text')">Testo</button></div><div id="tab-file" class="tab-content"><div class="file-upload-area"><div id="previewContainer" class="preview-box hidden"><img id="previewImg" src=""><p id="previewText" class="hidden">PDF OK</p><button class="remove-preview" onclick="clearFileSelection()">√ó</button></div><div class="upload-buttons"><button id="btnDriveImport" onclick="initGoogleDriveImport()" class="btn-outline">Drive</button><label class="btn-outline">Galleria<input type="file" id="fileInput" accept="image/*,application/pdf" hidden onchange="handleLocalFile(this)"></label></div></div></div><div id="tab-text" class="tab-content hidden"><textarea id="textContent" class="lyrics-input"></textarea></div><input type="hidden" id="editId"></div><div class="modal-footer"><button onclick="saveSongData()" class="btn-block-primary">SALVA</button></div></div></div>
        <div id="viewSongModal" class="modal hidden no-print"><div class="modal-card full-screen"><div class="modal-header"><h3 id="viewSongTitle" style="flex:1;margin:0;">Titolo</h3><button onclick="editCurrentSong()" class="btn-icon">‚úé</button><button onclick="closeViewModal()" class="btn-icon" style="color:red">√ó</button></div><div class="modal-body" id="viewSongBody"></div></div></div>
        <section id="settings" class="view hidden"><header class="sticky-header"><div class="header-row"><button onclick="switchTab('library')" class="btn-icon">‚Üê</button><h1>Opzioni</h1></div></header><div class="settings-container"><div class="setting-card row-between"><span>Dark Mode</span><label class="switch"><input type="checkbox" id="darkModeCheck" onchange="toggleDarkMode()"><span class="slider round"></span></label></div><div class="setting-card"><h3>Chiavi Google</h3><input type="text" id="gApiKey" class="input-std" placeholder="API Key"><input type="text" id="gClientId" class="input-std" placeholder="Client ID"><button onclick="saveGoogleKeys()" class="btn-outline">Salva</button></div><div class="setting-card"><h3>Backup</h3><div class="row-inputs"><button onclick="exportData()" class="btn-outline">Scarica</button><button onclick="document.getElementById('importJson').click()" class="btn-outline">Carica</button></div><input type="file" id="importJson" hidden onchange="importData(this)"></div></div></section>
    </div>

    <script>
        let db; let tempDriveFile = null; let activeInputMode = 'file'; let currentCategoryFilter = 'Tutti'; let currentViewingId = null; 
        let customCategories = JSON.parse(localStorage.getItem('customCategories')) || [];
        const DEFAULT_PARTS = ['Ingresso', 'Gloria', 'Salmo', 'Alleluia', 'Offertorio', 'Santo', 'Comunione', 'Finale'];
        let ALL_CATEGORIES = [...new Set([...DEFAULT_PARTS, ...customCategories, 'Altro'])];
        const SYNC_FILENAME = "spartiti_messa_db_sync.json";

        const request = indexedDB.open("SpartitiMessaPro", 9);
        request.onupgradeneeded = (e) => { db = e.target.result; if(!db.objectStoreNames.contains("songs")) db.createObjectStore("songs", {keyPath:"id", autoIncrement:true}).createIndex("category","category",{unique:false}); if(!db.objectStoreNames.contains("setlists")) db.createObjectStore("setlists", {keyPath:"id", autoIncrement:true}); };
        request.onsuccess = (e) => { db = e.target.result; initApp(); };

        function initApp(){
            loadDarkMode(); renderCategoryChips(); loadLibrary(); buildScalettaUI(); updateCategoryDropdowns();
            document.getElementById('gApiKey').value = localStorage.getItem('g_api') || "";
            document.getElementById('gClientId').value = localStorage.getItem('g_client') || "";
            document.getElementById('messaDate').valueAsDate = new Date();
            calcLiturgy();
            
            // Chiudi menu se clicco fuori
            window.onclick = function(e) {
                if (!e.target.matches('.menu-btn') && !e.target.closest('.menu-btn')) {
                    document.getElementById("actionMenu").classList.remove('show');
                }
            }
        }

        // --- MENU LOGIC ---
        function toggleMenu() { document.getElementById("actionMenu").classList.toggle("show"); }
        
        // --- LAYOUT LOGIC ---
        function toggleLayoutMode() {
            const ws = document.getElementById('editContainer');
            const lbl = document.getElementById('lblLayout');
            if (ws.classList.contains('single-view')) {
                ws.classList.replace('single-view', 'split-view');
                document.querySelector('.col-readings').style.display = 'block';
                lbl.innerText = "Singola";
            } else {
                ws.classList.replace('split-view', 'single-view');
                document.querySelector('.col-readings').style.display = 'none';
                lbl.innerText = "Affianca";
            }
        }

        // --- MAGIC FETCH LETTURE ---
        async function autoFillReadings() {
            const dateVal = document.getElementById('messaDate').value;
            if(!dateVal) return showToast("Data mancante", "error");
            showToast("Ricerca...", "info");
            const d = new Date(dateVal);
            const targetUrl = `https://www.lachiesa.it/calendario/Detailed/${d.getFullYear()}${String(d.getMonth()+1).padStart(2,'0')}${String(d.getDate()).padStart(2,'0')}.shtml`;
            
            try {
                const response = await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent(targetUrl)}`);
                const data = await response.json();
                const doc = new DOMParser().parseFromString(data.contents, "text/html");
                const text = doc.body.innerText;
                
                const extract = (s, e) => { const i1=text.indexOf(s); if(i1<0)return ""; const i2=text.indexOf(e,i1); return i2<0?"":text.substring(i1+s.length, i2).trim(); };
                const clean = (t) => t.replace(/\s+/g,' ').substring(0,1500);

                let r1 = extract("Prima Lettura", "Salmo Responsoriale");
                let rPs = extract("Salmo Responsoriale", "Seconda Lettura");
                let r2 = extract("Seconda Lettura", "Vangelo");
                let rG = extract("Vangelo", "PREGHIERA DEI FEDELI");
                
                if(!r2 && !rG) { rPs = extract("Salmo Responsoriale", "Vangelo"); rG = extract("Vangelo", "PREGHIERA DEI FEDELI"); } // Feriale

                document.getElementById('read1').value = clean(r1);
                document.getElementById('readPsalm').value = clean(rPs);
                document.getElementById('read2').value = clean(r2);
                document.getElementById('readGospel').value = clean(rG);
                showToast("Fatto!");
            } catch(e) { showToast("Errore. Usa tasto Web.", "error"); window.open(targetUrl,'_blank'); }
        }

        function openSmartReadings() {
            const d = new Date(document.getElementById('messaDate').value);
            window.open(`https://www.lachiesa.it/calendario/Detailed/${d.getFullYear()}${String(d.getMonth()+1).padStart(2,'0')}${String(d.getDate()).padStart(2,'0')}.shtml`, '_blank');
        }

        // --- CALCOLO TEMPO LITURGICO ---
        function calcLiturgy() {
            const d = new Date(document.getElementById('messaDate').value);
            const y = d.getFullYear();
            // Algoritmo semplificato per visualizzazione
            document.getElementById('messaTypeDisplay').innerText = `Anno ${['C','A','B'][y%3]}`;
        }

        // --- STAMPA & CONDIVISIONE ---
        function printMode(mode) {
            document.body.className = ''; 
            if(mode==='messa') document.body.classList.add('print-messa');
            if(mode==='letture') document.body.classList.add('print-letture');
            window.print(); setTimeout(()=>document.body.className='',500);
        }
        function shareMode(mode) {
            const t = document.getElementById('messaTitle').value; const d = document.getElementById('messaDate').value;
            let txt = `üìÖ *${t}* - ${d}\n\n`;
            if(mode!=='letture') {
                txt+="üéµ *CANTI:*\n";
                document.querySelectorAll('.slot-container').forEach(sl=>{ const s=sl.querySelector('select'); if(s&&s.selectedIndex>0) txt+=`- ${sl.dataset.part}: ${s.options[s.selectedIndex].text}\n`; });
            }
            if(mode!=='messa') {
                txt+="\nüìñ *LETTURE:*\n";
                if(document.getElementById('read1').value) txt+="I Lettura: (Vedi app)\n";
                if(document.getElementById('readGospel').value) txt+="Vangelo: (Vedi app)\n";
            }
            window.open(`https://wa.me/?text=${encodeURIComponent(txt)}`, '_blank');
        }

        // --- CORE FUNCTIONS ---
        function showToast(m,t=""){const x=document.getElementById("toast");x.innerText=m;x.className="show "+t;setTimeout(()=>x.className=x.className.replace("show",""),3000);}
        function switchTab(id){ document.querySelectorAll('.view').forEach(v=>v.classList.add('hidden')); document.getElementById(id).classList.remove('hidden'); document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active')); document.getElementById('btn-'+id).classList.add('active'); if(id==='library')loadLibrary(); }
        
        // CANTI & DB
        function saveSongData(){const t=document.getElementById('manualTitle').value.trim();if(!t)return alert("Titolo!");const s={title:t,category:document.getElementById('newSongCategory').value,season:document.getElementById('newSongSeason').value,youtubeUrl:document.getElementById('youtubeLink').value,date:new Date(),lyrics:activeInputMode==='text'?document.getElementById('textContent').value:null,fileData:activeInputMode==='file'&&tempDriveFile?tempDriveFile.data:null,type:activeInputMode==='file'&&tempDriveFile?tempDriveFile.type:'text/plain'}; const id=document.getElementById('editId').value; if(id)s.id=Number(id); const tx=db.transaction(["songs"],"readwrite"); tx.onabort=()=>alert("File>15MB"); tx.objectStore("songs").put(s).onsuccess=()=>{closeAddMenu();loadLibrary();showToast("Salvato!");};}
        function loadLibrary(){const l=document.getElementById('songList');l.innerHTML="";db.transaction(["songs"]).objectStore("songs").openCursor().onsuccess=(e)=>{const c=e.target.result;if(c){const s=c.value;l.innerHTML+=`<div style="background:white;padding:10px;border-radius:8px;margin-bottom:10px;display:flex;align-items:center;justify-content:space-between;box-shadow:0 1px 3px rgba(0,0,0,0.1);" onclick="openViewModal(${s.id})"><div style="font-weight:bold;">${s.title}</div><div style="font-size:0.8rem;color:#777;">${s.category}</div></div>`;c.continue();}}}
        
        // SCALETTA LOGIC
        function buildScalettaUI() { const g = document.querySelector('.scaletta-grid'); if(g.children.length === 0) DEFAULT_PARTS.forEach(p => { const d = document.createElement('div'); d.className = 'slot-container'; d.dataset.part = p; d.innerHTML = `<div style="font-size:0.8rem;font-weight:bold;color:#666;margin-bottom:3px;">${p} <button onclick="addSelector('${p}')" style="border:none;background:#eee;border-radius:4px;cursor:pointer;">+</button></div><div class="selectors-list" id="list-${p}"></div>`; g.appendChild(d); addSelector(p); }); }
        function addSelector(p, id=null){ const c = document.getElementById(`list-${p}`); const r = document.createElement('div'); r.className='selector-row'; r.innerHTML = `<select class="song-selector header-input" style="text-align:left;font-weight:normal;font-size:0.9rem;"><option value="">Seleziona...</option></select><button class="btn-del-slot" onclick="removeSelector(this)">√ó</button>`; c.appendChild(r); populateSingleSelect(r.querySelector('select'), id); }
        function removeSelector(b){ const r = b.parentElement; if(r.parentElement.children.length > 1) r.remove(); else { r.querySelector('select').value = ""; } }
        function populateSingleSelect(s, id){ s.innerHTML='<option value="">...</option>'; db.transaction(["songs"]).objectStore("songs").openCursor().onsuccess=(e)=>{const c=e.target.result;if(c){const o=document.createElement('option');o.value=c.key;o.text=c.value.title;if(c.key==id)o.selected=true;s.appendChild(o);c.continue();}} }
        
        function saveSetlist(){
            const t=document.getElementById('messaTitle').value; const d=document.getElementById('messaDate').value; 
            const sel={}; document.querySelectorAll('.slot-container').forEach(sl=>{const ids=[]; sl.querySelectorAll('select').forEach(s=>{if(s.value)ids.push(s.value)}); sel[sl.dataset.part]=ids;});
            const r={r1:document.getElementById('read1').value, rps:document.getElementById('readPsalm').value, r2:document.getElementById('read2').value, rg:document.getElementById('readGospel').value};
            db.transaction(["setlists"],"readwrite").objectStore("setlists").add({title:t,dateStr:d,selections:sel,readings:r}).oncomplete=()=>showToast("Messa Salvata!");
        }
        function loadSetlist(id){
            db.transaction(["setlists"]).objectStore("setlists").get(id).onsuccess=(e)=>{
                const r=e.target.result; document.getElementById('messaTitle').value=r.title; document.getElementById('messaDate').value=r.dateStr;
                if(r.readings){document.getElementById('read1').value=r.readings.r1;document.getElementById('readPsalm').value=r.readings.rps;document.getElementById('read2').value=r.readings.r2;document.getElementById('readGospel').value=r.readings.rg;}
                document.querySelectorAll('.selectors-list').forEach(l=>l.innerHTML="");
                for(const[p,ids] of Object.entries(r.selections)){if(!ids.length)addSelector(p);else ids.forEach(i=>addSelector(p,i));}
                toggleHistory(); switchToReadingMode();
            }
        }
        
        // READING MODE
        function switchToReadingMode() {
            document.body.classList.add('reading-active');
            document.getElementById('editContainer').style.display = 'none';
            document.getElementById('readingContainer').style.display = 'block';
            renderScores(); renderReadingsText();
        }
        function exitReadingMode() {
            document.body.classList.remove('reading-active');
            document.getElementById('editContainer').style.display = 'grid';
            document.getElementById('readingContainer').style.display = 'none';
        }
        function switchReadingView(v) {
            document.getElementById('btnReadMusic').style.color=v==='music'?'var(--primary)':'#aaa';
            document.getElementById('btnReadWord').style.color=v==='word'?'var(--primary)':'#aaa';
            document.getElementById('musicView').style.display=v==='music'?'block':'none';
            document.getElementById('readingsView').style.display=v==='word'?'block':'none';
        }
        
        function renderScores(){
            const c=document.getElementById('musicView');c.innerHTML="";
            document.querySelectorAll('.song-selector').forEach(sel=>{
                if(!sel.value)return; const part=sel.closest('.slot-container').dataset.part;
                db.transaction(["songs"]).objectStore("songs").get(Number(sel.value)).onsuccess=(e)=>{
                    const s=e.target.result; if(!s)return;
                    const d=document.createElement('div'); d.className='score-sequence-item';
                    let h=""; if(s.lyrics)h=`<pre style="padding:15px;white-space:pre-wrap;">${s.lyrics}</pre>`; else if(s.type.includes('pdf'))h=`<div style="position:relative"><iframe src="${s.fileData}" class="pdf-frame"></iframe><button onclick="openFullscreen('${s.fileData}')" style="position:absolute;top:10px;right:10px;background:#333;color:white;border:none;padding:5px;">FULL</button></div>`; else h=`<img src="${s.fileData}">`;
                    d.innerHTML=`<div class="score-header"><h3>${s.title}</h3><span>${part}</span></div>${h}`;
                    c.appendChild(d);
                }
            });
        }
        function renderReadingsText(){
            const c=document.getElementById('readingsView');c.innerHTML="";
            const txt=[{t:"I Lettura",v:document.getElementById('read1').value},{t:"Salmo",v:document.getElementById('readPsalm').value},{t:"II Lettura",v:document.getElementById('read2').value},{t:"Vangelo",v:document.getElementById('readGospel').value}];
            txt.forEach(x=>{if(x.v.trim())c.innerHTML+=`<div style="margin-bottom:20px;padding:15px;background:white;border-radius:8px;"><h3 style="color:#d32f2f;border-bottom:1px solid #eee;">${x.t}</h3><p style="white-space:pre-wrap;">${x.v}</p></div>`;});
        }

        // FULLSCREEN
        function openFullscreen(u){const m=document.getElementById('fsModal');document.getElementById('fsFrame').src=u;m.classList.remove('hidden');}
        function closeFullscreen(){document.getElementById('fsModal').classList.add('hidden');document.getElementById('fsFrame').src="";}

        // GOOGLE & DRIVE
        let tokenClient; let gapiInited=false; let gisInited=false;
        function getKeys(){return{k:localStorage.getItem('g_api')||document.getElementById('gApiKey').value,c:localStorage.getItem('g_client')||document.getElementById('gClientId').value};}
        function saveGoogleKeys(){const{k,c}=getKeys();if(k&&c){localStorage.setItem('g_api',k);localStorage.setItem('g_client',c);showToast("Salvate!");}else showToast("Inserisci chiavi","error");}
        async function ensureGoogleReady(btn=null){
            const{k,c}=getKeys();if(!k||!c){showToast("Mancano API Key","error");switchTab('settings');return false;}
            let old="";if(btn){old=btn.innerHTML;btn.innerText="...";btn.disabled=true;}
            try{
                if(!gapiInited){await new Promise((r,j)=>{gapi.load('client:picker',async()=>{try{await gapi.client.init({apiKey:k,discoveryDocs:["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"]});gapiInited=true;r();}catch(e){j(e);}});});}
                if(!gisInited){await new Promise((r,j)=>{try{tokenClient=google.accounts.oauth2.initTokenClient({client_id:c,scope:'https://www.googleapis.com/auth/drive.readonly https://www.googleapis.com/auth/drive.file',callback:''});gisInited=true;r();}catch(e){j(e);}});});}
                return true;
            }catch(e){showToast("Err Google","error");return false;}finally{if(btn){btn.innerHTML=old;btn.disabled=false;}}
        }
        function initGoogleDriveImport(){const btn=document.getElementById('btnDriveImport');ensureGoogleReady(btn).then(r=>{if(r){tokenClient.callback=(resp)=>{if(!resp.error)createPicker(resp.access_token);};tokenClient.requestAccessToken({prompt:''});}});}
        function createPicker(t){try{const{k}=getKeys();const v=new google.picker.DocsView(google.picker.ViewId.DOCS).setIncludeFolders(true).setMimeTypes("image/png,image/jpeg,application/pdf,application/vnd.google-apps.folder");new google.picker.PickerBuilder().setDeveloperKey(k).setOAuthToken(t).addView(v).setCallback(pickerCallback).setTitle("File").build().setVisible(true);}catch(e){alert(e);}}
        async function pickerCallback(d){
            if(d.action===google.picker.Action.PICKED){
                const doc=d.docs[0];if(doc.mimeType.includes('folder'))return;
                document.getElementById('manualTitle').value=doc.name.replace(/\.[^/.]+$/,"");
                const st=document.getElementById('driveStatus');st.classList.remove('hidden');st.innerText="Download...";
                try{
                    const t=gapi.client.getToken().access_token;
                    const r=await fetch(`https://www.googleapis.com/drive/v3/files/${doc.id}?alt=media`,{headers:{'Authorization':`Bearer ${t}`}});
                    if(!r.ok)throw new Error(r.status);
                    const b=await r.blob();
                    const fr=new FileReader();
                    fr.onload=(e)=>{tempDriveFile={data:e.target.result,type:doc.mimeType};st.innerText="OK ‚úÖ";if(doc.mimeType.includes('pdf')){document.getElementById('previewImg').src="";document.getElementById('previewText').classList.remove('hidden');}else{document.getElementById('previewImg').src=e.target.result;document.getElementById('previewText').classList.add('hidden');}document.getElementById('previewContainer').classList.remove('hidden');};fr.readAsDataURL(b);
                }catch(e){st.innerText="Errore";showToast("Download fallito","error");}
            }
        }
        // UTILS
        function switchInputTab(m){ activeInputMode=m; document.getElementById('tab-file').className=m==='file'?'tab-content':'hidden'; document.getElementById('tab-text').className=m==='text'?'tab-content':'hidden'; }
        function handleLocalFile(i){ const f=i.files[0]; const r=new FileReader(); r.onload=e=>{tempDriveFile={data:e.target.result,type:f.type}; document.getElementById('previewText').classList.remove('hidden');}; r.readAsDataURL(f); }
        function toggleHistory(){ const p=document.getElementById('historyPanel'); const l=document.getElementById('historyList'); if(p.classList.contains('hidden')){p.classList.remove('hidden'); l.innerHTML=""; const tx=db.transaction(["setlists"],"readonly").objectStore("setlists"); tx.openCursor(null,'prev').onsuccess=(e)=>{const c=e.target.result; if(c){const x=c.value; l.innerHTML+=`<div style="padding:10px;border-bottom:1px solid #eee;cursor:pointer;" onclick="loadSetlist(${x.id})"><b>${x.title}</b><br>${x.dateStr}</div>`; c.continue();}} }else p.classList.add('hidden'); }
        function toggleDarkMode(){ document.body.classList.toggle('dark-mode'); }
        function loadDarkMode(){}
        function renderCategoryChips(){}
        function updateCategoryDropdowns(){}
        function openAddMenu(){ document.getElementById('addMenu').classList.remove('hidden'); }
        function closeAddMenu(){ document.getElementById('addMenu').classList.add('hidden'); }
        function openViewModal(id){ currentViewingId=id; db.transaction(["songs"]).objectStore("songs").get(id).onsuccess=(e)=>{const s=e.target.result; document.getElementById('viewSongTitle').innerText=s.title; const b=document.getElementById('viewSongBody'); if(s.lyrics)b.innerHTML=`<pre>${s.lyrics}</pre>`; else if(s.fileData) b.innerHTML=`<img src="${s.fileData}" style="width:100%">`; document.getElementById('viewSongModal').classList.remove('hidden'); }}
        async function syncToCloud() { const btn = document.getElementById('btnSyncUp'); const ready = await ensureGoogleReady(btn); if(!ready) return; tokenClient.callback = async (resp) => { if (resp.error) return showToast("Errore Auth", "error"); await performUpload(); }; tokenClient.requestAccessToken({prompt: ''}); }
        async function performUpload() { showToast("Backup..."); const exp={songs:[],setlists:[],customCategories:customCategories}; const tx=db.transaction(["songs","setlists"],"readonly"); exp.songs = await new Promise(r=>tx.objectStore("songs").getAll().onsuccess=e=>r(e.target.result)); exp.setlists = await new Promise(r=>tx.objectStore("setlists").getAll().onsuccess=e=>r(e.target.result)); const fileContent = JSON.stringify(exp); const metadata = {'name': SYNC_FILENAME, 'mimeType': 'application/json'}; try { const q = `name = '${SYNC_FILENAME}' and trashed = false`; const search = await gapi.client.drive.files.list({q:q, fields:'files(id)'}); const files = search.result.files; if(files && files.length > 0) { await fetch('https://www.googleapis.com/upload/drive/v3/files/'+files[0].id+'?uploadType=media', {method:'PATCH', headers:{Authorization:'Bearer '+gapi.client.getToken().access_token, 'Content-Type':'application/json'}, body:fileContent}); } else { const form = new FormData(); form.append('metadata', new Blob([JSON.stringify(metadata)], {type:'application/json'})); form.append('file', new Blob([fileContent], {type:'application/json'})); await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {method:'POST', headers:{Authorization:'Bearer '+gapi.client.getToken().access_token}, body:form}); } showToast("Fatto!"); } catch(e){ showToast("Errore Sync", "error"); } }
        async function syncFromCloud() { if(!confirm("Sovrascrivere?")) return; const btn = document.getElementById('btnSyncDown'); const ready = await ensureGoogleReady(btn); if(!ready) return; tokenClient.callback = async (resp) => { if (resp.error) return showToast("Errore Auth", "error"); await performDownload(); }; tokenClient.requestAccessToken({prompt: ''}); }
        async function performDownload(){ try { showToast("Certo backup..."); const q = `name = '${SYNC_FILENAME}' and trashed = false`; const search = await gapi.client.drive.files.list({q:q, fields:'files(id)'}); if(!search.result.files.length) return showToast("Nessun backup", "error"); showToast("Scarico..."); const res = await gapi.client.drive.files.get({fileId:search.result.files[0].id, alt:'media'}); const data = res.result; const tx = db.transaction(["songs","setlists"],"readwrite"); await new Promise(r=>tx.objectStore("songs").clear().onsuccess=r); await new Promise(r=>tx.objectStore("setlists").clear().onsuccess=r); if(data.songs) data.songs.forEach(s=>tx.objectStore("songs").put(s)); if(data.setlists) data.setlists.forEach(s=>tx.objectStore("setlists").put(s)); tx.oncomplete = () => { showToast("Ripristinato!"); loadLibrary(); }; } catch(e){ showToast("Errore Download", "error"); } }
        function exportData(){ const exp = {songs:[], setlists:[]}; const tx = db.transaction(["songs","setlists"],"readonly"); tx.objectStore("songs").getAll().onsuccess = e => { exp.songs = e.target.result; tx.objectStore("setlists").getAll().onsuccess = e2 => { exp.setlists = e2.target.result; const a = document.createElement("a"); a.href = URL.createObjectURL(new Blob([JSON.stringify(exp)],{type:'application/json'})); a.download = "backup_spartiti.json"; a.click(); } }; }
        function importData(i){ const f = i.files[0]; if(!f) return; const r = new FileReader(); r.onload = e => { const d = JSON.parse(e.target.result); const tx = db.transaction(["songs","setlists"],"readwrite"); if(d.songs) d.songs.forEach(s => tx.objectStore("songs").put(s)); if(d.setlists) d.setlists.forEach(s => tx.objectStore("setlists").put(s)); tx.oncomplete = () => { showToast("Ripristinato!"); loadLibrary(); }; }; r.readAsText(f); }
        if('serviceWorker' in navigator) navigator.serviceWorker.register('./sw.js');
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => { e.preventDefault(); deferredPrompt = e; document.getElementById('installContainer').classList.remove('hidden'); });
        document.getElementById('btnInstall')?.addEventListener('click', async () => { if(deferredPrompt){ deferredPrompt.prompt(); const {outcome} = await deferredPrompt.userChoice; if(outcome === 'accepted') document.getElementById('installContainer').classList.add('hidden'); deferredPrompt = null; } });
        const isIos = () => /iphone|ipad|ipod/.test(window.navigator.userAgent.toLowerCase());
        const isInStandaloneMode = () => ('standalone' in window.navigator) || (window.matchMedia('(display-mode: standalone)').matches);
        window.addEventListener('load', () => { if(!isInStandaloneMode() && isIos()) document.getElementById('iosInstallMessage').classList.remove('hidden'); });
        function closeIosPrompt(){ document.getElementById('iosInstallMessage').classList.add('hidden'); }
    </script>
</body>
</html>
