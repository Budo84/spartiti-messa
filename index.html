<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Spartiti Messa Pro</title>
    
    <link rel="stylesheet" href="style.css">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="logo192.png">
    <meta name="theme-color" content="#673ab7">
    
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client"></script>
    
    <style>
        /* --- STILI GENERALI --- */
        :root { --primary: #673ab7; --bg: #f0f2f5; --surface: #ffffff; }
        body { font-family: 'Segoe UI', Roboto, sans-serif; background: var(--bg); margin: 0; padding-bottom: 80px; color: #333; }
        
        /* LAYOUT RESPONSIVE */
        .container { max-width: 1200px; margin: 0 auto; min-height: 100vh; position: relative; }
        @media (min-width: 800px) { .container { padding: 20px; } .view { background: var(--surface); border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); padding: 20px; } }

        /* HEADER */
        .sticky-header { background: var(--surface); padding: 15px; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .header-grid { display: grid; grid-template-columns: 1fr auto; gap: 15px; align-items: center; }
        .header-input { width: 100%; border: 1px solid #ddd; background: #f9f9f9; font-size: 1rem; padding: 8px; border-radius: 8px; }
        .date-row { display: flex; gap: 10px; margin-top: 5px; align-items: center; }

        /* SPLIT VIEW SYSTEM */
        .workspace-grid { display: grid; gap: 20px; margin-top: 20px; }
        /* Default: Single View (Mobile style) */
        .workspace-grid.single-view { grid-template-columns: 1fr; }
        .workspace-grid.single-view .col-readings { display: none; } /* Nasconde letture in single */
        /* Split View (Desktop style) */
        .workspace-grid.split-view { grid-template-columns: 1fr 1fr; }
        @media (max-width: 800px) { .workspace-grid.split-view { grid-template-columns: 1fr; } } /* Force stack on mobile */

        /* COLONNE */
        .col-box { background: #fff; border: 1px solid #e0e0e0; border-radius: 8px; padding: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.02); }
        .col-title { font-size: 1.1rem; font-weight: bold; color: var(--primary); margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #f0f0f0; padding-bottom: 8px; }

        /* TEXTAREAS LETTURE */
        .reading-field { margin-bottom: 15px; }
        .reading-field label { display: block; font-size: 0.85rem; font-weight: bold; color: #666; margin-bottom: 5px; }
        .reading-field textarea { width: 100%; height: 120px; padding: 10px; border: 1px solid #ccc; border-radius: 6px; font-family: inherit; resize: vertical; background: #fafafa; }
        .reading-field textarea:focus { background: #fff; outline: 2px solid var(--primary); }

        /* ACTION BUTTONS */
        .btn-compact { background: #eee; border: none; border-radius: 6px; padding: 6px 12px; font-size: 0.9rem; font-weight: 600; cursor: pointer; display: inline-flex; align-items: center; gap: 5px; color: #555; transition: 0.2s; }
        .btn-compact:hover { background: #e0e0e0; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-action-row { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 10px; }

        /* MODALITA LETTURA */
        body.reading-active .sticky-header, body.reading-active .bottom-nav { display: none !important; }
        body.reading-active .container { max-width: 100%; padding: 0; }
        
        .reading-nav { position: fixed; top: 0; left: 0; width: 100%; height: 60px; background: white; border-bottom: 1px solid #ddd; z-index: 1000; display: flex; align-items: center; justify-content: space-between; padding: 0 15px; box-sizing: border-box; }
        .reading-body { margin-top: 60px; padding: 20px; height: calc(100vh - 60px); overflow-y: auto; display: grid; gap: 30px; }
        .reading-body.split { grid-template-columns: 1fr 1fr; }

        /* STAMPA */
        @media print {
            .no-print, .bottom-nav, .sticky-header, .fab-actions { display: none !important; }
            .container { max-width: 100%; padding: 0; margin: 0; }
            .col-box { border: none; box-shadow: none; padding: 0; }
            /* Classi per stampa selettiva */
            body.print-messa .col-readings { display: none; }
            body.print-letture .col-messa { display: none; }
            body.print-letture .col-readings { display: block !important; }
            .workspace-grid { display: block; }
        }

        /* UTILS */
        .hidden { display: none; }
        #toast { visibility: hidden; min-width: 250px; background: #333; color: #fff; text-align: center; border-radius: 50px; padding: 14px; position: fixed; z-index: 3000; left: 50%; transform: translateX(-50%); bottom: 30px; opacity: 0; transition: 0.3s; }
        #toast.show { visibility: visible; opacity: 1; bottom: 40px; }
    </style>
</head>
<body>

    <div id="toast"><span id="toastMsg"></span></div>

    <nav class="bottom-nav no-print">
        <button onclick="switchTab('library')" class="nav-btn active" id="btn-library"><span class="material-icons-round">library_music</span><span>Repertorio</span></button>
        <button onclick="switchTab('scaletta')" class="nav-btn" id="btn-scaletta"><span class="material-icons-round">playlist_play</span><span>Messa</span></button>
        <button onclick="switchTab('settings')" class="nav-btn" id="btn-settings"><span class="material-icons-round">settings</span><span>Opzioni</span></button>
    </nav>

    <div class="container">
        
        <section id="library" class="view active">
            <header class="sticky-header no-print">
                <div class="search-bar-container"><span class="material-icons-round search-icon">search</span><input type="text" id="searchInput" placeholder="Cerca canto..." onkeyup="applyFilters()"></div>
                <div class="filters-row">
                    <select id="filterSeason" onchange="applyFilters()" class="filter-dropdown">
                        <option value="Tutti">Tutti</option><option value="Ordinario">Ordinario</option><option value="Avvento">Avvento</option><option value="Natale">Natale</option><option value="Quaresima">Quaresima</option><option value="Pasqua">Pasqua</option>
                    </select>
                </div>
                <div class="filter-chips-scroll" id="categoryChips"></div>
            </header>
            <div id="songList" class="song-list-container"></div>
            <button class="fab no-print" onclick="openAddMenu()"><span class="material-icons-round">add</span></button>
        </section>

        <section id="scaletta" class="view hidden">
            
            <header class="sticky-header no-print">
                <div class="header-grid">
                    <div>
                        <input type="text" id="messaTitle" class="header-input" style="font-weight:bold;font-size:1.2rem;color:var(--primary);" value="Santa Messa">
                        <div class="date-row">
                            <input type="date" id="messaDate" onchange="calcLiturgy()" class="header-input" style="width:140px;">
                            <input type="text" id="messaType" class="header-input" placeholder="Tempo Liturgico" readonly style="background:#eee;">
                        </div>
                    </div>
                    <div style="text-align:right;">
                        <button onclick="toggleLayoutMode()" class="btn-compact primary" id="btnLayoutToggle">
                            <span class="material-icons-round">view_sidebar</span> Affianca
                        </button>
                        <div style="margin-top:5px;">
                            <button onclick="toggleHistory()" class="btn-compact"><span class="material-icons-round">history</span> Storico</button>
                            <button onclick="saveSetlist()" class="btn-compact primary"><span class="material-icons-round">save</span></button>
                        </div>
                    </div>
                </div>
                
                <div class="btn-action-row no-print" style="justify-content:center; border-top:1px solid #eee; padding-top:10px; margin-top:10px;">
                    <div style="display:flex; gap:5px; align-items:center; background:#f5f5f5; padding:5px; border-radius:8px;">
                        <span class="material-icons-round" style="font-size:18px;color:#666">print</span>
                        <button onclick="printMode('messa')" class="btn-compact">Messa</button>
                        <button onclick="printMode('letture')" class="btn-compact">Letture</button>
                        <button onclick="printMode('all')" class="btn-compact">Tutto</button>
                    </div>
                    <div style="display:flex; gap:5px; align-items:center; background:#e8f5e9; padding:5px; border-radius:8px;">
                        <span class="material-icons-round" style="font-size:18px;color:#2e7d32">share</span>
                        <button onclick="shareMode('messa')" class="btn-compact" style="color:#2e7d32">Messa</button>
                        <button onclick="shareMode('letture')" class="btn-compact" style="color:#2e7d32">Letture</button>
                        <button onclick="shareMode('all')" class="btn-compact" style="color:#2e7d32">Tutto</button>
                    </div>
                </div>
            </header>

            <div id="workspace" class="workspace-grid single-view">
                
                <div class="col-box col-messa">
                    <div class="col-title">
                        <span>üéµ Scaletta Canti</span>
                        <button onclick="resetScaletta()" class="btn-compact" style="color:red;font-size:0.8rem;">Reset</button>
                    </div>
                    <div class="scaletta-grid"></div>
                    <div class="notes-area"><span class="notes-label">Note:</span><div contenteditable="true" class="note-line"></div></div>
                </div>

                <div class="col-box col-readings">
                    <div class="col-title">
                        <span>üìñ Liturgia</span>
                        <div style="display:flex; gap:5px;">
                            <button onclick="autoFillReadings()" class="btn-compact primary" title="Cerca su internet e inserisci">
                                <span class="material-icons-round">auto_fix_high</span> Auto
                            </button>
                            <button onclick="openSmartReadings()" class="btn-compact" title="Apri sito">
                                <span class="material-icons-round">public</span> Web
                            </button>
                        </div>
                    </div>
                    
                    <div class="reading-field">
                        <label>I LETTURA</label>
                        <textarea id="read1" placeholder="..."></textarea>
                    </div>
                    <div class="reading-field">
                        <label>SALMO RESPONSORIALE</label>
                        <textarea id="readPsalm" placeholder="..."></textarea>
                    </div>
                    <div class="reading-field">
                        <label>II LETTURA</label>
                        <textarea id="read2" placeholder="..."></textarea>
                    </div>
                    <div class="reading-field">
                        <label>VANGELO</label>
                        <textarea id="readGospel" placeholder="..."></textarea>
                    </div>
                </div>

            </div>

            <div id="historyPanel" class="side-panel hidden no-print">
                <div class="panel-header"><h3>Storico</h3><button onclick="toggleHistory()" class="btn-icon"><span class="material-icons-round">close</span></button></div>
                <div id="historyList" class="history-list"></div>
            </div>
        </section>

        <div id="addMenu" class="modal hidden no-print"><div class="modal-card"><div class="modal-header"><h3>Gestione</h3><button onclick="closeAddMenu()" class="btn-icon">√ó</button></div><div class="modal-body"><input type="text" id="manualTitle" class="input-lg" placeholder="Titolo"><div class="row-inputs"><select id="newSongCategory" class="input-std"></select><select id="newSongSeason" class="input-std"><option value="Ordinario">Ordinario</option><option value="Avvento">Avvento</option><option value="Natale">Natale</option><option value="Quaresima">Quaresima</option><option value="Pasqua">Pasqua</option></select></div><div class="input-icon-wrapper"><span class="material-icons-round">link</span><input type="text" id="youtubeLink" class="input-std" placeholder="YouTube"></div><div class="tabs"><button class="tab-btn active" onclick="switchInputTab('file')">File</button><button class="tab-btn" onclick="switchInputTab('text')">Testo</button></div><div id="tab-file" class="tab-content"><div class="file-upload-area"><div id="previewContainer" class="preview-box hidden"><img id="previewImg" src=""><p id="previewText" class="hidden">PDF OK</p><button class="remove-preview" onclick="clearFileSelection()">√ó</button></div><div class="upload-buttons"><button id="btnDriveImport" onclick="initGoogleDriveImport()" class="btn-outline">Drive</button><label class="btn-outline">Galleria<input type="file" id="fileInput" accept="image/*,application/pdf" hidden onchange="handleLocalFile(this)"></label></div></div></div><div id="tab-text" class="tab-content hidden"><textarea id="textContent" class="lyrics-input"></textarea></div><input type="hidden" id="editId"></div><div class="modal-footer"><button onclick="saveSongData()" class="btn-block-primary">SALVA</button></div></div></div>
        <section id="settings" class="view hidden"><header class="sticky-header"><div class="header-row"><button onclick="switchTab('library')" class="btn-icon">‚Üê</button><h1>Opzioni</h1></div></header><div class="settings-container"><div class="setting-card row-between"><span>Dark Mode</span><label class="switch"><input type="checkbox" id="darkModeCheck" onchange="toggleDarkMode()"><span class="slider round"></span></label></div><div class="setting-card"><h3>Chiavi Google</h3><input type="text" id="gApiKey" class="input-std" placeholder="API Key"><input type="text" id="gClientId" class="input-std" placeholder="Client ID"><button onclick="saveGoogleKeys()" class="btn-outline">Salva</button></div><div class="setting-card"><h3>Backup</h3><div class="row-inputs"><button onclick="exportData()" class="btn-outline">Scarica</button><button onclick="document.getElementById('importJson').click()" class="btn-outline">Carica</button></div><input type="file" id="importJson" hidden onchange="importData(this)"></div></div></section>
        
        <div id="viewSongModal" class="modal hidden no-print"><div class="modal-card full-screen"><div class="modal-header"><h3 id="viewSongTitle" style="flex:1;margin:0;">Titolo</h3><button onclick="editCurrentSong()" class="btn-icon">‚úé</button><button onclick="closeViewModal()" class="btn-icon" style="color:red">√ó</button></div><div class="modal-body" id="viewSongBody"></div></div></div>
    </div>

    <script>
        let db; let tempDriveFile = null; let activeInputMode = 'file'; let currentCategoryFilter = 'Tutti'; let currentViewingId = null; 
        let customCategories = JSON.parse(localStorage.getItem('customCategories')) || [];
        const DEFAULT_PARTS = ['Ingresso', 'Gloria', 'Salmo', 'Alleluia', 'Offertorio', 'Santo', 'Comunione', 'Finale'];
        let ALL_CATEGORIES = [...new Set([...DEFAULT_PARTS, ...customCategories, 'Altro'])];

        // INIT
        const request = indexedDB.open("SpartitiMessaPro", 8);
        request.onupgradeneeded = (e) => { db = e.target.result; if(!db.objectStoreNames.contains("songs")) db.createObjectStore("songs", {keyPath:"id", autoIncrement:true}).createIndex("category","category",{unique:false}); if(!db.objectStoreNames.contains("setlists")) db.createObjectStore("setlists", {keyPath:"id", autoIncrement:true}); };
        request.onsuccess = (e) => { db = e.target.result; initApp(); };
        
        function initApp(){
            loadDarkMode(); loadLibrary(); buildScalettaUI(); updateCategoryDropdowns();
            document.getElementById('gApiKey').value = localStorage.getItem('g_api') || "";
            document.getElementById('gClientId').value = localStorage.getItem('g_client') || "";
            document.getElementById('messaDate').valueAsDate = new Date();
            calcLiturgy();
        }

        // --- LAYOUT & SPLIT VIEW ---
        function toggleLayoutMode() {
            const ws = document.getElementById('workspace');
            const btn = document.getElementById('btnLayoutToggle');
            const colReads = document.querySelector('.col-readings');
            
            if (ws.classList.contains('single-view')) {
                ws.classList.replace('single-view', 'split-view');
                colReads.style.display = 'block'; // Mostra letture in split
                btn.innerHTML = '<span class="material-icons-round">crop_square</span> Singola';
            } else {
                ws.classList.replace('split-view', 'single-view');
                colReads.style.display = 'none'; // Nascondi in single
                btn.innerHTML = '<span class="material-icons-round">view_sidebar</span> Affianca';
            }
        }

        // --- MAGIC FETCH LETTURE (PROXY) ---
        async function autoFillReadings() {
            const dateVal = document.getElementById('messaDate').value;
            if(!dateVal) return showToast("Data mancante", "error");
            
            showToast("Ricerca letture in corso...", "info");
            
            // Calcola URL Lachiesa.it
            const d = new Date(dateVal);
            const y = d.getFullYear();
            const m = String(d.getMonth()+1).padStart(2,'0');
            const day = String(d.getDate()).padStart(2,'0');
            const targetUrl = `https://www.lachiesa.it/calendario/Detailed/${y}${m}${day}.shtml`;
            
            // Usa Proxy AllOrigins per aggirare CORS
            try {
                const response = await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent(targetUrl)}`);
                const data = await response.json();
                if (!data.contents) throw new Error("No data");

                // Parsing brutale ma efficace del HTML
                const parser = new DOMParser();
                const doc = parser.parseFromString(data.contents, "text/html");
                
                // Lachiesa.it non ha ID facili, cerchiamo per parole chiave nel testo
                const textContent = doc.body.innerText;
                
                // Helper per estrarre tra due stringhe
                const extract = (startStr, endStr) => {
                    const s = textContent.indexOf(startStr);
                    if(s === -1) return "";
                    const e = textContent.indexOf(endStr, s);
                    if(e === -1) return "";
                    return textContent.substring(s + startStr.length, e).trim();
                };

                // Tentativi di estrazione (Euristica)
                let r1 = extract("Prima Lettura", "Salmo Responsoriale");
                let rPs = extract("Salmo Responsoriale", "Seconda Lettura");
                let r2 = extract("Seconda Lettura", "Vangelo");
                let rG = extract("Vangelo", "PREGHIERA DEI FEDELI");

                // Fallback se manca la seconda lettura (feriali)
                if(!r2 && !rG) {
                    rPs = extract("Salmo Responsoriale", "Vangelo");
                    rG = extract("Vangelo", "PREGHIERA DEI FEDELI");
                }

                // Inserimento
                document.getElementById('read1').value = cleanText(r1);
                document.getElementById('readPsalm').value = cleanText(rPs);
                document.getElementById('read2').value = cleanText(r2);
                document.getElementById('readGospel').value = cleanText(rG);
                
                showToast("Letture inserite! Controlla formattazione.");

            } catch(e) {
                console.error(e);
                showToast("Errore Auto-Fetch. Usa il tasto Web.", "error");
                window.open(targetUrl, '_blank');
            }
        }

        function cleanText(txt) {
            if(!txt) return "";
            return txt.replace(/\s+/g, ' ').replace(/Dal libro/g, '\nDal libro').replace(/Dalla lettera/g, '\nDalla lettera').substring(0, 1000); // Limit
        }

        function openSmartReadings() {
            const d = new Date(document.getElementById('messaDate').value);
            const fmt = d.getFullYear() + String(d.getMonth()+1).padStart(2,'0') + String(d.getDate()).padStart(2,'0');
            window.open(`https://www.lachiesa.it/calendario/Detailed/${fmt}.shtml`, '_blank');
        }

        // --- STAMPA & CONDIVISIONE MODULARE ---
        function printMode(mode) {
            document.body.className = ''; // Reset
            if(mode === 'messa') document.body.classList.add('print-messa');
            if(mode === 'letture') document.body.classList.add('print-letture');
            window.print();
            setTimeout(() => document.body.className = '', 1000); // Reset after print
        }

        function shareMode(mode) {
            const t = document.getElementById('messaTitle').value;
            const d = document.getElementById('messaDate').value;
            let txt = `üìÖ *${t}* - ${d}\n\n`;

            if(mode === 'messa' || mode === 'all') {
                txt += "üéµ *CANTI:*\n";
                document.querySelectorAll('.slot-container').forEach(sl => {
                    const sel = sl.querySelector('select');
                    if(sel && sel.selectedIndex > 0) txt += `- ${sl.dataset.part}: ${sel.options[sel.selectedIndex].text}\n`;
                });
                txt += "\n";
            }

            if(mode === 'letture' || mode === 'all') {
                txt += "üìñ *LETTURE:*\n";
                const r1 = document.getElementById('read1').value;
                const rG = document.getElementById('readGospel').value;
                if(r1) txt += "I Lettura: (Vedi testo)\n";
                if(rG) txt += "Vangelo: (Vedi testo)\n";
                txt += "Link: https://www.lachiesa.it\n";
            }

            window.open(`https://wa.me/?text=${encodeURIComponent(txt)}`, '_blank');
        }

        // --- CALCOLO LITURGICO ---
        function calcLiturgy() {
            const d = new Date(document.getElementById('messaDate').value);
            const y = d.getFullYear();
            // ... (Algoritmo semplificato per brevit√†, usa quello della v12 se serve precisione massima)
            document.getElementById('messaType').value = "Anno " + ['C','A','B'][y%3] + " (Auto)";
        }

        // --- CORE FUNCTIONS (Standard) ---
        function showToast(msg, type="") { const t=document.getElementById("toast");t.innerText=msg;t.className="show "+type;setTimeout(()=>t.className=t.className.replace("show",""),3000); }
        function saveSetlist(){
            const t=document.getElementById('messaTitle').value;const d=document.getElementById('messaDate').value;const tp=document.getElementById('messaType').value;
            const sel={};document.querySelectorAll('.slot-container').forEach(sl=>{const ids=[];sl.querySelectorAll('select').forEach(s=>{if(s.value)ids.push(s.value)});sel[sl.dataset.part]=ids;});
            const r={r1:document.getElementById('read1').value,rps:document.getElementById('readPsalm').value,r2:document.getElementById('read2').value,rg:document.getElementById('readGospel').value};
            db.transaction(["setlists"],"readwrite").objectStore("setlists").add({title:t,dateStr:d,type:tp,selections:sel,readings:r}).oncomplete=()=>showToast("Salvato!");
        }
        function loadSetlist(id){
            db.transaction(["setlists"]).objectStore("setlists").get(id).onsuccess=(e)=>{
                const r=e.target.result; document.getElementById('messaTitle').value=r.title; document.getElementById('messaDate').value=r.dateStr;
                if(r.readings){document.getElementById('read1').value=r.readings.r1;document.getElementById('readPsalm').value=r.readings.rps;document.getElementById('read2').value=r.readings.r2;document.getElementById('readGospel').value=r.readings.rg;}
                document.querySelectorAll('.selectors-list').forEach(l=>l.innerHTML="");
                for(const[p,ids] of Object.entries(r.selections)){if(!ids.length)addSelector(p);else ids.forEach(i=>addSelector(p,i));}
                toggleHistory();
            }
        }
        
        // STANDARD UI
        function switchTab(id){ document.querySelectorAll('.view').forEach(v=>v.classList.add('hidden')); document.getElementById(id).classList.remove('hidden'); document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active')); document.getElementById('btn-'+id).classList.add('active'); if(id==='library')loadLibrary(); }
        function buildScalettaUI() { const g = document.querySelector('.scaletta-grid'); if(g.children.length === 0) DEFAULT_PARTS.forEach(p => { const d = document.createElement('div'); d.className = 'slot-container'; d.dataset.part = p; d.innerHTML = `<div class="col-title" style="font-size:0.9rem;margin-bottom:5px;">${p}<button class="btn-compact" onclick="addSelector('${p}')">+</button></div><div class="selectors-list" id="list-${p}"></div>`; g.appendChild(d); addSelector(p); }); }
        function addSelector(p, id=null){ const c = document.getElementById(`list-${p}`); const r = document.createElement('div'); r.style.display="flex"; r.style.marginBottom="5px"; r.innerHTML = `<select class="song-selector header-input" style="text-align:left"><option value="">Seleziona...</option></select><button style="border:none;background:none;color:red;cursor:pointer;" onclick="this.parentElement.remove()">√ó</button>`; c.appendChild(r); populateSingleSelect(r.querySelector('select'), id); }
        function populateSingleSelect(s, id){ s.innerHTML='<option value="">Seleziona...</option>'; db.transaction(["songs"]).objectStore("songs").openCursor().onsuccess=(e)=>{const c=e.target.result;if(c){const o=document.createElement('option');o.value=c.key;o.text=c.value.title;if(c.key==id)o.selected=true;s.appendChild(o);c.continue();}} }
        
        function toggleHistory(){ const p=document.getElementById('historyPanel'); const l=document.getElementById('historyList'); if(p.classList.contains('hidden')){p.classList.remove('hidden'); l.innerHTML=""; const tx=db.transaction(["setlists"],"readonly").objectStore("setlists"); tx.openCursor(null,'prev').onsuccess=(e)=>{const c=e.target.result; if(c){const x=c.value; l.innerHTML+=`<div class="history-item" onclick="loadSetlist(${x.id})"><b>${x.title}</b><br>${x.dateStr}</div>`; c.continue();}} }else p.classList.add('hidden'); }
        
        // STANDARD SONG MGMT
        function saveSongData(){const t=document.getElementById('manualTitle').value; if(!t)return alert("Titolo!"); const s={title:t, category:document.getElementById('newSongCategory').value, season:document.getElementById('newSongSeason').value, youtubeUrl:document.getElementById('youtubeLink').value, lyrics:activeInputMode==='text'?document.getElementById('textContent').value:null, fileData:activeInputMode==='file'&&tempDriveFile?tempDriveFile.data:null, type:activeInputMode==='file'&&tempDriveFile?tempDriveFile.type:'text/plain'}; const tx=db.transaction(["songs"],"readwrite"); tx.objectStore("songs").put(s).onsuccess=()=>{closeAddMenu();loadLibrary();alert("Salvato")}; }
        function loadLibrary(){ const l=document.getElementById('songList'); l.innerHTML=""; db.transaction(["songs"]).objectStore("songs").openCursor().onsuccess=(e)=>{const c=e.target.result; if(c){const s=c.value; l.innerHTML+=`<div class="song-card" onclick="openViewModal(${s.id})"><div class="card-icon">üéµ</div><div>${s.title}</div></div>`; c.continue();} } }
        function openViewModal(id){ currentViewingId=id; db.transaction(["songs"]).objectStore("songs").get(id).onsuccess=(e)=>{const s=e.target.result; document.getElementById('viewSongTitle').innerText=s.title; const b=document.getElementById('viewSongBody'); if(s.lyrics)b.innerHTML=`<pre>${s.lyrics}</pre>`; else if(s.fileData) b.innerHTML=`<img src="${s.fileData}" style="width:100%">`; document.getElementById('viewSongModal').classList.remove('hidden'); }}
        function closeViewModal(){ document.getElementById('viewSongModal').classList.add('hidden'); }
        function openAddMenu(){ document.getElementById('addMenu').classList.remove('hidden'); }
        function closeAddMenu(){ document.getElementById('addMenu').classList.add('hidden'); }
        function switchInputTab(m){ activeInputMode=m; document.getElementById('tab-file').className=m==='file'?'tab-content':'hidden'; document.getElementById('tab-text').className=m==='text'?'tab-content':'hidden'; }
        function handleLocalFile(i){ const f=i.files[0]; const r=new FileReader(); r.onload=e=>{tempDriveFile={data:e.target.result,type:f.type}; document.getElementById('previewText').classList.remove('hidden');}; r.readAsDataURL(f); }
        function toggleDarkMode(){ document.body.classList.toggle('dark-mode'); }
        function loadDarkMode(){}
        function renderCategoryChips(){}
        function updateCategoryDropdowns(){}
        function initGoogleDriveImport(){} // (Usa codice v12 per drive)
    </script>
</body>
</html>
