<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Spartiti Messa Pro</title>
    
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="logo192.png">
    <meta name="theme-color" content="#673ab7">
    
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client"></script>
    
    <style>
        /* --- CSS RESET & BASE --- */
        :root { --primary: #673ab7; --primary-dark: #512da8; --bg: #f4f4f9; --surface: #ffffff; --text: #333; }
        * { box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); margin: 0; padding-bottom: 80px; color: var(--text); -webkit-tap-highlight-color: transparent; }
        
        /* UTILITIES */
        .hidden { display: none !important; }
        .no-print { }
        
        /* CONTAINER */
        .container { max-width: 1400px; margin: 0 auto; min-height: 100vh; position: relative; }
        @media (min-width: 800px) { .container { padding: 20px; } .view { background: var(--surface); border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); padding: 20px; } }

        /* HEADER & NAV */
        .sticky-header { background: var(--surface); padding: 10px 15px; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .header-row { display: flex; justify-content: space-between; align-items: center; gap: 10px; }
        
        .bottom-nav { position: fixed; bottom: 0; width: 100%; background: var(--surface); display: flex; justify-content: space-around; padding: 10px 0; border-top: 1px solid #eee; z-index: 1000; box-shadow: 0 -2px 10px rgba(0,0,0,0.05); }
        .nav-btn { background: none; border: none; display: flex; flex-direction: column; align-items: center; color: #999; font-size: 0.75rem; cursor: pointer; }
        .nav-btn.active { color: var(--primary); }
        .nav-btn span.material-icons-round { font-size: 24px; margin-bottom: 2px; }

        /* INPUTS */
        .search-bar-container { display: flex; align-items: center; background: #f0f2f5; padding: 8px 12px; border-radius: 20px; margin-bottom: 10px; }
        #searchInput { border: none; background: transparent; width: 100%; outline: none; font-size: 1rem; margin-left: 5px; }
        
        .header-input { border: none; background: transparent; font-size: 1.2rem; color: var(--primary); font-weight: bold; width: 100%; padding: 5px; margin: 0; }
        .header-date { font-size: 0.9rem; background: #eee; border: none; border-radius: 6px; padding: 4px 8px; color: #555; }

        /* LISTE */
        .song-list-container { padding-top: 10px; padding-bottom: 80px; }
        .song-card { background: white; padding: 12px; border-radius: 8px; margin-bottom: 8px; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 1px 3px rgba(0,0,0,0.1); cursor: pointer; transition: background 0.2s; }
        .song-card:active { background: #f5f5f5; }
        
        /* MENU HAMBURGER (DROPDOWN) */
        .menu-wrapper { position: relative; }
        .menu-btn { background: none; border: none; padding: 8px; cursor: pointer; border-radius: 50%; }
        .menu-btn:active { background: #eee; }
        .dropdown-menu {
            position: absolute; top: 100%; right: 0; width: 220px;
            background: white; border-radius: 8px; box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            display: none; flex-direction: column; z-index: 2000; overflow: hidden; border: 1px solid #eee; margin-top: 5px;
        }
        .dropdown-menu.show { display: flex; }
        .menu-item {
            background: none; border: none; width: 100%; text-align: left;
            padding: 12px 15px; font-size: 0.95rem; color: #333; cursor: pointer;
            display: flex; align-items: center; gap: 10px; border-bottom: 1px solid #f9f9f9;
        }
        .menu-item:active { background: #f0f0f0; }

        /* SPLIT VIEW & GRID */
        .workspace-grid { display: grid; gap: 20px; margin-top: 20px; }
        .workspace-grid.single-view { grid-template-columns: 1fr; }
        .workspace-grid.single-view .col-readings { display: none; }
        .workspace-grid.split-view { grid-template-columns: 1fr 1fr; }
        @media (max-width: 900px) { .workspace-grid.split-view { grid-template-columns: 1fr; } } 

        .col-box { background: white; border: 1px solid #eee; border-radius: 12px; padding: 15px; }
        .col-title { font-weight: bold; color: var(--primary); margin-bottom: 10px; display: flex; justify-content: space-between; }

        /* FORM EDIT */
        .slot-container { margin-bottom: 12px; }
        .part-label { font-size: 0.8rem; font-weight: bold; color: #666; margin-bottom: 4px; display: block; }
        .song-selector { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; background: white; font-size: 0.95rem; }
        
        textarea { width: 100%; height: 100px; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-family: inherit; resize: vertical; margin-bottom: 10px; }

        /* BUTTONS */
        .fab { position: fixed; bottom: 85px; right: 20px; width: 56px; height: 56px; border-radius: 50%; background: var(--primary); color: white; border: none; box-shadow: 0 4px 10px rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 900; }
        .btn-primary { background: var(--primary); color: white; border: none; padding: 8px 16px; border-radius: 20px; font-weight: bold; }
        .btn-outline { background: transparent; border: 1px solid #ccc; color: #555; padding: 5px 10px; border-radius: 20px; font-size: 0.85rem; cursor: pointer; }

        /* MODALITA' LETTURA IMMERSIVA */
        #readingContainer { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 5000; overflow: hidden; }
        .reading-nav { height: 50px; border-bottom: 1px solid #eee; display: flex; align-items: center; justify-content: space-between; padding: 0 10px; background: #fff; }
        .reading-body { height: calc(100% - 50px); overflow-y: auto; padding: 15px; }
        
        .score-sequence-item { margin-bottom: 30px; border-bottom: 4px solid #f0f0f0; padding-bottom: 20px; }
        .pdf-frame { width: 100%; height: 80vh; border: none; background: #f9f9f9; }
        .img-score { width: 100%; height: auto; }

        /* FULLSCREEN OVERLAY */
        #fsModal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: black; z-index: 6000; display: flex; flex-direction: column; }
        
        /* TOAST */
        #toast { visibility: hidden; min-width: 250px; background: #333; color: white; text-align: center; border-radius: 50px; padding: 12px; position: fixed; z-index: 7000; left: 50%; transform: translateX(-50%); bottom: 30px; opacity: 0; transition: 0.3s; }
        #toast.show { visibility: visible; opacity: 1; bottom: 40px; }
        #toast.error { background: #d32f2f; }

        /* PRINT */
        @media print {
            .no-print, .bottom-nav, .fab { display: none !important; }
            .container { padding: 0; max-width: 100%; }
            body.print-messa .col-readings { display: none; }
            body.print-letture .col-messa { display: none; }
            body.print-letture .col-readings { display: block !important; }
        }
    </style>
</head>
<body>

    <div id="toast">Messaggio</div>

    <div id="fsModal" class="hidden no-print">
        <div style="height:40px; background:#222; display:flex; justify-content:flex-end; align-items:center; padding:0 10px;">
            <button onclick="closeFullscreen()" style="background:none; border:none; color:white; font-weight:bold; cursor:pointer;">CHIUDI ‚úï</button>
        </div>
        <iframe id="fsFrame" style="flex:1; border:none; background:white;"></iframe>
    </div>

    <section id="library" class="view active">
        <header class="sticky-header no-print">
            <div class="search-bar-container">
                <span class="material-icons-round" style="color:#666">search</span>
                <input type="text" id="searchInput" placeholder="Cerca titolo..." onkeyup="applyFilters()">
            </div>
            <div style="display:flex; gap:5px; overflow-x:auto; padding-bottom:5px;">
                <select id="filterSeason" onchange="applyFilters()" style="padding:5px; border-radius:8px; border:1px solid #ddd;">
                    <option value="Tutti">Tutti</option><option value="Ordinario">Ordinario</option><option value="Avvento">Avvento</option><option value="Natale">Natale</option><option value="Quaresima">Quaresima</option><option value="Pasqua">Pasqua</option>
                </select>
                <div id="categoryChips" style="display:flex; gap:5px;"></div>
            </div>
        </header>
        <div id="songList" class="song-list-container"></div>
        <button class="fab no-print" onclick="openAddMenu()"><span class="material-icons-round">add</span></button>
    </section>

    <section id="scaletta" class="view hidden">
        <header class="sticky-header no-print">
            <div class="header-row">
                <div style="flex:1;">
                    <input type="text" id="messaTitle" class="header-input" value="Santa Messa">
                    <div style="display:flex; gap:5px; align-items:center;">
                        <input type="date" id="messaDate" onchange="calcLiturgy()" class="header-date">
                        <span id="messaType" style="font-size:0.8rem; color:#666;"></span>
                    </div>
                </div>
                
                <div style="display:flex; gap:5px;">
                    <button onclick="saveSetlist()" class="btn-primary" style="font-size:0.8rem;">SALVA</button>
                    
                    <div class="menu-wrapper">
                        <button onclick="toggleMenu()" class="menu-btn"><span class="material-icons-round">more_vert</span></button>
                        <div id="actionMenu" class="dropdown-menu">
                            <button class="menu-item" onclick="switchToReadingMode()"><span class="material-icons-round">auto_stories</span> Modalit√† Lettura</button>
                            <button class="menu-item" onclick="toggleLayoutMode()"><span class="material-icons-round">view_sidebar</span> Affianca / Singola</button>
                            <div style="height:1px; background:#eee; margin:5px 0;"></div>
                            <button class="menu-item" onclick="printMode('all')"><span class="material-icons-round">print</span> Stampa Tutto</button>
                            <button class="menu-item" onclick="shareMode('all')"><span class="material-icons-round">share</span> Condividi Tutto</button>
                            <div style="height:1px; background:#eee; margin:5px 0;"></div>
                            <button class="menu-item" onclick="toggleHistory()"><span class="material-icons-round">history</span> Storico</button>
                            <button class="menu-item" onclick="resetScaletta()" style="color:red;"><span class="material-icons-round">delete</span> Pulisci</button>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <div id="workspace" class="workspace-grid single-view">
            <div class="col-box col-messa">
                <div class="col-title">üéµ Scaletta Canti</div>
                <div class="scaletta-grid"></div>
            </div>
            <div class="col-box col-readings">
                <div class="col-title">
                    <span>üìñ Liturgia</span>
                    <button onclick="autoFillReadings()" class="btn-outline">‚ú® Auto-Web</button>
                </div>
                <div class="reading-field"><label>I Lettura</label><textarea id="read1"></textarea></div>
                <div class="reading-field"><label>Salmo</label><textarea id="readPsalm"></textarea></div>
                <div class="reading-field"><label>II Lettura</label><textarea id="read2"></textarea></div>
                <div class="reading-field"><label>Vangelo</label><textarea id="readGospel"></textarea></div>
            </div>
        </div>
        
        <div id="historyPanel" class="hidden" style="position:fixed;top:0;right:0;width:260px;height:100%;background:white;z-index:2500;box-shadow:-2px 0 10px rgba(0,0,0,0.2);padding:15px;overflow-y:auto;">
            <div style="display:flex;justify-content:space-between;margin-bottom:15px;"><h3>Storico</h3><button onclick="toggleHistory()" style="border:none;background:none;font-size:1.5rem;">&times;</button></div>
            <div id="historyList"></div>
        </div>
    </section>

    <div id="readingContainer">
        <div class="reading-nav">
            <button onclick="exitReadingMode()" style="border:none;background:none;color:red;font-weight:bold;">‚Üê ESCI</button>
            <div style="display:flex; gap:10px;">
                <button onclick="showReadTab('music')" style="border:none;background:none;font-weight:bold;color:var(--primary);">CANTI</button>
                <button onclick="showReadTab('word')" style="border:none;background:none;font-weight:bold;color:#666;">LETTURE</button>
            </div>
            <div style="width:40px;"></div>
        </div>
        <div class="reading-body">
            <div id="readMusicView"></div>
            <div id="readWordView" class="hidden" style="max-width:800px;margin:0 auto;font-size:1.2rem;line-height:1.6;"></div>
        </div>
    </div>

    <section id="settings" class="view hidden">
        <header class="sticky-header"><div class="header-row"><button onclick="switchTab('library')" style="border:none;background:none;">‚Üê</button><h1>Opzioni</h1></div></header>
        <div style="padding:15px;">
            <div class="col-box" style="margin-bottom:10px;"><h3>Google Drive</h3><input type="text" id="gApiKey" class="song-selector" placeholder="API Key" style="margin-bottom:5px;"><input type="text" id="gClientId" class="song-selector" placeholder="Client ID"><button onclick="saveGoogleKeys()" class="btn-primary" style="margin-top:5px;">Salva</button></div>
            <div class="col-box" style="margin-bottom:10px;"><h3>Backup</h3><button onclick="exportData()" class="btn-outline">Scarica Backup</button><input type="file" id="importJson" onchange="importData(this)" style="margin-top:5px;"></div>
        </div>
    </section>

    <div id="addMenu" class="hidden" style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:3000;display:flex;align-items:center;justify-content:center;">
        <div style="background:white;width:90%;max-width:500px;border-radius:12px;padding:20px;max-height:90vh;overflow-y:auto;">
            <div style="display:flex;justify-content:space-between;"><h3>Canto</h3><button onclick="closeAddMenu()" style="border:none;background:none;font-size:1.5rem;">&times;</button></div>
            <input type="text" id="manualTitle" class="song-selector" placeholder="Titolo" style="margin-bottom:10px;">
            <select id="newSongCategory" class="song-selector" style="margin-bottom:10px;"></select>
            <div style="display:flex;gap:10px;margin-bottom:10px;">
                <button onclick="document.getElementById('fileInput').click()" class="btn-outline">Carica File</button>
                <button onclick="initGoogleDriveImport()" class="btn-outline">Da Drive</button>
            </div>
            <div id="fileInfo" style="font-size:0.8rem;color:green;margin-bottom:10px;"></div>
            <textarea id="textContent" placeholder="Testo e accordi..."></textarea>
            <input type="hidden" id="editId">
            <input type="file" id="fileInput" hidden onchange="handleLocalFile(this)">
            <button onclick="saveSongData()" class="btn-primary" style="width:100%;">SALVA</button>
        </div>
    </div>

    <script>
        // --- VARIABILI GLOBALI ---
        let db; let tempDriveFile = null; let currentViewingId = null;
        let customCategories = JSON.parse(localStorage.getItem('customCategories')) || [];
        const DEFAULT_PARTS = ['Ingresso', 'Gloria', 'Salmo', 'Alleluia', 'Offertorio', 'Santo', 'Comunione', 'Finale'];
        let ALL_CATEGORIES = [...new Set([...DEFAULT_PARTS, ...customCategories, 'Altro'])];

        // --- INIT DB ---
        const request = indexedDB.open("SpartitiMessaPro", 10);
        request.onupgradeneeded = (e) => {
            db = e.target.result;
            if(!db.objectStoreNames.contains("songs")) { const s=db.createObjectStore("songs",{keyPath:"id",autoIncrement:true}); s.createIndex("category","category",{unique:false}); }
            if(!db.objectStoreNames.contains("setlists")) db.createObjectStore("setlists",{keyPath:"id",autoIncrement:true});
        };
        request.onsuccess = (e) => { db = e.target.result; initApp(); };
        request.onerror = (e) => showToast("Errore Caricamento Database!", "error");

        function initApp(){
            buildScalettaUI(); loadLibrary(); updateCategoryDropdowns();
            document.getElementById('gApiKey').value = localStorage.getItem('g_api') || "";
            document.getElementById('gClientId').value = localStorage.getItem('g_client') || "";
            document.getElementById('messaDate').valueAsDate = new Date();
            calcLiturgy();
            
            // Chiudi menu se clicco fuori
            window.onclick = function(e) {
                if (!e.target.matches('.menu-btn') && !e.target.closest('.menu-btn')) {
                    document.getElementById("actionMenu").classList.remove('show');
                }
            }
        }

        // --- UI FUNCTIONS ---
        function showToast(msg, type="") {
            const t = document.getElementById("toast"); t.innerText = msg;
            t.className = "show " + type; setTimeout(() => t.className = t.className.replace("show", ""), 3000);
        }
        function switchTab(id) {
            document.querySelectorAll('.view').forEach(v => v.classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('btn-'+id).classList.add('active');
        }
        function toggleMenu() { document.getElementById("actionMenu").classList.toggle("show"); }
        function toggleLayoutMode() {
            const ws = document.getElementById('workspace');
            if (ws.classList.contains('single-view')) { ws.classList.replace('single-view', 'split-view'); document.querySelector('.col-readings').style.display='block'; }
            else { ws.classList.replace('split-view', 'single-view'); document.querySelector('.col-readings').style.display='none'; }
        }

        // --- GESTIONE CANTI ---
        function openAddMenu(id=null) {
            document.getElementById('addMenu').classList.remove('hidden');
            document.getElementById('editId').value = id || "";
            document.getElementById('manualTitle').value = "";
            document.getElementById('textContent').value = "";
            document.getElementById('fileInfo').innerText = "";
            tempDriveFile = null;
            if(id) {
                db.transaction(["songs"]).objectStore("songs").get(id).onsuccess = (e) => {
                    const s = e.target.result;
                    document.getElementById('manualTitle').value = s.title;
                    document.getElementById('newSongCategory').value = s.category;
                    if(s.lyrics) document.getElementById('textContent').value = s.lyrics;
                    if(s.fileData) document.getElementById('fileInfo').innerText = "File Presente ‚úÖ";
                };
            }
        }
        function closeAddMenu() { document.getElementById('addMenu').classList.add('hidden'); }
        
        function saveSongData() {
            const t = document.getElementById('manualTitle').value.trim();
            if(!t) return showToast("Manca Titolo", "error");
            
            const s = {
                title: t,
                category: document.getElementById('newSongCategory').value,
                lyrics: document.getElementById('textContent').value,
                date: new Date(),
                fileData: tempDriveFile ? tempDriveFile.data : null,
                type: tempDriveFile ? tempDriveFile.type : 'text/plain'
            };
            
            const id = document.getElementById('editId').value;
            if(id) {
                // Se √® una modifica e non ho caricato un nuovo file, mantengo il vecchio
                if(!tempDriveFile) {
                    db.transaction(["songs"]).objectStore("songs").get(Number(id)).onsuccess = (e) => {
                        const old = e.target.result;
                        s.fileData = old.fileData; s.type = old.type; s.id = Number(id);
                        putSong(s);
                    };
                    return;
                }
                s.id = Number(id);
            }
            putSong(s);
        }
        
        function putSong(s) {
            const tx = db.transaction(["songs"], "readwrite");
            tx.onabort = () => showToast("Errore salvataggio (File troppo grande?)", "error");
            tx.objectStore("songs").put(s).onsuccess = () => {
                showToast("Salvato!"); closeAddMenu(); loadLibrary();
            };
        }

        function loadLibrary() {
            const l = document.getElementById('songList'); l.innerHTML = "";
            db.transaction(["songs"]).objectStore("songs").openCursor().onsuccess = (e) => {
                const c = e.target.result;
                if(c) {
                    const s = c.value;
                    // Filtri
                    const txt = document.getElementById('searchInput').value.toLowerCase();
                    if(s.title.toLowerCase().includes(txt)) {
                        l.innerHTML += `<div class="song-card" onclick="openAddMenu(${s.id})"><div><b>${s.title}</b><br><small>${s.category}</small></div><span class="material-icons-round">edit</span></div>`;
                    }
                    c.continue();
                }
            };
        }

        // --- FILE HANDLING ---
        function handleLocalFile(input) {
            const f = input.files[0];
            if(f) {
                if(f.size > 15000000) return alert("File troppo grande (>15MB)");
                const r = new FileReader();
                r.onload = (e) => {
                    tempDriveFile = { data: e.target.result, type: f.type };
                    document.getElementById('fileInfo').innerText = "File Caricato: " + f.name;
                };
                r.readAsDataURL(f);
            }
        }

        // --- SCALETTA & LETTURE ---
        function buildScalettaUI() {
            const g = document.querySelector('.scaletta-grid');
            if(g.children.length === 0) {
                DEFAULT_PARTS.forEach(p => {
                    const d = document.createElement('div'); d.className = 'slot-container'; d.dataset.part = p;
                    d.innerHTML = `<span class="part-label">${p}</span><div class="selector-row"><select class="song-selector"><option value="">Seleziona...</option></select><button class="btn-del-slot" onclick="this.previousElementSibling.value=''">√ó</button></div>`;
                    g.appendChild(d);
                    populateSelect(d.querySelector('select'));
                });
            }
        }
        function populateSelect(s) {
            db.transaction(["songs"]).objectStore("songs").openCursor().onsuccess = (e) => {
                const c = e.target.result;
                if(c) {
                    const o = document.createElement('option'); o.value = c.key; o.text = c.value.title;
                    s.appendChild(o); c.continue();
                }
            };
        }

        // --- MAGIC FETCH (AUTO LETTURE) ---
        async function autoFillReadings() {
            const dStr = document.getElementById('messaDate').value;
            if(!dStr) return showToast("Inserisci data!", "error");
            showToast("Ricerca...", "info");
            
            const d = new Date(dStr);
            const url = `https://www.lachiesa.it/calendario/Detailed/${d.getFullYear()}${String(d.getMonth()+1).padStart(2,'0')}${String(d.getDate()).padStart(2,'0')}.shtml`;
            
            try {
                const proxy = `https://api.allorigins.win/get?url=${encodeURIComponent(url)}`;
                const res = await fetch(proxy);
                const json = await res.json();
                if(!json.contents) throw new Error("No data");
                
                const parser = new DOMParser();
                const doc = parser.parseFromString(json.contents, "text/html");
                const text = doc.body.innerText;
                
                const getTxt = (start, end) => {
                    const s = text.indexOf(start); if(s<0)return "";
                    const e = text.indexOf(end, s); return e<0 ? "" : text.substring(s+start.length, e).trim();
                };
                
                document.getElementById('read1').value = getTxt("Prima Lettura", "Salmo Responsoriale").substring(0,2000);
                document.getElementById('readPsalm').value = getTxt("Salmo Responsoriale", "Seconda Lettura").substring(0,2000);
                document.getElementById('read2').value = getTxt("Seconda Lettura", "Vangelo").substring(0,2000);
                document.getElementById('readGospel').value = getTxt("Vangelo", "PREGHIERA DEI FEDELI").substring(0,3000);
                
                showToast("Letture Trovate!");
            } catch(e) {
                showToast("Errore. Apro il sito...", "error");
                window.open(url, '_blank');
            }
        }

        // --- CALCOLO LITURGICO SEMPLICE ---
        function calcLiturgy() {
            const d = new Date(document.getElementById('messaDate').value);
            const y = d.getFullYear();
            document.getElementById('messaType').innerText = `Anno ${['C','A','B'][y%3]}`;
        }

        // --- MODALITA LETTURA ---
        function switchToReadingMode() {
            document.getElementById('readingContainer').style.display = 'block';
            renderReadingMode();
        }
        function exitReadingMode() { document.getElementById('readingContainer').style.display = 'none'; }
        
        function showReadTab(tab) {
            document.getElementById('readMusicView').className = tab==='music'?'':'hidden';
            document.getElementById('readWordView').className = tab==='word'?'':'hidden';
        }

        function renderReadingMode() {
            const mc = document.getElementById('readMusicView'); mc.innerHTML = "";
            const wc = document.getElementById('readWordView'); wc.innerHTML = "";
            
            // Musica
            document.querySelectorAll('.song-selector').forEach(sel => {
                if(sel.value) {
                    db.transaction(["songs"]).objectStore("songs").get(Number(sel.value)).onsuccess = (e) => {
                        const s = e.target.result;
                        const div = document.createElement('div'); div.className = 'score-sequence-item';
                        let content = "";
                        if(s.lyrics) content = `<pre style="padding:15px;white-space:pre-wrap;">${s.lyrics}</pre>`;
                        else if(s.type.includes('pdf')) content = `<iframe src="${s.fileData}" class="pdf-frame"></iframe><button onclick="openFullscreen('${s.fileData}')" style="width:100%;padding:10px;background:#333;color:white;border:none;">Apri Schermo Intero</button>`;
                        else content = `<img src="${s.fileData}" class="img-score">`;
                        
                        div.innerHTML = `<div class="score-header"><h3>${s.title}</h3></div>${content}`;
                        mc.appendChild(div);
                    };
                }
            });

            // Letture
            const fields = [
                {id:'read1', t:'Prima Lettura'}, {id:'readPsalm', t:'Salmo'},
                {id:'read2', t:'Seconda Lettura'}, {id:'readGospel', t:'Vangelo'}
            ];
            fields.forEach(f => {
                const val = document.getElementById(f.id).value;
                if(val) wc.innerHTML += `<div style="margin-bottom:30px;"><h3 style="color:var(--primary);border-bottom:1px solid #ddd;">${f.t}</h3><p style="white-space:pre-wrap;">${val}</p></div>`;
            });
        }

        function openFullscreen(url) {
            const m = document.getElementById('fsModal'); m.classList.remove('hidden');
            document.getElementById('fsFrame').src = url;
        }
        function closeFullscreen() {
            document.getElementById('fsModal').classList.add('hidden');
            document.getElementById('fsFrame').src = "";
        }

        // --- SALVATAGGIO / CARICAMENTO SCALETTA ---
        function saveSetlist() {
            const t = document.getElementById('messaTitle').value;
            const d = document.getElementById('messaDate').value;
            const sel = {};
            document.querySelectorAll('.slot-container').forEach(sl => {
                const s = sl.querySelector('select');
                if(s.value) sel[sl.dataset.part] = [s.value];
            });
            const r = {
                r1: document.getElementById('read1').value,
                rps: document.getElementById('readPsalm').value,
                r2: document.getElementById('read2').value,
                rg: document.getElementById('readGospel').value
            };
            
            db.transaction(["setlists"],"readwrite").objectStore("setlists").add({title:t, dateStr:d, selections:sel, readings:r}).oncomplete = () => showToast("Messa Salvata!");
        }

        function toggleHistory() {
            const p = document.getElementById('historyPanel');
            if(p.classList.contains('hidden')) {
                p.classList.remove('hidden');
                const l = document.getElementById('historyList'); l.innerHTML = "";
                db.transaction(["setlists"],"readonly").objectStore("setlists").openCursor(null,'prev').onsuccess = (e) => {
                    const c = e.target.result;
                    if(c) {
                        const x = c.value;
                        l.innerHTML += `<div style="padding:10px;border-bottom:1px solid #eee;cursor:pointer;" onclick="loadSetlist(${x.id})"><b>${x.title}</b><br><small>${x.dateStr}</small></div>`;
                        c.continue();
                    }
                };
            } else p.classList.add('hidden');
        }

        function loadSetlist(id) {
            db.transaction(["setlists"]).objectStore("setlists").get(id).onsuccess = (e) => {
                const r = e.target.result;
                document.getElementById('messaTitle').value = r.title;
                document.getElementById('messaDate').value = r.dateStr;
                if(r.readings) {
                    document.getElementById('read1').value = r.readings.r1||"";
                    document.getElementById('readPsalm').value = r.readings.rps||"";
                    document.getElementById('read2').value = r.readings.r2||"";
                    document.getElementById('readGospel').value = r.readings.rg||"";
                }
                // Reset select e ricarica
                document.querySelectorAll('.song-selector').forEach(s => s.value = "");
                for(const[p,ids] of Object.entries(r.selections)) {
                    const slot = document.querySelector(`.slot-container[data-part="${p}"] select`);
                    if(slot && ids.length) slot.value = ids[0];
                }
                toggleHistory();
            };
        }

        // --- STAMPA E SHARE ---
        function printMode(mode) {
            document.body.className = '';
            if(mode === 'messa') document.body.classList.add('print-messa');
            if(mode === 'letture') document.body.classList.add('print-letture');
            window.print();
        }
        function shareMode(mode) {
            const t = document.getElementById('messaTitle').value;
            const d = document.getElementById('messaDate').value;
            let txt = `üìÖ *${t}* - ${d}\n\n`;
            if(mode !== 'letture') {
                txt += "üéµ CANTI:\n";
                document.querySelectorAll('.song-selector').forEach(s => {
                    if(s.selectedIndex > 0) txt += `- ${s.parentElement.parentElement.dataset.part}: ${s.options[s.selectedIndex].text}\n`;
                });
            }
            if(mode !== 'messa') txt += "\nüìñ LETTURE:\n(Vedi app)\n";
            window.open(`https://wa.me/?text=${encodeURIComponent(txt)}`, '_blank');
        }

        // --- GOOGLE DRIVE LOGIC ---
        let tokenClient; let gapiInited=false; let gisInited=false;
        function getKeys(){ return { k:localStorage.getItem('g_api')||document.getElementById('gApiKey').value, c:localStorage.getItem('g_client')||document.getElementById('gClientId').value }; }
        function saveGoogleKeys(){ const{k,c}=getKeys(); if(k&&c){ localStorage.setItem('g_api',k); localStorage.setItem('g_client',c); showToast("Keys OK"); } }
        
        async function ensureGoogleReady() {
            const{k,c}=getKeys(); if(!k||!c){ showToast("Mancano Key", "error"); return false; }
            if(gapiInited && gisInited) return true;
            try {
                await new Promise(r=>gapi.load('client:picker', async()=>{ await gapi.client.init({apiKey:k, discoveryDocs:["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"]}); gapiInited=true; r(); }));
                await new Promise(r=>{ tokenClient=google.accounts.oauth2.initTokenClient({client_id:c, scope:'https://www.googleapis.com/auth/drive.readonly', callback:''}); gisInited=true; r(); });
                return true;
            } catch(e) { showToast("Err Google", "error"); return false; }
        }
        function initGoogleDriveImport() {
            ensureGoogleReady().then(ok => {
                if(ok) {
                    tokenClient.callback = (r) => { if(r.error) showToast("Err Login", "error"); else createPicker(r.access_token); };
                    tokenClient.requestAccessToken({prompt: ''});
                }
            });
        }
        function createPicker(t) {
            const{k}=getKeys();
            const view = new google.picker.DocsView(google.picker.ViewId.DOCS).setIncludeFolders(true).setMimeTypes("image/png,image/jpeg,application/pdf");
            new google.picker.PickerBuilder().setDeveloperKey(k).setOAuthToken(t).addView(view).setCallback(pickerCallback).build().setVisible(true);
        }
        async function pickerCallback(d) {
            if (d.action === google.picker.Action.PICKED) {
                const doc = d.docs[0];
                document.getElementById('manualTitle').value = doc.name.replace(/\.[^/.]+$/, "");
                document.getElementById('driveStatus').classList.remove('hidden');
                document.getElementById('driveStatus').innerText = "Scarico...";
                try {
                    const t = gapi.client.getToken().access_token;
                    const res = await fetch(`https://www.googleapis.com/drive/v3/files/${doc.id}?alt=media`, { headers: {'Authorization': `Bearer ${t}`} });
                    const b = await res.blob();
                    const fr = new FileReader();
                    fr.onload = (e) => { 
                        tempDriveFile = { data: e.target.result, type: doc.mimeType };
                        document.getElementById('fileInfo').innerText = "File Drive Pronto ‚úÖ";
                        document.getElementById('driveStatus').classList.add('hidden');
                    };
                    fr.readAsDataURL(b);
                } catch(e) { showToast("Err Download", "error"); }
            }
        }

        // --- UTILS ---
        function updateCategoryDropdowns(){ const h = ALL_CATEGORIES.map(c=>`<option value="${c}">${c}</option>`).join(''); document.getElementById('newSongCategory').innerHTML = h; }
        function toggleDarkMode() { document.body.classList.toggle('dark-mode'); }
        function exportData(){ /* Logic from previous versions */ }
        function importData(){ /* Logic from previous versions */ }
        
        // PWA
        if('serviceWorker' in navigator) navigator.serviceWorker.register('./sw.js');
    </script>
</body>
</html>
