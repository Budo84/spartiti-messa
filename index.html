<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Spartiti Messa Pro</title>
    
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="logo192.png">
    <meta name="theme-color" content="#673ab7">
    
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    
    <script src="https://apis.google.com/js/api.js" async defer onload="gapiLoaded()"></script>
    <script src="https://accounts.google.com/gsi/client" async defer onload="gisLoaded()"></script>
    
    <style>
        :root { --primary: #673ab7; --bg: #f5f5f5; --white: #ffffff; --text: #333; --border: #ddd; }
        * { box-sizing: border-box; }
        body { font-family: 'Roboto', sans-serif; background: var(--bg); color: var(--text); margin: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        .app-body { flex: 1; overflow-y: auto; padding-bottom: 70px; }
        .view-section { display: none; padding: 15px; max-width: 1200px; margin: 0 auto; }
        .view-section.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .top-bar { background: var(--white); padding: 10px 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; z-index: 100; }
        .card { background: var(--white); border-radius: 10px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 15px; border: 1px solid var(--border); overflow: hidden; }
        .card-header { background: #f9fafb; padding: 10px 15px; border-bottom: 1px solid var(--border); font-weight: bold; display: flex; justify-content: space-between; align-items: center; }
        .card-body { padding: 15px; }

        .song-item, .history-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 15px; border-bottom: 1px solid #eee; cursor: pointer; background: white; }
        .song-item:active { background: #f0f0f0; }

        .status-badge { font-size: 0.75rem; padding: 2px 6px; border-radius: 4px; display: inline-flex; align-items: center; gap: 4px; margin-right: 5px; }
        .status-offline { background: #e8f5e9; color: #2e7d32; border: 1px solid #c8e6c9; }
        .status-online { background: #e3f2fd; color: #1976d2; border: 1px solid #bbdefb; }

        .chips-container { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 15px; }
        .chip-select { padding: 6px 12px; border-radius: 20px; border: 1px solid #ccc; background: white; color: #555; font-size: 0.85rem; cursor: pointer; user-select: none; }
        .chip-select.selected { background: var(--primary); color: white; border-color: var(--primary); font-weight: bold; box-shadow: 0 2px 5px rgba(103, 58, 183, 0.3); }

        .form-control { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; font-size: 1rem; margin-bottom: 10px; font-family: inherit; }
        textarea.form-control { height: 100px; resize: vertical; }
        .btn { padding: 10px 16px; border-radius: 6px; border: none; cursor: pointer; font-weight: 500; display: inline-flex; align-items: center; gap: 5px; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-outline { background: transparent; border: 1px solid #ccc; color: #555; }
        .btn-icon { background: none; border: none; font-size: 1.4rem; cursor: pointer; color: #555; padding: 5px; }
        .fab { position: fixed; bottom: 85px; right: 20px; width: 56px; height: 56px; background: var(--primary); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 10px rgba(0,0,0,0.3); border: none; cursor: pointer; z-index: 200; }

        .workspace { display: grid; gap: 20px; }
        @media(min-width: 900px) { .workspace { grid-template-columns: 1fr 1fr; } }

        .modal-wrap { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 2000; display: none; align-items: center; justify-content: center; }
        .modal-wrap.show { display: flex; }
        .modal-box { background: var(--white); width: 95%; max-width: 600px; max-height: 90vh; border-radius: 12px; display: flex; flex-direction: column; }
        .modal-scroll { flex: 1; overflow-y: auto; padding: 20px; }
        .modal-footer { padding: 15px; border-top: 1px solid var(--border); background: #fff; }

        .share-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
        .btn-share-opt { padding: 15px; border: 1px solid #ddd; border-radius: 8px; background: white; text-align: center; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 5px; }
        .btn-share-opt:active { background: #f0f0f0; }

        #readingContainer { position: fixed; inset: 0; background: var(--white); z-index: 4000; display: none; flex-direction: column; }
        #readingContainer.active { display: flex; }
        .reading-nav { height: 60px; padding: 0 15px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid var(--border); background: #fff; }
        .reading-content { flex: 1; overflow-y: auto; padding: 20px; background: #f9f9f9; }
        .score-seq-item { margin-bottom: 40px; background: white; padding: 10px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .pdf-frame { width: 100%; height: 80vh; border: none; background: #eee; }

        .nav-bar { position: fixed; bottom: 0; left: 0; width: 100%; height: 65px; background: var(--white); border-top: 1px solid var(--border); display: flex; justify-content: space-around; align-items: center; z-index: 500; }
        .nav-btn { background: none; border: none; color: #999; font-size: 0.7rem; font-weight: 500; display: flex; flex-direction: column; align-items: center; width: 100%; cursor: pointer; }
        .nav-btn.active { color: var(--primary); }
        .nav-btn span { font-size: 26px; margin-bottom: 2px; }

        #toast { position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%); background: #333; color: white; padding: 12px 24px; border-radius: 50px; z-index: 6000; opacity: 0; pointer-events: none; transition: 0.3s; }
        #toast.show { opacity: 1; bottom: 90px; }
        #toast.error { background: #ef4444; }
        .d-none { display: none !important; }
        @media print { .no-print { display: none !important; } .app-body { overflow: visible; height: auto; } #readingContainer { position: static; display: block; height: auto; } body.print-music-only #readWordArea { display: none; } body.print-readings-only #readMusicArea { display: none; } }
    </style>
</head>
<body>

    <div id="toast">Messaggio</div>

    <div class="top-bar no-print">
        <h3 style="font-size:1.2rem; font-weight:800; color:var(--primary); margin:0;">Spartiti Messa</h3>
        <button onclick="driveAction('sync')" class="btn-icon" style="color:#2e7d32;" title="Cloud Backup"><span class="material-icons-round">cloud_sync</span></button>
    </div>

    <div class="app-body">
        <div id="view-library" class="view-section active">
            <div style="display:flex; gap:10px; margin-bottom:15px;">
                <input type="text" id="searchInput" class="form-control" placeholder="üîç Cerca titolo..." onkeyup="renderLibrary()" style="margin-bottom:10px;">
                <button onclick="openEditModal()" class="btn-primary" style="white-space:nowrap;">+ Canto</button>
            </div>
            <div style="display:flex; overflow-x:auto; gap:5px; padding-bottom:10px; margin-bottom:10px;">
                <button onclick="filterLib('Tutti')" class="btn-outline">Tutti</button>
                <button onclick="filterLib('Ingresso')" class="btn-outline">Ingresso</button>
                <button onclick="filterLib('Salmo')" class="btn-outline">Salmo</button>
                <button onclick="filterLib('Offertorio')" class="btn-outline">Offertorio</button>
                <button onclick="filterLib('Comunione')" class="btn-outline">Comunione</button>
                <button onclick="filterLib('Finale')" class="btn-outline">Finale</button>
            </div>
            <div id="songList" class="card" style="border:none; background:transparent; box-shadow:none;"></div>
        </div>

        <div id="view-scaletta" class="view-section">
            <div class="card">
                <div class="card-body">
                    <input type="text" id="messaTitle" class="form-control" value="Santa Messa" style="font-weight:bold; font-size:1.2rem; border:none; padding:0; margin:0;">
                    <div style="display:flex; align-items:center; gap:10px; margin-top:10px;">
                        <input type="date" id="messaDate" class="form-control" style="width:auto; margin:0;" onchange="updateSuggestions()">
                        <button onclick="autoFetchReadings()" class="btn-outline" style="font-size:0.85rem;">‚¨áÔ∏è Letture</button>
                        <div style="flex:1; text-align:right;">
                            <button onclick="saveSetlist()" class="btn-primary">Salva</button>
                        </div>
                    </div>
                    <button onclick="startReadingMode()" class="btn-primary" style="background:#2e7d32; width:100%; margin-top:10px;">‚ñ∂ AVVIA LETTURA</button>
                </div>
            </div>
            <div class="workspace">
                <div class="card">
                    <div class="card-header">
                        <span>üéµ Canti</span>
                        <div>
                            <button onclick="openHistoryModal()" class="btn-outline" style="padding:2px 8px; font-size:0.8rem;">Storico</button>
                            <button onclick="openShareModal()" class="btn-outline" style="padding:2px 8px; font-size:0.8rem; background:#e3f2fd; color:#1565c0;">Condividi</button>
                        </div>
                    </div>
                    <div class="card-body" id="scalettaContainer"></div>
                </div>
                <div class="card">
                    <div class="card-header"><span>üìñ Liturgia</span><button onclick="clearReadings()" class="btn-outline" style="color:red; padding:2px 8px;">Pulisci</button></div>
                    <div class="card-body">
                        <label>I Lettura</label><textarea id="r1" class="form-control"></textarea>
                        <label>Salmo</label><textarea id="rps" class="form-control"></textarea>
                        <label>II Lettura</label><textarea id="r2" class="form-control"></textarea>
                        <label>Vangelo</label><textarea id="rg" class="form-control" style="height:150px;"></textarea>
                    </div>
                </div>
            </div>
        </div>

        <div id="view-history" class="view-section">
            <h2 style="color:var(--primary);">Le mie Messe</h2>
            <div id="fullHistoryList" class="card" style="border:none; background:transparent; box-shadow:none;"></div>
        </div>

        <div id="view-settings" class="view-section">
            <div class="card">
                <div class="card-header">Google API</div>
                <div class="card-body">
                    <input type="text" id="apiKey" class="form-control" placeholder="API Key">
                    <input type="text" id="clientId" class="form-control" placeholder="Client ID">
                    <button onclick="saveKeys()" class="btn-primary">Salva Chiavi</button>
                </div>
            </div>
            <div class="card">
                <div class="card-header">Cloud</div>
                <div class="card-body" style="text-align:center;">
                    <button onclick="driveAction('upload')" class="btn-primary">‚òÅÔ∏è Backup</button>
                    <button onclick="driveAction('download')" class="btn-outline">‚¨áÔ∏è Ripristina</button>
                </div>
            </div>
            <div class="card">
                <div class="card-header">Locale</div>
                <div class="card-body" style="display:flex; gap:10px;">
                    <button onclick="exportData()" class="btn-outline" style="flex:1;">Scarica</button>
                    <button onclick="document.getElementById('impFile').click()" class="btn-outline" style="flex:1;">Carica</button>
                    <input type="file" id="impFile" hidden onchange="importData(this)">
                </div>
            </div>
        </div>
    </div>

    <div class="nav-bar no-print">
        <button class="nav-btn active" onclick="go('library', this)"><span class="material-icons-round">library_music</span>Canti</button>
        <button class="nav-btn" onclick="go('scaletta', this)"><span class="material-icons-round">playlist_play</span>Messa</button>
        <button class="nav-btn" onclick="go('history', this)"><span class="material-icons-round">history</span>Messe</button>
        <button class="nav-btn" onclick="go('settings', this)"><span class="material-icons-round">settings</span>Opzioni</button>
    </div>

    <div id="viewModal" class="modal-wrap">
        <div class="modal-box">
            <div class="card-header"><span id="viewTitle">Titolo</span><div><button onclick="deleteCurrentSong()" class="btn-icon" style="color:red;">delete</button><button onclick="editFromView()" class="btn-icon">edit</button><button onclick="document.getElementById('viewModal').classList.remove('show')" class="btn-icon">close</button></div></div>
            <div class="modal-scroll" id="viewBody" style="background:#eee;"></div>
            <div class="modal-footer" id="viewFooter" style="display:none; justify-content:center;"></div>
        </div>
    </div>

    <div id="editModal" class="modal-wrap">
        <div class="modal-box">
            <div class="card-header"><span id="editModalTitle">Canto</span><button onclick="document.getElementById('editModal').classList.remove('show')" class="btn-icon">√ó</button></div>
            <div class="modal-scroll">
                <input type="hidden" id="songId">
                <label>Titolo</label><input type="text" id="songTitle" class="form-control">
                <label>Parti</label><div class="chips-container" id="catChips"></div>
                <label>Tempo</label><div class="chips-container" id="seasonChips"></div>
                <div style="background:#f0f2f5; padding:15px; border-radius:8px; text-align:center; margin:10px 0;">
                    <p id="fileStatus" style="font-weight:bold; color:var(--primary); margin:0 0 10px 0;">Nessun file</p>
                    <div style="display:flex; gap:10px; justify-content:center;">
                        <button onclick="driveAction('picker')" class="btn-outline" style="background:white;">Drive</button>
                        <button onclick="document.getElementById('localFile').click()" class="btn-outline" style="background:white;">Locale</button>
                        <button onclick="document.getElementById('folderInput').click()" class="btn-outline" style="background:white;">Cartella</button>
                    </div>
                    <div id="driveOptions" class="d-none" style="margin-top:10px;">
                        <label><input type="radio" name="storeMode" value="link" checked> Link Online</label>
                        <label><input type="radio" name="storeMode" value="full"> Scarica Offline</label>
                    </div>
                    <input type="file" id="localFile" hidden multiple onchange="handleFile(this)">
                    <input type="file" id="folderInput" hidden webkitdirectory directory onchange="handleFile(this)">
                </div>
                <label>Testo</label><textarea id="songLyrics" class="form-control"></textarea>
            </div>
            <div class="modal-footer"><button onclick="saveSong()" class="btn-primary" style="width:100%;">SALVA</button></div>
        </div>
    </div>

    <div id="syncModal" class="modal-wrap">
        <div class="modal-box" style="height:auto;">
            <div class="card-header"><span>Cloud</span><button onclick="document.getElementById('syncModal').classList.remove('show')" class="btn-icon">√ó</button></div>
            <div class="modal-scroll" style="text-align:center;">
                <button onclick="driveAction('upload')" class="btn-primary">‚òÅÔ∏è Carica Backup</button>
                <br><br>
                <button onclick="driveAction('download')" class="btn-outline">‚¨áÔ∏è Ripristina</button>
                <p id="syncStatus" style="margin-top:15px;"></p>
            </div>
        </div>
    </div>

    <div id="shareModal" class="modal-wrap">
        <div class="modal-box" style="height:auto;">
            <div class="card-header"><span>Condividi</span><button onclick="document.getElementById('shareModal').classList.remove('show')" class="btn-icon">√ó</button></div>
            <div class="modal-scroll">
                <label>INVIA TESTO</label>
                <div class="share-grid">
                    <button class="btn-share-opt" onclick="shareText('list')">Scaletta</button>
                    <button class="btn-share-opt" onclick="shareText('read')">Letture</button>
                    <button class="btn-share-opt" onclick="shareText('all')">Tutto</button>
                </div>
                <hr>
                <label>STAMPA / PDF</label>
                <div class="share-grid">
                    <button class="btn-share-opt" onclick="printMode('all')">Completo</button>
                    <button class="btn-share-opt" onclick="printMode('music')">Canti</button>
                    <button class="btn-share-opt" onclick="printMode('read')">Letture</button>
                </div>
            </div>
        </div>
    </div>

    <div id="historyModal" class="modal-wrap">
        <div class="modal-box" style="height:70vh;">
            <div class="card-header"><span>Storico</span><button onclick="document.getElementById('historyModal').classList.remove('show')" class="btn-icon">√ó</button></div>
            <div class="modal-scroll" id="historyList"></div>
        </div>
    </div>

    <div id="readingContainer">
        <div class="reading-nav no-print">
            <button onclick="stopReadingMode()" class="btn-icon" style="color:red;">‚Üê ESCI</button>
            <div style="display:flex; gap:10px;">
                <button onclick="setReadTab('music')" class="btn-outline" id="rtab-music">Canti</button>
                <button onclick="setReadTab('word')" class="btn-outline" id="rtab-word">Letture</button>
            </div>
            <div style="width:40px;"></div>
        </div>
        <div class="reading-content">
            <div id="readMusicArea"></div>
            <div id="readWordArea" class="d-none" style="max-width:800px; margin:0 auto; font-size:1.2rem; line-height:1.6;"></div>
        </div>
    </div>

    <script>
        // --- CONFIGURAZIONE ---
        let db; let tempFilesList=[]; let currentSongId=null; let driveTempMeta=null;
        let tokenClient; let gapiInited=false; let gisInited=false;
        const CATS = ["Ingresso", "Gloria", "Salmo", "Alleluia", "Offertorio", "Santo", "Comunione", "Finale", "Altro"];
        const SEASONS = ["Ordinario", "Avvento", "Natale", "Quaresima", "Pasqua"];
        const SYNC_FILE_NAME = "spartiti_db_master.json";
        let filterCatVar = 'Tutti';

        // --- INIT GOOGLE & DB ---
        function gapiLoaded() {
            gapi.load('client:picker', async () => {
                const k = localStorage.getItem('g_api');
                if(k) await gapi.client.init({ apiKey: k, discoveryDocs: ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"] });
                gapiInited = true;
            });
        }
        function gisLoaded() {
            const c = localStorage.getItem('g_client');
            if(c) {
                tokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: c, scope: 'https://www.googleapis.com/auth/drive.file https://www.googleapis.com/auth/drive.readonly',
                    callback: '' 
                });
                gisInited = true;
            }
        }

        window.onload = () => {
            document.getElementById('messaDate').valueAsDate = new Date();
            document.getElementById('apiKey').value = localStorage.getItem('g_api')||"";
            document.getElementById('clientId').value = localStorage.getItem('g_client')||"";
            
            // Registra Service Worker se non presente
            if ('serviceWorker' in navigator) navigator.serviceWorker.register('./sw.js');

            const r = indexedDB.open("SpartitiDB_V5", 1);
            r.onupgradeneeded = (e) => {
                db = e.target.result;
                if(!db.objectStoreNames.contains("songs")) db.createObjectStore("songs", {keyPath:"id", autoIncrement:true});
                if(!db.objectStoreNames.contains("setlists")) db.createObjectStore("setlists", {keyPath:"id", autoIncrement:true});
            };
            r.onsuccess = (e) => { 
                db=e.target.result; 
                renderLibrary(); 
                renderScalettaUI(); 
                renderFullHistory(); 
                // Forza caricamento Google se chiavi presenti
                const k=localStorage.getItem('g_api'); const c=localStorage.getItem('g_client');
                if(k && c) { if(window.gapi) gapiLoaded(); if(window.google) gisLoaded(); }
            };
            renderModalChips();
        };

        // --- GOOGLE DRIVE LOGIC (FIXED) ---
        function saveKeys(){
            localStorage.setItem('g_api',document.getElementById('apiKey').value);
            localStorage.setItem('g_client',document.getElementById('clientId').value);
            showToast("Salvate! Ricarico..."); setTimeout(()=>location.reload(), 1000);
        }

        async function driveAction(action, id=null) {
            if(!gapiInited || !gisInited) {
                // Tenta reinizializzazione al volo
                const k=localStorage.getItem('g_api'); const c=localStorage.getItem('g_client');
                if(!k || !c) return showToast("Mancano Chiavi API", "error");
                gapiLoaded(); gisLoaded();
                showToast("Connessione... Riprova tra 2 sec");
                return;
            }
            
            // Chiudi modali per evitare conflitti grafici
            document.querySelectorAll('.modal-wrap').forEach(m => m.classList.remove('show'));
            if(action === 'sync') document.getElementById('syncModal').classList.add('show');

            const token = gapi.client.getToken();
            if(token && Date.now() < token.expires_at) {
                executeDriveAction(action, id);
            } else {
                tokenClient.callback = (r) => {
                    if(r.error) return showToast("Errore Login", "error");
                    r.expires_at = Date.now() + (r.expires_in * 1000);
                    gapi.client.setToken(r);
                    executeDriveAction(action, id);
                };
                tokenClient.requestAccessToken({prompt: ''});
            }
        }

        async function executeDriveAction(action, id) {
            if(!gapi.client.drive) await gapi.client.load('drive', 'v3');
            
            if(action === 'picker') createPicker(gapi.client.getToken().access_token);
            else if(action === 'upload') performUpload();
            else if(action === 'download') performDownload();
            else if(action === 'downloadOne') downloadSingleSong(id);
            else if(action === 'sync') document.getElementById('syncModal').classList.add('show');
        }

        function createPicker(t) {
            const k = localStorage.getItem('g_api');
            const view = new google.picker.DocsView(google.picker.ViewId.DOCS).setIncludeFolders(true).setMimeTypes("application/pdf,image/png,image/jpeg");
            new google.picker.PickerBuilder().setDeveloperKey(k).setOAuthToken(t).addView(view).enableFeature(google.picker.Feature.MULTISELECT_ENABLED).setCallback(pickerCallback).build().setVisible(true);
        }

        async function pickerCallback(d) {
            if(d.action === google.picker.Action.PICKED) {
                tempFilesList = [];
                document.getElementById('editModal').classList.add('show');
                document.getElementById('fileStatus').innerText = "Download...";
                const t = gapi.client.getToken().access_token;
                
                for(let doc of d.docs) {
                    try {
                        const r = await fetch(`https://www.googleapis.com/drive/v3/files/${doc.id}?alt=media`,{headers:{'Authorization':`Bearer ${t}`}});
                        const b = await r.blob();
                        const base64 = await new Promise(res => { const fr=new FileReader(); fr.onload=e=>res(e.target.result); fr.readAsDataURL(b); });
                        tempFilesList.push({ name: doc.name.replace(/\.[^/.]+$/,""), id: doc.id, type: doc.mimeType, data: base64, source: 'drive' });
                    } catch(e) { console.log(e); }
                }
                
                document.getElementById('fileStatus').innerText = `${tempFilesList.length} File Drive OK`;
                document.getElementById('driveOptions').classList.remove('d-none');
                if(tempFilesList.length === 1) {
                    document.getElementById('songTitle').value = tempFilesList[0].name;
                    driveTempMeta = tempFilesList[0];
                } else document.getElementById('songTitle').value = "[Multiplo]";
            } else if (d.action === google.picker.Action.CANCEL) {
                document.getElementById('editModal').classList.add('show');
            }
        }

        async function performUpload() {
            document.getElementById('syncStatus').innerText = "Caricamento...";
            const tx = db.transaction(["songs","setlists"],"readonly");
            const s = await new Promise(r=>tx.objectStore("songs").getAll().onsuccess=e=>r(e.target.result));
            const l = await new Promise(r=>tx.objectStore("setlists").getAll().onsuccess=e=>r(e.target.result));
            const fileContent = JSON.stringify({songs:s, setlists:l});
            const meta = { name: SYNC_FILE_NAME, mimeType: 'application/json' };
            const form = new FormData(); 
            form.append('metadata', new Blob([JSON.stringify(meta)], {type:'application/json'})); 
            form.append('file', new Blob([fileContent], {type:'application/json'}));

            try {
                const q = `name = '${SYNC_FILE_NAME}' and trashed = false`;
                const list = await gapi.client.drive.files.list({q:q, fields:'files(id)'});
                if(list.result.files.length > 0) {
                    await fetch(`https://www.googleapis.com/upload/drive/v3/files/${list.result.files[0].id}?uploadType=media`, {
                        method: 'PATCH', headers: {'Authorization': `Bearer ${gapi.client.getToken().access_token}`, 'Content-Type': 'application/json'}, body: fileContent
                    });
                } else {
                    await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                        method: 'POST', headers: {'Authorization': `Bearer ${gapi.client.getToken().access_token}`}, body: form
                    });
                }
                document.getElementById('syncStatus').innerText = "Backup OK ‚úÖ"; showToast("Backup Completato!");
            } catch(e) { document.getElementById('syncStatus').innerText = "Errore"; }
        }

        async function performDownload() {
            document.getElementById('syncStatus').innerText = "Ricerca...";
            try {
                const q = `name = '${SYNC_FILE_NAME}' and trashed = false`;
                const list = await gapi.client.drive.files.list({q:q, fields:'files(id)'});
                if(list.result.files.length === 0) return document.getElementById('syncStatus').innerText = "Nessun Backup";
                
                const res = await gapi.client.drive.files.get({fileId: list.result.files[0].id, alt: 'media'});
                const data = res.result;
                
                const tx = db.transaction(["songs","setlists"],"readwrite");
                await new Promise(r=>tx.objectStore("songs").clear().onsuccess=r);
                await new Promise(r=>tx.objectStore("setlists").clear().onsuccess=r);
                data.songs.forEach(s=>tx.objectStore("songs").put(s));
                data.setlists.forEach(s=>tx.objectStore("setlists").put(s));
                
                tx.oncomplete = () => { document.getElementById('syncStatus').innerText = "Ripristinato! ‚úÖ"; showToast("Fatto!"); setTimeout(()=>location.reload(), 1500); };
            } catch(e) { document.getElementById('syncStatus').innerText = "Errore"; }
        }

        // --- CORE UI ---
        function renderModalChips() {
            document.getElementById('catChips').innerHTML = CATS.map(c => `<div class="chip-select" onclick="this.classList.toggle('selected')" data-val="${c}">${c}</div>`).join('');
            document.getElementById('seasonChips').innerHTML = SEASONS.map(s => `<div class="chip-select" onclick="this.classList.toggle('selected')" data-val="${s}">${s}</div>`).join('');
        }
        function go(id, btn) {
            document.querySelectorAll('.view-section').forEach(x=>x.classList.remove('active'));
            document.getElementById('view-'+id).classList.add('active');
            document.querySelectorAll('.nav-btn').forEach(x=>x.classList.remove('active'));
            if(btn) btn.classList.add('active');
            if(id==='library') renderLibrary();
            if(id==='history') renderFullHistory();
        }
        function filterLib(cat) { filterCatVar=cat; renderLibrary(); }
        function renderLibrary() {
            const list = document.getElementById('songList'); list.innerHTML="";
            const txt = document.getElementById('searchInput').value.toLowerCase();
            const tx = db.transaction("songs","readonly");
            tx.objectStore("songs").openCursor().onsuccess = (e) => {
                const c = e.target.result;
                if(c) {
                    const s = c.value;
                    const cats = Array.isArray(s.categories) ? s.categories : [s.category];
                    let ok = true;
                    if(filterCatVar!=='Tutti' && !cats.includes(filterCatVar)) ok=false;
                    if(txt && !s.title.toLowerCase().includes(txt)) ok=false;
                    if(ok) {
                        const isOffline = s.fileData ? true : false;
                        const badge = isOffline ? `<span class="status-badge status-offline">Offline</span>` : `<span class="status-badge status-online">Online</span>`;
                        list.innerHTML += `<div class="song-item" onclick="openViewModal(${s.id})"><div><div style="font-weight:bold;">${s.title}</div><div>${badge} <small>${cats.join(', ')}</small></div></div></div>`;
                    }
                    c.continue();
                }
            }
        }

        // --- SONG MANAGEMENT ---
        function openEditModal(id=null) {
            document.getElementById('editModal').classList.add('show');
            document.getElementById('songId').value = ""; document.getElementById('songTitle').value = ""; document.getElementById('songLyrics').value = "";
            tempFilesList=[]; driveTempMeta=null;
            document.getElementById('fileStatus').innerText = "Nessun file";
            document.getElementById('driveOptions').classList.add('d-none');
            document.querySelectorAll('.chip-select').forEach(c => c.classList.remove('selected'));
            document.getElementById('editModalTitle').innerText = id ? "Modifica" : "Nuovo";

            if(id) {
                document.getElementById('songId').value = id;
                db.transaction("songs").objectStore("songs").get(id).onsuccess = (e) => {
                    const s = e.target.result;
                    document.getElementById('songTitle').value = s.title;
                    document.getElementById('songLyrics').value = s.lyrics || "";
                    if(s.fileData) { tempFilesList=[{data:s.fileData, type:s.type, name:s.title}]; document.getElementById('fileStatus').innerText = "File Presente"; }
                    else if(s.driveId) document.getElementById('fileStatus').innerText = "File Drive";
                    // Restore chips logic needed here
                }
            }
        }

        function handleFile(input) {
            const files = input.files; if(!files.length) return;
            tempFilesList = []; document.getElementById('fileStatus').innerText = "Lettura...";
            const readFile = (f) => new Promise(r => { const rd=new FileReader(); rd.onload=e=>r({name:f.name.replace(/\.[^/.]+$/,""), type:f.type, data:e.target.result}); rd.readAsDataURL(f); });
            Promise.all(Array.from(files).map(f => readFile(f))).then(res => {
                tempFilesList = res;
                if(tempFilesList.length===1) { document.getElementById('songTitle').value = tempFilesList[0].name; }
                else document.getElementById('songTitle').value = "[Multiplo]";
                document.getElementById('fileStatus').innerText = `${tempFilesList.length} File Locali`;
            });
        }

        function saveSong() {
            if(tempFilesList.length===0 && !driveTempMeta && !document.getElementById('songLyrics').value && !document.getElementById('songId').value) return alert("Mancano dati");
            
            const cats = Array.from(document.querySelectorAll('#catChips .selected')).map(c => c.dataset.val);
            if(cats.length===0) cats.push("Altro");
            const seas = Array.from(document.querySelectorAll('#seasonChips .selected')).map(c => c.dataset.val);
            if(seas.length===0) seas.push("Ordinario");
            
            const lyrics = document.getElementById('songLyrics').value;
            const editId = document.getElementById('songId').value;
            const tx = db.transaction("songs","readwrite"); const store = tx.objectStore("songs");

            if(driveTempMeta) {
                const mode = document.querySelector('input[name="storeMode"]:checked').value;
                const s = { title: document.getElementById('songTitle').value, categories: cats, seasons: seas, lyrics: lyrics, driveId: driveTempMeta.id, type: driveTempMeta.type, fileData: mode==='full' ? driveTempMeta.data : null };
                if(editId) s.id = Number(editId); store.put(s);
            } else if (tempFilesList.length > 0) {
                if(tempFilesList.length === 1 && editId) {
                     store.put({ id: Number(editId), title: document.getElementById('songTitle').value, categories: cats, seasons: seas, lyrics: lyrics, fileData: tempFilesList[0].data, type: tempFilesList[0].type });
                } else {
                    tempFilesList.forEach(f => {
                         const data = f.source === 'drive' ? (document.querySelector('input[name="storeMode"]:checked').value==='full' ? f.data : null) : f.data;
                         const drvId = f.source === 'drive' ? f.id : null;
                         store.add({ title: f.name, categories: cats, seasons: seas, lyrics: "", fileData: data, type: f.type, driveId: drvId });
                    });
                }
            } else if (editId) {
                store.get(Number(editId)).onsuccess = e => { const old = e.target.result; store.put({...old, title: document.getElementById('songTitle').value, lyrics: lyrics, categories: cats, seasons: seas}); };
            } else {
                 store.add({ title: document.getElementById('songTitle').value, categories: cats, seasons: seas, lyrics: lyrics, fileData: null, type: null });
            }
            tx.oncomplete = () => { document.getElementById('editModal').classList.remove('show'); renderLibrary(); updateSuggestions(); showToast("Salvato!"); };
        }

        // --- VIEWER & DOWNLOAD ---
        function openViewModal(id) {
            currentSongId = id;
            db.transaction("songs", "readwrite").objectStore("songs").get(id).onsuccess = (e) => {
                const s = e.target.result;
                document.getElementById('viewTitle').innerText = s.title;
                const b = document.getElementById('viewBody');
                const f = document.getElementById('viewFooter');
                f.style.display = 'flex';
                
                if (s.fileData) {
                    b.innerHTML = s.type.includes('pdf') ? `<iframe src="${s.fileData}" style="width:100%; height:100%; border:none;"></iframe>` : `<img src="${s.fileData}" style="width:100%">`;
                    f.innerHTML = s.driveId ? `<button onclick="toggleDownload(${s.id}, false)" class="btn-outline" style="border-color:orange; color:orange;">Rimuovi Download</button>` : '';
                } else if (s.driveId) {
                    b.innerHTML = `<div style="text-align:center; padding:50px;">File Online</div>`;
                    f.innerHTML = `<button onclick="toggleDownload(${s.id}, true)" class="btn-primary">‚¨áÔ∏è Scarica</button>`;
                } else {
                    b.innerHTML = `<pre style="padding:20px; white-space:pre-wrap;">${s.lyrics}</pre>`;
                    f.innerHTML = '';
                }
                
                // Add Edit/Delete buttons to header logic in HTML
                document.getElementById('viewModal').classList.add('show');
            }
        }

        async function toggleDownload(id, dl) {
            if(dl) driveAction('downloadOne', id);
            else {
                const tx = db.transaction("songs", "readwrite");
                tx.objectStore("songs").get(id).onsuccess = e => {
                    const s = e.target.result; s.fileData = null;
                    tx.objectStore("songs").put(s).onsuccess = () => { showToast("Liberato"); openViewModal(id); renderLibrary(); };
                };
            }
        }

        async function downloadSingleSong(id) {
             const tx = db.transaction("songs", "readwrite");
             tx.objectStore("songs").get(id).onsuccess = async (e) => {
                 const s = e.target.result;
                 try {
                     const t = gapi.client.getToken().access_token;
                     const r = await fetch(`https://www.googleapis.com/drive/v3/files/${s.driveId}?alt=media`,{headers:{'Authorization':`Bearer ${t}`}});
                     const b = await r.blob();
                     const fr = new FileReader();
                     fr.onload = (ev) => {
                         s.fileData = ev.target.result;
                         const tx2 = db.transaction("songs", "readwrite");
                         tx2.objectStore("songs").put(s).onsuccess = () => { showToast("Scaricato!"); openViewModal(id); renderLibrary(); };
                     };
                     fr.readAsDataURL(b);
                 } catch(err) { alert("Err: "+err); }
             };
        }

        function deleteCurrentSong() { if(confirm("Eliminare?")) db.transaction("songs","readwrite").objectStore("songs").delete(currentSongId).onsuccess = () => { document.getElementById('viewModal').classList.remove('show'); renderLibrary(); }; }
        function editFromView() { document.getElementById('viewModal').classList.remove('show'); openEditModal(currentSongId); }

        // --- LETTURE & SCALETTA ---
        function renderScalettaUI() {
            const c = document.getElementById('scalettaContainer'); c.innerHTML = "";
            CATS.forEach(cat => { if(cat === 'Altro') return; c.innerHTML += `<div style="margin-bottom:10px;" data-part="${cat}"><label style="font-size:0.8rem; font-weight:bold; color:#666;">${cat}</label><div style="display:flex; gap:5px;"><select class="form-control song-select" style="margin:0;"><option value="">Seleziona...</option></select><button onclick="this.previousElementSibling.value=''" class="btn-outline">X</button></div></div>`; });
            setTimeout(updateSuggestions, 500);
        }
        function updateSuggestions() {
            const d = new Date(document.getElementById('messaDate').value); const m = d.getMonth()+1; const day = d.getDate();
            let season = "Ordinario"; if (m===11&&day>=27||m===12&&day<=24) season="Avvento"; else if (m===12&&day>=25||m===1) season="Natale"; else if (m>=2&&m<=4) season="Quaresima"; else if (m===4||m===5) season="Pasqua";
            db.transaction("songs").objectStore("songs").getAll().onsuccess=(e)=>{
                const songs = e.target.result.sort((a,b)=>a.title.localeCompare(b.title));
                document.querySelectorAll('.song-select').forEach(sel=>{
                    const part=sel.parentElement.parentElement.dataset.part; const old=sel.value; let sug="", oth="";
                    songs.forEach(s=>{
                        const cats = Array.isArray(s.categories)?s.categories:[s.category]; const seas = Array.isArray(s.seasons)?s.seasons:[s.season];
                        if(cats.includes(part)&&(seas.includes(season)||seas.includes("Tutti"))) sug+=`<option value="${s.id}">‚òÖ ${s.title}</option>`; else oth+=`<option value="${s.id}">${s.title}</option>`;
                    });
                    sel.innerHTML=`<option value="">Seleziona...</option><optgroup label="Suggeriti (${season})">${sug}</optgroup><optgroup label="Altri">${oth}</optgroup>`; sel.value=old;
                });
            }
        }
        async function autoFetchReadings() {
            const dStr = document.getElementById('messaDate').value; if(!dStr) return alert("Data?");
            const d = new Date(dStr);
            const url = `https://api.allorigins.win/get?url=${encodeURIComponent(`https://www.lachiesa.it/calendario/Detailed/${d.getFullYear()}${String(d.getMonth()+1).padStart(2,'0')}${String(d.getDate()).padStart(2,'0')}.shtml`)}`;
            showToast("Ricerca...");
            try {
                const r = await fetch(url); const j = await r.json(); if(!j.contents) throw "Err";
                const t = new DOMParser().parseFromString(j.contents,"text/html").body.innerText.replace(/\s+/g,' ');
                const find=(a,b)=>{let s=-1;for(let w of a){let i=t.toLowerCase().indexOf(w.toLowerCase());if(i>-1){s=i+w.length;break;}}if(s<0)return"";let e=-1;for(let w of b){let i=t.toLowerCase().indexOf(w.toLowerCase(),s);if(i>-1){e=i;break;}}return e<0?"":t.substring(s,e).trim();};
                document.getElementById('r1').value=find(["Prima Lettura","Dagli Atti","1a Lettura"],["Salmo"]);
                document.getElementById('rps').value=find(["Salmo Responsoriale","Salmo"],["Seconda","Vangelo","2a Lettura"]);
                document.getElementById('r2').value=find(["Seconda Lettura","2a Lettura"],["Vangelo","Canto al Vangelo"]);
                document.getElementById('rg').value=find(["Vangelo","Dal Vangelo"],["PREGHIERA","Sulle Offerte"]);
                showToast("Fatto!");
            } catch(e) { window.open(`https://www.lachiesa.it/calendario/Detailed/${d.getFullYear()}${String(d.getMonth()+1).padStart(2,'0')}${String(d.getDate()).padStart(2,'0')}.shtml`); }
        }
        function saveSetlist() {
            const sel={};document.querySelectorAll('.song-select').forEach(s=>{if(s.value)sel[s.parentElement.parentElement.dataset.part]=s.value;});
            const r={r1:document.getElementById('r1').value,rps:document.getElementById('rps').value,r2:document.getElementById('r2').value,rg:document.getElementById('rg').value};
            db.transaction("setlists","readwrite").objectStore("setlists").add({title:document.getElementById('messaTitle').value,date:document.getElementById('messaDate').value,songs:sel,readings:r}).onsuccess=()=>{showToast("Messa Salvata!");renderFullHistory();};
        }
        function renderFullHistory() {
            const l=document.getElementById('fullHistoryList');l.innerHTML="";
            db.transaction("setlists").objectStore("setlists").openCursor(null,'prev').onsuccess=e=>{const c=e.target.result;if(c){const s=c.value;l.innerHTML+=`<div class="history-item"><div onclick="loadSet(${s.id})" style="flex:1;"><b>${s.title}</b><br><small>${s.date}</small></div><button onclick="delSet(${s.id})" class="btn-icon" style="color:red;">delete</button></div>`;c.continue();}}
        }
        function loadSet(id) {
            db.transaction("setlists").objectStore("setlists").get(id).onsuccess=e=>{
                const s=e.target.result;document.getElementById('messaTitle').value=s.title;document.getElementById('messaDate').value=s.date;
                if(s.readings){document.getElementById('r1').value=s.readings.r1||"";document.getElementById('rps').value=s.readings.rps||"";document.getElementById('r2').value=s.readings.r2||"";document.getElementById('rg').value=s.readings.rg||"";}
                document.querySelectorAll('.song-select').forEach(sel=>sel.value="");
                for(let[k,v]of Object.entries(s.songs)){const el=document.querySelector(`div[data-part="${k}"] select`);if(el)el.value=v;}
                go('scaletta');
            }
        }
        function delSet(id) { if(confirm("Eliminare?")) db.transaction("setlists","readwrite").objectStore("setlists").delete(id).onsuccess = () => renderFullHistory(); }
        function clearReadings(){ ['r1','rps','r2','rg'].forEach(i=>document.getElementById(i).value=""); }

        // READING, SHARE & EXPORT
        function startReadingMode() {
            document.getElementById('readingContainer').classList.add('active'); const mc=document.getElementById('readMusicArea'); mc.innerHTML=""; const wc=document.getElementById('readWordArea'); wc.innerHTML="";
            document.querySelectorAll('.song-select').forEach(s=>{ if(s.value){ db.transaction("songs").objectStore("songs").get(Number(s.value)).onsuccess=e=>{ const x=e.target.result; 
                let h=""; if(x.fileData) h=x.type.includes('pdf')?`<iframe src="${x.fileData}" class="pdf-frame"></iframe>`:`<img src="${x.fileData}" style="width:100%">`; else if(x.driveId) h=`<div style="text-align:center; padding:50px;">Solo Online</div>`; else h=`<pre style="white-space:pre-wrap;">${x.lyrics}</pre>`;
                mc.innerHTML+=`<div class="score-seq-item"><h3>${x.title}</h3>${h}</div>`;
            }}});
            const r=[{t:"I",v:document.getElementById('r1').value},{t:"Salmo",v:document.getElementById('rps').value},{t:"II",v:document.getElementById('r2').value},{t:"Vangelo",v:document.getElementById('rg').value}];
            r.forEach(x=>{if(x.v)wc.innerHTML+=`<div style="margin-bottom:30px;"><h3>${x.t}</h3><p>${x.v}</p></div>`;});
        }
        function stopReadingMode(){document.getElementById('readingContainer').classList.remove('active');}
        function setReadTab(t){document.getElementById('readMusicArea').className=t==='music'?'':'d-none';document.getElementById('readWordArea').className=t==='word'?'':'d-none';}
        function openShareModal(){ document.getElementById('shareModal').classList.add('show'); }
        function shareText(mode) {
            const t=document.getElementById('messaTitle').value; let txt=`üìÖ *${t}*\n\n`;
            if(mode!=='read') document.querySelectorAll('.song-select').forEach(s=>{if(s.selectedIndex>0)txt+=`üéµ ${s.options[s.selectedIndex].text}\n`});
            if(mode!=='list') txt+=`\nüìñ ${document.getElementById('rg').value.substring(0,100)}...`;
            window.open(`https://wa.me/?text=${encodeURIComponent(txt)}`);
        }
        function printMode(mode){ 
            document.body.className = ""; if(mode==='music') document.body.classList.add('print-music-only'); if(mode==='read') document.body.classList.add('print-readings-only');
            startReadingMode(); setTimeout(()=>window.print(),2000); 
        }
        function optimizeStorage(){ if(confirm("Rimuovere download inutilizzati?")) showToast("Fatto!"); }
        function exportData(){
            const tx = db.transaction(["songs", "setlists"], "readonly");
            Promise.all([
                new Promise(r => tx.objectStore("songs").getAll().onsuccess = e => r(e.target.result)),
                new Promise(r => tx.objectStore("setlists").getAll().onsuccess = e => r(e.target.result))
            ]).then(([songs, setlists]) => {
                const blob = new Blob([JSON.stringify({songs, setlists})], {type: "application/json"});
                const a = document.createElement("a"); a.href = URL.createObjectURL(blob); a.download = "backup.json"; a.click();
            });
        }
        function importData(input){
            const file = input.files[0]; if(!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    const tx = db.transaction(["songs", "setlists"], "readwrite");
                    tx.objectStore("songs").clear(); tx.objectStore("setlists").clear();
                    data.songs.forEach(s => tx.objectStore("songs").put(s));
                    data.setlists.forEach(s => tx.objectStore("setlists").put(s));
                    tx.oncomplete = () => { showToast("Ripristinato!"); setTimeout(()=>location.reload(), 1000); };
                } catch(err) { alert("Err file"); }
            };
            reader.readAsText(file);
        }
        function showToast(m,type="info"){ const t=document.getElementById('toast');t.innerText=m;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),3000); }
    </script>
</body>
</html>
