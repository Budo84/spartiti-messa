<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Spartiti Messa Pro</title>
    
    <link rel="stylesheet" href="style.css">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="logo192.png">
    <meta name="theme-color" content="#673ab7">
    
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client"></script>
    
    <style>
        /* --- CORE CSS --- */
        :root { --primary: #673ab7; --bg: #f5f5f5; --white: #ffffff; --text: #333; --border: #ddd; }
        * { box-sizing: border-box; }
        body { font-family: 'Roboto', sans-serif; background: var(--bg); color: var(--text); margin: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        /* APP SHELL */
        .app-body { flex: 1; overflow-y: auto; position: relative; padding-bottom: 70px; }
        .view-section { display: none; padding: 15px; max-width: 1200px; margin: 0 auto; }
        .view-section.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* HEADER */
        .top-bar { background: var(--white); padding: 10px 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); display: flex; align-items: center; justify-content: space-between; z-index: 100; }
        
        /* CARDS & LISTS */
        .card { background: var(--white); border-radius: 10px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 15px; border: 1px solid var(--border); overflow: hidden; }
        .card-header { background: #f8f9fa; padding: 12px 15px; font-weight: bold; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .card-body { padding: 15px; }

        .song-item, .history-item { display: flex; justify-content: space-between; align-items: center; padding: 15px; border-bottom: 1px solid #eee; cursor: pointer; transition: background 0.2s; background: white; }
        .song-item:active { background: #f0f0f0; }

        /* CHIPS (TAGS) */
        .chips-container { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 15px; }
        .chip-select { padding: 6px 12px; border-radius: 20px; border: 1px solid #ccc; background: white; color: #555; font-size: 0.85rem; cursor: pointer; user-select: none; }
        .chip-select.selected { background: var(--primary); color: white; border-color: var(--primary); font-weight: bold; box-shadow: 0 2px 5px rgba(103, 58, 183, 0.3); }

        /* INPUTS */
        .form-control { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; font-size: 1rem; margin-bottom: 10px; font-family: inherit; }
        textarea.form-control { resize: vertical; min-height: 100px; }

        /* MODAL (OVERLAY) */
        .modal-wrap { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 3000; display: none; align-items: center; justify-content: center; }
        .modal-wrap.show { display: flex; }
        .modal-box { background: var(--white); width: 95%; max-width: 600px; height: 90vh; border-radius: 12px; display: flex; flex-direction: column; box-shadow: 0 20px 25px rgba(0,0,0,0.2); }
        .modal-header { padding: 15px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; font-weight: bold; }
        .modal-scroll { flex: 1; overflow-y: auto; padding: 20px; }
        .modal-footer { padding: 15px; border-top: 1px solid var(--border); background: #fff; }

        /* READING MODE */
        #readingContainer { position: fixed; inset: 0; background: var(--white); z-index: 4000; display: none; flex-direction: column; }
        #readingContainer.active { display: flex; }
        .reading-nav { height: 60px; padding: 0 15px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid var(--border); background: #fff; }
        .reading-content { flex: 1; overflow-y: auto; padding: 20px; background: #f9f9f9; }
        .score-seq-item { margin-bottom: 40px; background: white; padding: 10px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .pdf-frame { width: 100%; height: 80vh; border: none; background: #eee; }

        /* NAV BAR */
        .nav-bar { position: fixed; bottom: 0; left: 0; width: 100%; height: 65px; background: var(--white); border-top: 1px solid var(--border); display: flex; justify-content: space-around; align-items: center; z-index: 500; }
        .nav-btn { background: none; border: none; color: #999; font-size: 0.7rem; font-weight: 500; display: flex; flex-direction: column; align-items: center; width: 100%; cursor: pointer; }
        .nav-btn.active { color: var(--primary); }
        .nav-btn span { font-size: 26px; margin-bottom: 2px; }

        /* BUTTONS */
        .btn { padding: 8px 16px; border-radius: 6px; border: none; cursor: pointer; font-weight: 600; display: inline-flex; align-items: center; gap: 5px; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-outline { background: transparent; border: 1px solid #ccc; color: #555; }
        .btn-icon { background: none; border: none; font-size: 1.4rem; padding: 5px; cursor: pointer; color: #555; }
        .fab { position: fixed; bottom: 85px; right: 20px; width: 56px; height: 56px; background: var(--primary); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 10px rgba(0,0,0,0.3); border: none; cursor: pointer; z-index: 200; }

        /* GRID SYSTEM */
        .workspace { display: grid; gap: 20px; grid-template-columns: 1fr; }
        @media(min-width: 900px) { .workspace { grid-template-columns: 1fr 1fr; } }

        /* TOAST */
        #toast { position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%); background: #333; color: white; padding: 12px 24px; border-radius: 50px; z-index: 6000; opacity: 0; pointer-events: none; transition: 0.3s; }
        #toast.show { opacity: 1; bottom: 90px; }

        .d-none { display: none !important; }
    </style>
</head>
<body>

    <div id="toast">Messaggio</div>

    <div class="top-bar no-print">
        <h1 style="font-size:1.2rem; font-weight:800; color:var(--primary); margin:0;">Spartiti Messa</h1>
        <div style="display:flex; gap:10px;">
            <button onclick="openSyncModal()" class="btn-icon" style="color:#2e7d32;" title="Backup Cloud"><span class="material-icons-round">cloud_sync</span></button>
        </div>
    </div>

    <div class="app-body">
        
        <div id="view-library" class="view-section active">
            <div style="background:white; padding:10px; border-radius:10px; box-shadow:0 1px 3px rgba(0,0,0,0.1); margin-bottom:15px;">
                <input type="text" id="searchInput" class="form-control" placeholder="üîç Cerca titolo..." onkeyup="renderLibrary()" style="margin-bottom:10px;">
                <div style="display:flex; overflow-x:auto; gap:5px; padding-bottom:5px;">
                    <button onclick="filterLib('Tutti')" class="btn-outline" style="padding:5px 10px; font-size:0.8rem;">Tutti</button>
                    <button onclick="filterLib('Ingresso')" class="btn-outline" style="padding:5px 10px; font-size:0.8rem;">Ingresso</button>
                    <button onclick="filterLib('Salmo')" class="btn-outline" style="padding:5px 10px; font-size:0.8rem;">Salmo</button>
                    <button onclick="filterLib('Offertorio')" class="btn-outline" style="padding:5px 10px; font-size:0.8rem;">Offertorio</button>
                    <button onclick="filterLib('Comunione')" class="btn-outline" style="padding:5px 10px; font-size:0.8rem;">Comunione</button>
                    <button onclick="filterLib('Finale')" class="btn-outline" style="padding:5px 10px; font-size:0.8rem;">Finale</button>
                </div>
            </div>
            <div id="songList" class="card" style="border:none; background:transparent; box-shadow:none;"></div>
            <button class="fab no-print" onclick="openEditModal()"><span class="material-icons-round">add</span></button>
        </div>

        <div id="view-scaletta" class="view-section">
            <div class="card">
                <div class="card-body">
                    <input type="text" id="messaTitle" class="form-control" value="Santa Messa" style="font-weight:bold; font-size:1.2rem; border:none; padding:0; margin:0;">
                    <div style="display:flex; align-items:center; gap:10px; margin-top:10px;">
                        <input type="date" id="messaDate" class="form-control" style="width:auto; margin:0;" onchange="updateSuggestions()">
                        <button onclick="autoFetchReadings()" class="btn-outline" style="font-size:0.85rem;">‚¨áÔ∏è Scarica Letture</button>
                    </div>
                    <div style="margin-top:10px; display:flex; justify-content:space-between;">
                        <button onclick="saveSetlist()" class="btn-primary">Salva Tutto</button>
                        <button onclick="startReadingMode()" class="btn-primary" style="background:#2e7d32;">‚ñ∂ AVVIA LETTURA</button>
                    </div>
                </div>
            </div>

            <div class="workspace">
                <div class="card">
                    <div class="card-header"><span>üéµ Scaletta Canti</span></div>
                    <div class="card-body" id="scalettaContainer"></div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <span>üìñ Liturgia</span>
                        <button onclick="clearReadings()" class="btn-outline" style="padding:4px 8px; font-size:0.8rem; color:red;">Pulisci</button>
                    </div>
                    <div class="card-body">
                        <label style="font-size:0.8rem; font-weight:bold; color:#666;">I Lettura</label>
                        <textarea id="r1" class="form-control"></textarea>
                        <label style="font-size:0.8rem; font-weight:bold; color:#666;">Salmo</label>
                        <textarea id="rps" class="form-control"></textarea>
                        <label style="font-size:0.8rem; font-weight:bold; color:#666;">II Lettura</label>
                        <textarea id="r2" class="form-control"></textarea>
                        <label style="font-size:0.8rem; font-weight:bold; color:#666;">Vangelo</label>
                        <textarea id="rg" class="form-control" style="height:150px;"></textarea>
                    </div>
                </div>
            </div>
        </div>

        <div id="view-history" class="view-section">
            <h2 style="color:var(--primary); margin-top:0;">Le mie Messe</h2>
            <div id="fullHistoryList" class="card" style="border:none; background:transparent; box-shadow:none;"></div>
        </div>

        <div id="view-settings" class="view-section">
            <div class="card">
                <div class="card-header">Google Drive API</div>
                <div class="card-body">
                    <p style="font-size:0.85rem; color:#666;">Necessarie per Backup e PDF.</p>
                    <input type="text" id="apiKey" class="form-control" placeholder="API Key">
                    <input type="text" id="clientId" class="form-control" placeholder="Client ID">
                    <button onclick="saveKeys()" class="btn-primary">Salva Chiavi</button>
                </div>
            </div>
            <div class="card">
                <div class="card-header">Backup Locale</div>
                <div class="card-body" style="display:flex; gap:10px;">
                    <button onclick="exportData()" class="btn-outline" style="flex:1;">Scarica File</button>
                    <button onclick="document.getElementById('impFile').click()" class="btn-outline" style="flex:1;">Carica File</button>
                    <input type="file" id="impFile" hidden onchange="importData(this)">
                </div>
            </div>
        </div>

    </div>

    <div class="nav-bar no-print">
        <button class="nav-btn active" onclick="go('library', this)"><span class="material-icons-round">library_music</span>Canti</button>
        <button class="nav-btn" onclick="go('scaletta', this)"><span class="material-icons-round">playlist_play</span>Messa</button>
        <button class="nav-btn" onclick="go('history', this)"><span class="material-icons-round">history</span>Messe</button>
        <button class="nav-btn" onclick="go('settings', this)"><span class="material-icons-round">settings</span>Opzioni</button>
    </div>

    <div id="viewModal" class="modal-wrap">
        <div class="modal-box" style="height:95vh; width:95vw; max-width:900px;">
            <div class="card-header">
                <span id="viewTitle">Titolo</span>
                <div>
                    <button onclick="editFromView()" class="btn-icon"><span class="material-icons-round">edit</span></button>
                    <button onclick="document.getElementById('viewModal').classList.remove('show')" class="btn-icon" style="color:red;"><span class="material-icons-round">close</span></button>
                </div>
            </div>
            <div class="modal-scroll" id="viewBody" style="background:#eee; padding:0;"></div>
        </div>
    </div>

    <div id="editModal" class="modal-wrap">
        <div class="modal-box">
            <div class="card-header">
                <span id="editModalTitle">Nuovo Canto</span>
                <button onclick="document.getElementById('editModal').classList.remove('show')" class="btn-icon">√ó</button>
            </div>
            <div class="modal-scroll">
                <input type="hidden" id="songId">
                <label>Titolo</label><input type="text" id="songTitle" class="form-control">
                
                <label>Parti della Messa (Seleziona pi√π opzioni)</label>
                <div class="chips-container" id="catChips"></div>
                
                <label>Tempo Liturgico</label>
                <div class="chips-container" id="seasonChips"></div>
                
                <div style="background:#f0f2f5; padding:15px; border-radius:8px; text-align:center; margin-bottom:15px;">
                    <p id="fileStatus" style="font-weight:bold; color:var(--primary); margin-top:0;">Nessun file</p>
                    <div style="display:flex; gap:10px; justify-content:center;">
                        <button onclick="initDrive('picker')" class="btn-outline" style="background:white;">Google Drive</button>
                        <button onclick="document.getElementById('localFile').click()" class="btn-outline" style="background:white;">Locale</button>
                    </div>
                    <input type="file" id="localFile" hidden onchange="handleFile(this)">
                </div>

                <label>Testo (Opzionale)</label>
                <textarea id="songLyrics" class="form-control"></textarea>
            </div>
            <div class="modal-footer">
                <button onclick="saveSong()" class="btn-primary" style="width:100%;">SALVA</button>
            </div>
        </div>
    </div>

    <div id="syncModal" class="modal-wrap">
        <div class="modal-box" style="height:auto;">
            <div class="card-header"><span>Cloud Backup</span><button onclick="document.getElementById('syncModal').classList.remove('show')" class="btn-icon">√ó</button></div>
            <div class="modal-scroll" style="text-align:center;">
                <p>Salva tutti i tuoi dati su Google Drive per non perderli o sincronizzarli tra dispositivi.</p>
                <div style="display:grid; gap:10px;">
                    <button onclick="performUpload()" class="btn-primary" style="background:#1976d2;">‚òÅÔ∏è CARICA SU CLOUD (Backup)</button>
                    <button onclick="performDownload()" class="btn-outline" style="border-color:#1976d2; color:#1976d2;">‚¨áÔ∏è SCARICA DA CLOUD (Ripristina)</button>
                </div>
                <p id="syncStatus" style="font-size:0.8rem; margin-top:15px; color:#666;"></p>
            </div>
        </div>
    </div>

    <div id="readingContainer">
        <div class="reading-nav">
            <button onclick="stopReadingMode()" class="btn-icon" style="color:red; font-weight:bold;">‚Üê ESCI</button>
            <div style="display:flex; gap:10px;">
                <button onclick="setReadTab('music')" class="btn-outline" id="rtab-music" style="background:var(--primary); color:white;">Canti</button>
                <button onclick="setReadTab('word')" class="btn-outline" id="rtab-word">Letture</button>
            </div>
            <div style="width:40px;"></div>
        </div>
        <div class="reading-content">
            <div id="readMusicArea"></div>
            <div id="readWordArea" class="d-none" style="max-width:800px; margin:0 auto; font-size:1.2rem; line-height:1.6;"></div>
        </div>
    </div>

    <script>
        // CONFIG
        let db; let tempFile = null; let currentSongId = null;
        const CATS = ["Ingresso", "Gloria", "Salmo", "Alleluia", "Offertorio", "Santo", "Comunione", "Finale", "Altro"];
        const SEASONS = ["Ordinario", "Avvento", "Natale", "Quaresima", "Pasqua"];
        const SYNC_FILE_NAME = "spartiti_db_master.json";
        let filterCatVar = 'Tutti';

        window.onload = () => {
            document.getElementById('messaDate').valueAsDate = new Date();
            document.getElementById('apiKey').value = localStorage.getItem('g_api')||"";
            document.getElementById('clientId').value = localStorage.getItem('g_client')||"";

            const r = indexedDB.open("SpartitiDB_V4", 1);
            r.onupgradeneeded = (e) => {
                db = e.target.result;
                if(!db.objectStoreNames.contains("songs")) db.createObjectStore("songs", {keyPath:"id", autoIncrement:true});
                if(!db.objectStoreNames.contains("setlists")) db.createObjectStore("setlists", {keyPath:"id", autoIncrement:true});
            };
            r.onsuccess = (e) => { db=e.target.result; renderLibrary(); renderScalettaUI(); renderFullHistory(); };
            renderModalChips();
        };

        function renderModalChips() {
            document.getElementById('catChips').innerHTML = CATS.map(c => `<div class="chip-select" onclick="toggleChip(this)" data-val="${c}">${c}</div>`).join('');
            document.getElementById('seasonChips').innerHTML = SEASONS.map(s => `<div class="chip-select" onclick="toggleChip(this)" data-val="${s}">${s}</div>`).join('');
        }
        function toggleChip(el) { el.classList.toggle('selected'); }

        // NAV
        function go(id, btn) {
            document.querySelectorAll('.view-section').forEach(x=>x.classList.remove('active'));
            document.getElementById('view-'+id).classList.add('active');
            document.querySelectorAll('.nav-btn').forEach(x=>x.classList.remove('active'));
            if(btn) btn.classList.add('active');
            if(id==='library') renderLibrary();
            if(id==='history') renderFullHistory();
        }

        // LIBRARY
        function filterLib(cat) { filterCatVar=cat; renderLibrary(); }
        function renderLibrary() {
            const list = document.getElementById('songList'); list.innerHTML="";
            const txt = document.getElementById('searchInput').value.toLowerCase();
            const tx = db.transaction("songs","readonly");
            tx.objectStore("songs").openCursor().onsuccess = (e) => {
                const c = e.target.result;
                if(c) {
                    const s = c.value;
                    const cats = Array.isArray(s.categories) ? s.categories : [s.category];
                    let ok = true;
                    if(filterCatVar!=='Tutti' && !cats.includes(filterCatVar)) ok=false;
                    if(txt && !s.title.toLowerCase().includes(txt)) ok=false;
                    if(ok) {
                        const icon = s.type && s.type.includes('pdf') ? 'picture_as_pdf' : 'description';
                        list.innerHTML += `<div class="song-item" onclick="openViewModal(${s.id})"><div><div style="font-weight:bold;">${s.title}</div><small style="color:#666;">${cats.join(', ')}</small></div><span class="material-icons-round" style="color:#ccc;">${icon}</span></div>`;
                    }
                    c.continue();
                }
            }
        }

        // VIEW & EDIT
        function openViewModal(id) {
            currentSongId = id;
            db.transaction("songs").objectStore("songs").get(id).onsuccess = (e) => {
                const s = e.target.result;
                document.getElementById('viewTitle').innerText = s.title;
                const b = document.getElementById('viewBody');
                if(s.lyrics) b.innerHTML = `<pre style="padding:20px; white-space:pre-wrap; font-size:1.1rem; font-family:inherit;">${s.lyrics}</pre>`;
                else if(s.fileData) {
                    if(s.type.includes('pdf')) b.innerHTML = `<iframe src="${s.fileData}" style="width:100%; height:100%; border:none;"></iframe>`;
                    else b.innerHTML = `<img src="${s.fileData}" style="width:100%; height:auto;">`;
                } else b.innerHTML = `<p style="text-align:center; padding:50px;">Nessun contenuto visualizzabile.</p>`;
                document.getElementById('viewModal').classList.add('show');
            }
        }
        function editFromView() { document.getElementById('viewModal').classList.remove('show'); openEditModal(currentSongId); }

        function openEditModal(id=null) {
            document.getElementById('editModal').classList.add('show');
            document.getElementById('songId').value = "";
            document.getElementById('songTitle').value = "";
            document.getElementById('songLyrics').value = "";
            document.getElementById('fileStatus').innerText = "Nessun file";
            tempFile = null;
            document.querySelectorAll('.chip-select').forEach(c => c.classList.remove('selected'));
            document.getElementById('editModalTitle').innerText = "Nuovo Canto";

            if(id) {
                document.getElementById('editModalTitle').innerText = "Modifica Canto";
                document.getElementById('songId').value = id;
                db.transaction("songs").objectStore("songs").get(id).onsuccess = (e) => {
                    const s = e.target.result;
                    document.getElementById('songTitle').value = s.title;
                    document.getElementById('songLyrics').value = s.lyrics || "";
                    if(s.fileData) { tempFile = {data:s.fileData, type:s.type}; document.getElementById('fileStatus').innerText = "File Presente ‚úÖ"; }
                    
                    const cats = Array.isArray(s.categories) ? s.categories : [s.category];
                    const seas = Array.isArray(s.seasons) ? s.seasons : [s.season];
                    
                    document.querySelectorAll('#catChips .chip-select').forEach(c => { if(cats.includes(c.dataset.val)) c.classList.add('selected'); });
                    document.querySelectorAll('#seasonChips .chip-select').forEach(c => { if(seas.includes(c.dataset.val)) c.classList.add('selected'); });
                }
            }
        }

        function handleFile(input) {
            const f = input.files[0];
            const r = new FileReader();
            r.onload = (e) => { tempFile={data:e.target.result, type:f.type}; document.getElementById('fileStatus').innerText="File Locale OK"; };
            r.readAsDataURL(f);
        }

        function saveSong() {
            const t = document.getElementById('songTitle').value;
            if(!t) return alert("Titolo mancante");
            
            const cats = Array.from(document.querySelectorAll('#catChips .selected')).map(c => c.dataset.val);
            const seas = Array.from(document.querySelectorAll('#seasonChips .selected')).map(c => c.dataset.val);
            if(cats.length === 0) cats.push("Altro");
            if(seas.length === 0) seas.push("Ordinario");

            const s = {
                title: t, categories: cats, seasons: seas, lyrics: document.getElementById('songLyrics').value,
                fileData: tempFile ? tempFile.data : null, type: tempFile ? tempFile.type : null
            };
            const id = document.getElementById('songId').value;
            if(id) s.id = Number(id);

            const tx = db.transaction("songs","readwrite");
            tx.objectStore("songs").put(s).onsuccess = () => {
                document.getElementById('editModal').classList.remove('show');
                renderLibrary();
                updateSuggestions();
                showToast("Salvato!");
            };
        }

        // SCALETTA & SMART SUGGESTIONS
        function renderScalettaUI() {
            const c = document.getElementById('scalettaContainer'); c.innerHTML = "";
            CATS.forEach(cat => {
                if(cat === 'Altro') return;
                c.innerHTML += `
                <div style="margin-bottom:10px;" data-part="${cat}">
                    <label style="font-size:0.8rem; font-weight:bold; color:#666;">${cat}</label>
                    <div style="display:flex; gap:5px;">
                        <select class="form-control song-select" style="margin:0;"><option value="">Seleziona...</option></select>
                        <button onclick="this.previousElementSibling.value=''" class="btn-outline">X</button>
                    </div>
                </div>`;
            });
            setTimeout(updateSuggestions, 500);
        }

        function updateSuggestions() {
            const d = new Date(document.getElementById('messaDate').value);
            const month = d.getMonth() + 1; const day = d.getDate();
            let season = "Ordinario";
            if (month === 11 && day >= 27 || month === 12 && day <= 24) season = "Avvento";
            else if (month === 12 && day >= 25 || month === 1) season = "Natale";
            else if (month >= 2 && month <= 4) season = "Quaresima";
            else if (month === 4 || month === 5) season = "Pasqua";

            db.transaction("songs").objectStore("songs").getAll().onsuccess = (e) => {
                const songs = e.target.result.sort((a,b)=>a.title.localeCompare(b.title));
                document.querySelectorAll('.song-select').forEach(sel => {
                    const part = sel.parentElement.parentElement.dataset.part;
                    const oldVal = sel.value;
                    let suggested = "", others = "";
                    songs.forEach(s => {
                        const cats = Array.isArray(s.categories) ? s.categories : [s.category];
                        const seas = Array.isArray(s.seasons) ? s.seasons : [s.season];
                        if(cats.includes(part) && (seas.includes(season) || seas.includes("Tutti"))) suggested += `<option value="${s.id}">‚òÖ ${s.title}</option>`;
                        else others += `<option value="${s.id}">${s.title}</option>`;
                    });
                    sel.innerHTML = `<option value="">Seleziona...</option><optgroup label="Suggeriti (${season})">${suggested}</optgroup><optgroup label="Altri">${others}</optgroup>`;
                    sel.value = oldVal;
                });
            }
        }

        // LETTURE
        async function autoFetchReadings() {
            const dStr = document.getElementById('messaDate').value;
            if(!dStr) return alert("Inserisci la data!");
            showToast("Ricerca...", 3000);
            const d = new Date(dStr);
            const url = `https://api.allorigins.win/get?url=${encodeURIComponent(`https://www.lachiesa.it/calendario/Detailed/${d.getFullYear()}${String(d.getMonth()+1).padStart(2,'0')}${String(d.getDate()).padStart(2,'0')}.shtml`)}`;
            try {
                const res = await fetch(url);
                const json = await res.json();
                if(!json.contents) throw new Error("Empty");
                const parser = new DOMParser();
                const doc = parser.parseFromString(json.contents, "text/html");
                const text = doc.body.innerText.replace(/\s+/g, ' '); 
                const findText = (startWords, endWords) => {
                    let startIdx = -1;
                    for (let w of startWords) { const regex = new RegExp(w, "i"); const match = text.match(regex); if(match) { startIdx = match.index + match[0].length; break; } }
                    if(startIdx === -1) return "";
                    let endIdx = -1;
                    for (let w of endWords) { const regex = new RegExp(w, "i"); const sub = text.substring(startIdx); const match = sub.match(regex); if(match) { endIdx = startIdx + match.index; break; } }
                    return endIdx === -1 ? "" : text.substring(startIdx, endIdx).trim();
                };
                document.getElementById('r1').value = findText(["Prima Lettura", "Dagli Atti"], ["Salmo Responsoriale"]).substring(0,2000);
                document.getElementById('rps').value = findText(["Salmo Responsoriale"], ["Seconda Lettura", "Vangelo", "Canto al Vangelo"]).substring(0,2000);
                document.getElementById('r2').value = findText(["Seconda Lettura"], ["Vangelo", "Canto al Vangelo"]).substring(0,2000);
                document.getElementById('rg').value = findText(["Vangelo"], ["PREGHIERA DEI FEDELI", "Sulle Offerte"]).substring(0,3500);
                showToast("Letture Trovate!");
            } catch(e) { if(confirm("Errore scaricamento. Aprire il sito?")) window.open(`https://www.lachiesa.it/calendario/Detailed/${d.getFullYear()}${String(d.getMonth()+1).padStart(2,'0')}${String(d.getDate()).padStart(2,'0')}.shtml`); }
        }
        function clearReadings() { ['r1','rps','r2','rg'].forEach(i => document.getElementById(i).value = ""); }

        // READING MODE
        function startReadingMode() {
            document.getElementById('readingContainer').classList.add('active');
            const mc = document.getElementById('readMusicArea'); mc.innerHTML = "";
            const wc = document.getElementById('readWordArea'); wc.innerHTML = "";
            document.querySelectorAll('.song-select').forEach(sel => {
                if(sel.value) db.transaction("songs").objectStore("songs").get(Number(sel.value)).onsuccess = (e) => {
                    const s = e.target.result;
                    let h = s.lyrics ? `<pre style="white-space:pre-wrap; font-size:1.1rem; font-family:inherit;">${s.lyrics}</pre>` : (s.type.includes('pdf') ? `<iframe src="${s.fileData}" class="pdf-frame"></iframe>` : `<img src="${s.fileData}" style="width:100%">`);
                    mc.innerHTML += `<div class="score-seq-item"><h3 style="color:var(--primary); margin:0 0 10px 0; border-bottom:1px solid #eee; padding-bottom:5px;">${s.title}</h3>${h}</div>`;
                };
            });
            const reads = [{t:"Prima Lettura", v:document.getElementById('r1').value},{t:"Salmo", v:document.getElementById('rps').value},{t:"Seconda Lettura", v:document.getElementById('r2').value},{t:"Vangelo", v:document.getElementById('rg').value}];
            reads.forEach(r => { if(r.v) wc.innerHTML += `<div style="margin-bottom:30px;"><h3 style="color:#d32f2f; border-bottom:1px solid #ddd;">${r.t}</h3><p style="white-space:pre-wrap;">${r.v}</p></div>`; });
        }
        function stopReadingMode() { document.getElementById('readingContainer').classList.remove('active'); }
        function setReadTab(t) { document.getElementById('readMusicArea').className=t==='music'?'':'d-none'; document.getElementById('readWordArea').className=t==='word'?'':'d-none'; document.getElementById('rtab-music').style.background=t==='music'?'var(--primary)':'white'; document.getElementById('rtab-music').style.color=t==='music'?'white':'#555'; document.getElementById('rtab-word').style.background=t==='word'?'var(--primary)':'white'; document.getElementById('rtab-word').style.color=t==='word'?'white':'#555'; }

        // SAVE & HISTORY
        function saveSetlist() {
            const t = document.getElementById('messaTitle').value;
            const d = document.getElementById('messaDate').value;
            const sel = {};
            document.querySelectorAll('.song-select').forEach(s => { if(s.value) sel[s.parentElement.parentElement.dataset.part] = s.value; });
            const r = { r1:document.getElementById('r1').value, rps:document.getElementById('rps').value, r2:document.getElementById('r2').value, rg:document.getElementById('rg').value };
            db.transaction("setlists","readwrite").objectStore("setlists").add({title:t, date:d, songs:sel, readings:r}).onsuccess = () => { showToast("Messa Salvata!"); renderFullHistory(); };
        }
        function renderFullHistory() {
            const list = document.getElementById('fullHistoryList'); list.innerHTML = "";
            db.transaction("setlists").objectStore("setlists").openCursor(null,'prev').onsuccess = (e) => {
                const c = e.target.result;
                if(c) {
                    const s = c.value;
                    list.innerHTML += `<div class="history-item"><div onclick="loadSet(${s.id})" style="flex:1;"><b>${s.title}</b><br><small style="color:#666;">${s.date}</small></div><button onclick="delSet(${s.id})" class="btn-icon" style="color:red;">delete</button></div>`;
                    c.continue();
                }
            }
        }
        function loadSet(id) {
            db.transaction("setlists").objectStore("setlists").get(id).onsuccess = (e) => {
                const s = e.target.result;
                document.getElementById('messaTitle').value = s.title; document.getElementById('messaDate').value = s.date;
                if(s.readings) { document.getElementById('r1').value=s.readings.r1||""; document.getElementById('rps').value=s.readings.rps||""; document.getElementById('r2').value=s.readings.r2||""; document.getElementById('rg').value=s.readings.rg||""; }
                document.querySelectorAll('.song-select').forEach(sel => sel.value = "");
                for(let [k,v] of Object.entries(s.songs)) { const el = document.querySelector(`div[data-part="${k}"] select`); if(el) el.value = v; }
                go('scaletta');
            }
        }
        function delSet(id) { if(confirm("Eliminare?")) db.transaction("setlists","readwrite").objectStore("setlists").delete(id).onsuccess = () => renderFullHistory(); }

        // GOOGLE API & SYNC
        let tokenClient; let gapiInited=false; let gisInited=false;
        function saveKeys(){localStorage.setItem('g_api',document.getElementById('apiKey').value);localStorage.setItem('g_client',document.getElementById('clientId').value);showToast("Keys OK");}
        async function initDrive(mode) {
            const k = document.getElementById('apiKey').value; const c = document.getElementById('clientId').value;
            if(!k||!c) return alert("Inserisci API Key e Client ID in Opzioni");
            document.getElementById('editModal').classList.remove('show');
            if(!gapiInited) await new Promise(r=>gapi.load('client:picker',async()=>{await gapi.client.init({apiKey:k,discoveryDocs:["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"]});gapiInited=true;r()}));
            if(!gisInited) await new Promise(r=>{tokenClient=google.accounts.oauth2.initTokenClient({client_id:c,scope:mode==='picker'?'https://www.googleapis.com/auth/drive.readonly':'https://www.googleapis.com/auth/drive.file',callback:''});gisInited=true;r()});
            tokenClient.callback = (r) => {
                if(r.error) { alert("Err Auth"); if(mode==='picker') document.getElementById('editModal').classList.add('show'); return; }
                if(mode==='picker') createPicker(r.access_token);
                else { if(mode==='upload') performUpload(); if(mode==='download') performDownload(); }
            };
            tokenClient.requestAccessToken({prompt:''});
        }
        function openSyncModal() { document.getElementById('syncModal').classList.add('show'); }
        function createPicker(t) {
            const k = document.getElementById('apiKey').value;
            const view = new google.picker.DocsView(google.picker.ViewId.DOCS).setIncludeFolders(true).setMimeTypes("application/pdf,image/png,image/jpeg");
            new google.picker.PickerBuilder().setDeveloperKey(k).setOAuthToken(t).addView(view).setCallback(pickerCallback).build().setVisible(true);
        }
        async function pickerCallback(d) {
            if(d.action === google.picker.Action.CANCEL) document.getElementById('editModal').classList.add('show');
            if(d.action === google.picker.Action.PICKED) {
                const doc = d.docs[0];
                document.getElementById('songTitle').value = doc.name.replace(/\.[^/.]+$/, "");
                try {
                    const t = gapi.client.getToken().access_token;
                    const r = await fetch(`https://www.googleapis.com/drive/v3/files/${doc.id}?alt=media`,{headers:{'Authorization':`Bearer ${t}`}});
                    const b = await r.blob();
                    const fr = new FileReader();
                    fr.onload = (e) => { tempFile={data:e.target.result, type:doc.mimeType}; document.getElementById('fileStatus').innerText="Drive OK ‚úÖ"; document.getElementById('editModal').classList.add('show'); };
                    fr.readAsDataURL(b);
                } catch(e) { alert("Err Download"); document.getElementById('editModal').classList.add('show'); }
            }
        }
        async function performUpload() {
            document.getElementById('syncStatus').innerText = "Caricamento...";
            const exp={songs:[],setlists:[]};
            const tx=db.transaction(["songs","setlists"],"readonly");
            exp.songs = await new Promise(r=>tx.objectStore("songs").getAll().onsuccess=e=>r(e.target.result));
            exp.setlists = await new Promise(r=>tx.objectStore("setlists").getAll().onsuccess=e=>r(e.target.result));
            const fileContent = JSON.stringify(exp);
            const metadata = { name: SYNC_FILE_NAME, mimeType: 'application/json' };
            const form = new FormData();
            form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
            form.append('file', new Blob([fileContent], { type: 'application/json' }));
            try {
                const q = `name = '${SYNC_FILE_NAME}' and trashed = false`;
                const search = await gapi.client.drive.files.list({q:q, fields:'files(id)'});
                if(search.result.files.length > 0) {
                    await fetch(`https://www.googleapis.com/upload/drive/v3/files/${search.result.files[0].id}?uploadType=media`, {
                        method: 'PATCH',
                        headers: { 'Authorization': `Bearer ${gapi.client.getToken().access_token}`, 'Content-Type': 'application/json' },
                        body: fileContent
                    });
                } else {
                    await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${gapi.client.getToken().access_token}` },
                        body: form
                    });
                }
                document.getElementById('syncStatus').innerText = "Fatto! ‚úÖ"; showToast("Backup OK!");
            } catch(e) { document.getElementById('syncStatus').innerText = "Errore ‚ùå"; alert("Errore sync"); }
        }
        async function performDownload() {
            document.getElementById('syncStatus').innerText = "Scaricamento...";
            try {
                const q = `name = '${SYNC_FILE_NAME}' and trashed = false`;
                const search = await gapi.client.drive.files.list({q:q, fields:'files(id)'});
                if(search.result.files.length === 0) { alert("Nessun backup."); return; }
                const res = await gapi.client.drive.files.get({fileId: search.result.files[0].id, alt: 'media'});
                const data = res.result;
                const tx = db.transaction(["songs","setlists"],"readwrite");
                await new Promise(r=>tx.objectStore("songs").clear().onsuccess=r);
                await new Promise(r=>tx.objectStore("setlists").clear().onsuccess=r);
                data.songs.forEach(s=>tx.objectStore("songs").put(s));
                data.setlists.forEach(s=>tx.objectStore("setlists").put(s));
                tx.oncomplete = () => { document.getElementById('syncStatus').innerText = "Fatto! ‚úÖ"; showToast("Ripristinato!"); location.reload(); };
            } catch(e) { document.getElementById('syncStatus').innerText = "Errore ‚ùå"; alert("Errore download"); }
        }

        function showToast(m,time=3000){ const t=document.getElementById('toast');t.innerText=m;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),time); }
        function exportData(){} function importData(){} 
    </script>
</body>
</html>
